<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="fr"
  lang="fr" dir="ltr" class="no-js">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>utilisateurs:draco31.fr:brouillon [Wiki ubuntu-fr]</title>
  <script>(function(H){H.className=H.className.replace(/\bno-js\b/,'js')})(document.documentElement)</script>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="shortcut icon" href="/_media/favicon.ico" />
<link rel="apple-touch-icon" href="/lib/tpl/bootstrap3/images/apple-touch-icon.png" />
    <meta name="generator" content="DokuWiki"/>
<meta name="robots" content="index,follow"/>
<meta name="keywords" content="utilisateurs,draco31.fr,brouillon"/>
<link type="text/css" rel="stylesheet" href="/lib/tpl/bootstrap3/assets/fonts/united.fonts.css"/>
<link type="text/css" rel="stylesheet" href="/lib/tpl/bootstrap3/assets/font-awesome/css/font-awesome.min.css"/>
<link type="text/css" rel="stylesheet" href="/lib/tpl/bootstrap3/assets/bootstrap/united/bootstrap.min.css"/>
<link rel="search" type="application/opensearchdescription+xml" href="/lib/exe/opensearch.php" title="Wiki ubuntu-fr"/>
<link rel="start" href="/"/>
<link rel="contents" href="/utilisateurs/draco31.fr/brouillon?do=index" title="Plan du site"/>
<link rel="manifest" href="/lib/exe/manifest.php"/>
<link rel="alternate" type="application/rss+xml" title="Derniers changements" href="/feed.php"/>
<link rel="alternate" type="application/rss+xml" title="Catégorie courante" href="/feed.php?mode=list&amp;ns=utilisateurs:draco31.fr"/>
<link rel="alternate" type="text/html" title="HTML brut" href="/_export/xhtml/utilisateurs/draco31.fr/brouillon"/>
<link rel="alternate" type="text/plain" title="Wiki balise" href="/_export/raw/utilisateurs/draco31.fr/brouillon"/>
<link rel="canonical" href="http://doc.ubuntu-fr.org/utilisateurs/draco31.fr/brouillon"/>
<link rel="stylesheet" type="text/css" href="/lib/exe/css.php?t=bootstrap3&amp;tseed=b4a19b95bb4d08daf02b6dd52d7e6abc"/>
<!--[if gte IE 9]><!-->
<script type="text/javascript">/*<![CDATA[*/var NS='utilisateurs:draco31.fr';var JSINFO = {"bootstrap3":{"mode":"show","toc":[],"config":{"collapsibleSections":0,"fixedTopNavbar":1,"showSemanticPopup":0,"sidebarOnNavbar":0,"tagsOnTop":1,"tocAffix":1,"tocCollapseOnScroll":1,"tocCollapsed":0,"tocLayout":"default","useAnchorJS":1}},"id":"utilisateurs:draco31.fr:brouillon","namespace":"utilisateurs:draco31.fr","ACT":"show","useHeadingNavigation":0,"useHeadingContent":0};
/*!]]>*/</script>
<script type="text/javascript" charset="utf-8" src="/lib/exe/jquery.php?tseed=23f888679b4f1dc26eef34902aca964f"></script>
<script type="text/javascript" charset="utf-8" src="/lib/exe/js.php?t=bootstrap3&amp;tseed=b4a19b95bb4d08daf02b6dd52d7e6abc"></script>
<script type="text/javascript" src="/lib/tpl/bootstrap3/assets/bootstrap/js/bootstrap.min.js"></script>
<script type="text/javascript" src="/lib/tpl/bootstrap3/assets/anchorjs/anchor.min.js"></script>
<script type="text/javascript" src="/lib/tpl/bootstrap3/assets/typeahead/bootstrap3-typeahead.min.js"></script>
<!--<![endif]-->
<style type="text/css">@media screen { body { margin-top: 70px; }  #dw__toc.affix { top: 60px; position: fixed !important; }  #dw__toc .nav .nav .nav { display: none; } }</style>
    <!--[if lt IE 9]>
  <script type="text/javascript" src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
  <script type="text/javascript" src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
  <![endif]-->
</head>
<body class="united dokuwiki mode_show tpl_bootstrap3 dw-page-on-panel" data-page-id="utilisateurs:draco31.fr:brouillon">

  <header id="dokuwiki__header" class="dokuwiki container">
    <nav id="dw__navbar" class="navbar navbar-fixed-top navbar-default" role="navigation">

  <div class="container">

    <div class="navbar-header">

      <button class="navbar-toggle" type="button" data-toggle="collapse" data-target=".navbar-collapse">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>

      <a href="/accueil"  accesskey="h" title="[H]" class="navbar-brand"><span class="uf uf-cof" id="dw__accueil" style="font-size: 35px;" ></span> <span id="dw__title" style="margin-top:-5px">Wiki ubuntu-fr<span id="dw__tagline">La Documentation francophone</span></span></a>
    </div>

    <div class="collapse navbar-collapse">

      
      <ul class="nav navbar-nav">
        <li>
          <a href="//ubuntu-fr.org/" ><i class="fa fa-2x fa-fw fa-home"></i><span> Accueil</span></a>        </li>
        <li>
          <a href="//forum.ubuntu-fr.org/" ><i class="fa fa-2x fa-fw fa-comments"></i><span> Forum</span></a>        </li>
        <li>
          <a href="//planet.ubuntu-fr.org/" ><i class="fa fa-2x fa-fw fa-globe"></i><span> Planet</span></a>        </li>
      </ul>

            
      
      <div class="navbar-right" id="dw__navbar_items">

        <form action="//forum.ubuntu-fr.org/search_ubuntufr.php" accept-charset="utf-8" class="navbar-form navbar-left search" id="dw__search" method="get" role="search"><div class="no"><input id="qsearch" autocomplete="off" type="search" placeholder="Rechercher" accesskey="f" name="q" class="form-control" title="[F]" /><button type="submit" title="Rechercher"><i class="fa fa-fw fa-search"></i></button><input type="hidden" name="do" value="search" /><input type="hidden" name="tsearch" value="wiki" /></div></form>
        
<ul class="nav navbar-nav dw-action-icon" id="dw__tools">


  <li class="dropdown">

    <a href="" class="dropdown-toggle" data-target="#" data-toggle="dropdown" title="" role="button" aria-haspopup="true" aria-expanded="false">
      <i class="fa fa-2x fa-fw fa-wrench"></i> <span class="hidden-lg hidden-md hidden-sm">Outils</span> <span class="caret"></span>
    </a>

    <ul class="dropdown-menu tools" role="menu">
    
      <li class="dropdown-header">
        <i class="fa fa-fw fa-cubes"></i> Outils du site      </li>
      <li><a href="/utilisateurs/draco31.fr/brouillon?do=recent"  class="action recent" accesskey="r" rel="nofollow" title="Derniers changements [R]">Derniers changements</a></li><li><a href="/utilisateurs/draco31.fr/brouillon?do=media&amp;ns=utilisateurs%3Adraco31.fr"  class="action media" rel="nofollow" title="Gestionnaire Multimédia">Gestionnaire Multimédia</a></li><li><a href="/utilisateurs/draco31.fr/brouillon?do=index"  class="action index" accesskey="x" rel="nofollow" title="Plan du site [X]">Plan du site</a></li>
            <li class="divider" role="separator"></li>
      
    
      <li class="dropdown-header">
        <i class="fa fa-fw fa-file"></i> Outils de la page      </li>
      <li><a href="/utilisateurs/draco31.fr/brouillon?do=edit"  class="action source" accesskey="v" rel="nofollow" title="Afficher le texte source [V]">Modifier cette page</a></li><li><a href="/utilisateurs/draco31.fr/brouillon?do=revisions"  class="action revs" accesskey="o" rel="nofollow" title="Anciennes révisions [O]">Anciennes révisions</a></li><li><a href="/utilisateurs/draco31.fr/brouillon?do=backlink"  class="action backlink" rel="nofollow" title="Liens de retour">Liens de retour</a></li><li><a href="#dokuwiki__top"  class="action top" accesskey="t" rel="nofollow" title="Haut de page [T]">Haut de page</a></li>
      
        </ul>
  </li>


</ul>


        <ul class="nav navbar-nav">

          
          
                    <li>
            <span class="dw__actions dw-action-icon">
              <a href="/utilisateurs/draco31.fr/brouillon?do=login&amp;sectok="  class="action btn btn-default navbar-btn login" rel="nofollow" title="S&#039;identifier"><span class="">S'identifier</span></a>            </span>
          </li>
          
        </ul>

        
        

      </div>

    </div>
  </div>
</nav>
  </header>

  <div id="dokuwiki__top" class="dokuwiki container">

    <div id="dokuwiki__pageheader">

      
      
      <p class="pageId text-right small">
        <span class="label label-primary">utilisateurs:draco31.fr:brouillon</span>      </p>

      <div id="dw__msgarea" class="small">
              </div>

    </div>

    <main class="main row" role="main">

      
      <article id="dokuwiki__content" class="container" itemscope itemtype="http://schema.org/Article" itemref="dw__license">

        
<nav id="dw__pagetools" class="hidden-print">
  <div class="tools panel panel-default pull-right ">
    <ul class="nav nav-stacked nav-pills">
      <li><a href="/utilisateurs/draco31.fr/brouillon?do=edit"  class="action text-muted source" accesskey="v" rel="nofollow" title="Afficher le texte source [V]"><i class="fa fa-fw fa-pencil-square-o"></i><span class="sr-only"> Modifier cette page</span></a></li><li><a href="/utilisateurs/draco31.fr/brouillon?do=revisions"  class="action text-muted revs" accesskey="o" rel="nofollow" title="Anciennes révisions [O]"><i class="fa fa-fw fa-clock-o"></i><span class="sr-only"> </span></a></li><li><a href="/utilisateurs/draco31.fr/brouillon?do=backlink"  class="action text-muted backlink" rel="nofollow" title="Liens de retour"><i class="fa fa-fw fa-link"></i><span class="sr-only"> Liens de retour</span></a></li>    </ul>
  </div>
</nav>

        <div class="panel panel-default" itemprop="articleBody">
          <div class="page panel-body">

            <div class="dw-content-page "><div class="dw-toc hidden-print"></div><!-- CONTENT --><div class="dw-content">
<h1 class="sectionedit1 page-header" id="☆_ceci_est_ma_page_brouillon_☆">∴☆★ Ceci est ma page BROUILLON !! ★☆∴</h1>
<div class="level1">

</div>

<h2 class="sectionedit2 page-header" id="nut_upsmon_upssched">NUT &amp; upsmon &amp; upssched</h2>
<div class="level2">

</div>

<h3 class="sectionedit3" id="monitorer_les_evenements_de_l_ups_avec_upsmon">Monitorer les événements de l&#039;UPS avec upsmon</h3>
<div class="level3">

</div>

<h4 id="configuration_par_defaut">Configuration par défaut</h4>
<div class="level4">

<p>
Par défaut, toutes les types d’événements sont associés aux directives <strong>SYSLOG</strong> (écriture dans <code>/var/log/syslog</code>) et <strong>WALL</strong> (notification aux utilisateurs par les terminaux).
</p>
<div class="notewarning"><img src="/lib/images/smileys/fixme.gif" class="icon" alt="FIXME" /> Sous Ubuntu, la notification par la commande <strong><code>wall</code></strong> ne semble pas fonctionner !
</div>
<p>
Le fichier <strong><code>/etc/nut/upsmon</code></strong> contient donc les lignes suivantes :
</p>
<pre class="file">NOTIFYFLAG ONLINE    SYSLOG+WALL
NOTIFYFLAG ONBATT    SYSLOG+WALL
NOTIFYFLAG LOWBATT   SYSLOG+WALL
NOTIFYFLAG FSD       SYSLOG+WALL
NOTIFYFLAG COMMOK    SYSLOG+WALL
NOTIFYFLAG COMMBAD   SYSLOG+WALL
NOTIFYFLAG SHUTDOWN  SYSLOG+WALL
NOTIFYFLAG REPLBATT  SYSLOG+WALL
NOTIFYFLAG NOCOMM    SYSLOG+WALL
NOTIFYFLAG NOPARENT  SYSLOG+WALL</pre>

<p>
Dans <strong><code>/var/log/syslog</code></strong>, on obtient un message préformaté. Exemple :
</p>
<pre class="file">Aug 19 21:49:34 localhost upsmon[7784]: Startup successful
Aug 19 21:50:24 localhost upsmon[7786]: UPS localups@localhost on battery
Aug 19 21:50:34 localhost upsmon[7786]: Poll UPS [localups@localhost] failed - Data stale
Aug 19 21:50:34 localhost upsmon[7786]: Communications with UPS localups@localhost lost
Aug 19 21:50:39 localhost upsmon[7786]: Communications with UPS localups@localhost established
Aug 19 21:50:39 localhost upsmon[7786]: UPS localups@localhost on line power</pre>
<div class="noteclassic"><em>Dans l&#039;exemple ci-dessus <code>localups</code> est le libellé associé à l&#039;onduleur dans le fichier <strong><code>/etc/nut/ups.conf</code></strong></em>
</div>
</div>

<h4 id="utilisation_d_un_script_via_l_option_notifycmd_et_la_directive_exec">Utilisation d&#039;un script via l&#039;option NOTIFYCMD et la directive EXEC</h4>
<div class="level4">

<p>
Il est possible en plus ou la place des directives WALL et SYSLOG, d&#039;utiliser la directive <strong><code>EXEC</code></strong> pour lancer un script définit par l&#039;option <strong><code>NOTIFYCMD</code></strong> pour réaliser un traitement personnalisé.
</p>

<p>
Le fichier de configuration <strong><code>/etc/nut/upsmon.conf</code></strong> contiendra donc la ligne :
</p>
<pre class="file">NOTIFYCMD /usr/local/bin/upsalert.sh</pre>
<div class="notetip">Le chemin <code>/usr/local/bin/upsalert.sh</code> est à remplacer par celui votre script !
</div>
<p>
Les options NOTIFYFAG concernée par ce traitement personnalisée doivent avoir la directive EXEC. Exemple pour <code>ONLINE</code> et <code>ONBATT</code> et <code>LOWBATT</code> :
</p>
<pre class="file">NOTIFYFLAG ONLINE    SYSLOG+WALL+EXEC
NOTIFYFLAG ONBATT    SYSLOG+WALL+EXEC
NOTIFYFLAG LOWBATT   SYSLOG+WALL+EXEC
NOTIFYFLAG FSD       SYSLOG+WALL
NOTIFYFLAG COMMOK    SYSLOG+WALL
NOTIFYFLAG COMMBAD   SYSLOG+WALL
NOTIFYFLAG SHUTDOWN  SYSLOG+WALL
NOTIFYFLAG REPLBATT  SYSLOG+WALL
NOTIFYFLAG NOCOMM    SYSLOG+WALL
NOTIFYFLAG NOPARENT  SYSLOG+WALL</pre>

<p>
<img src="/lib/images/smileys/fixme.gif" class="icon" alt="FIXME" /> Le script reçoit en argument le même libellé que ce qui est tracé dans <code>/var/log/syslog</code>.
</p>

</div>

<h5 id="notification_par_mail">Notification par mail</h5>
<div class="level5">
<div class="notewarning">Votre modem ainsi que vos équipements réseaux reliant ce dernier au PC hébergeant upsmon serveur (relié à l&#039;onduleur) et upsmon client (celui exécutant le script) doivent aussi être alimentés pour pouvoir envoyer le mail au moment opportun. Dans le cas contraire, vous risquez de ne recevoir le mail que lorsque le courant revient, voir de ne pas recevoir le mail du tout !!
</div>
<p>
<strong> Choix d&#039;un MTA accessible en console </strong>
</p>

<p>
Plusieurs MTA (mail transfert agent) accessible en console sont disponibles dans les dépôts. Parmi ceux-ci on notera :
</p>
<ul class=" fix-media-list-overlap">
<li class="level1"><div class="li"> <a href="/ssmtp" class="wikilink1" title="ssmtp">ssmtp</a> : Très simple d&#039;utilisation</div>
</li>
<li class="level1"><div class="li"> <a href="/mutt" class="wikilink1" title="mutt">mutt</a> : plus évolué que <code>ssmtp</code> et ligne de commande plus complexe</div>
</li>
<li class="level1"><div class="li"> <a href="/postfix" class="wikilink1" title="postfix">postfix</a> : le plus puissant, mais aussi plus compliqué à configurer !</div>
</li>
</ul>

<p>
<strong> Installation et configuration avec SSMTP </strong>
</p>

<p>
Exemple avec <code>ssmtp</code> :
</p>
<ul class=" fix-media-list-overlap">
<li class="level1"><div class="li"> <a href="/tutoriel/comment_installer_un_paquet" class="wikilink1" title="tutoriel:comment_installer_un_paquet">Installer le paquet</a> <strong><a href="apt://ssmtp" class="interwiki iw_apt" title="apt://ssmtp">ssmtp</a></strong></div>
</li>
<li class="level1"><div class="li"> <a href="/tutoriel/comment_modifier_un_fichier" class="wikilink1" title="tutoriel:comment_modifier_un_fichier">Modifier le fichier</a> <strong><code>/etc/ssmtp/ssmtp.conf</code></strong> suivant l&#039;exemple ci-dessous :<pre class="file">root=mon-adresse-email@mon-fai.fr 25
mailhub=smtp.fai.fr
hostname=ubuntu-desktop
FromLineOverride=YES</pre>
</div>
</li>
<li class="level1"><div class="li"> Depuis un <a href="/terminal" class="wikilink1" title="terminal">terminal</a>, faites un essai avec la commande ci-dessous :<pre class="code">ssmtp &lt;mon-adresse-email@mon-fai.fr&gt;</pre>

<p>
entrez le texte suivant :
</p>
<pre class="code">From: mon-adresse-email@mon-fai.fr
Subject: Test envoi mail avec ssmtp
Test réussi ! Bravo !</pre>

<p>
et enfin, appuyez sur la combinaison CTRL+D pour terminer la saisie et envoyer le mail.
</p>
</div>
</li>
</ul>

<p>
<strong> Création du script de notification mail </strong>
</p>
<div class="noteclassic"> A METTRE EN FORME — Brouillon
</div>
<p>
Créer un fichier pour l&#039;entête avec une ligne From: ; To: ; Subject: : Ces données sont invariantes dans le message.
Créer le script contenant les lignes :
</p>
<pre class="code">#!/bin/bash
echo &quot;$@&quot; | cat &lt;/chemin/fichier/entête&gt; - | ssmtp &lt;mon-adresse-mail@mon-fai.fr&gt;</pre>

<p>
<img src="/lib/images/smileys/fixme.gif" class="icon" alt="FIXME" /> : Non testé : à vérifier si ça marche bien :p
</p>
<div class="noteclassic">Vous pouvez modifier le libellé par défaut associé à chaque événement dans le fichier upsmon.conf :
<pre class="file">NOTIFYMSG ONLINE	&quot;UPS %s sur secteur.&quot;
NOTIFYMSG ONBATT	&quot;UPS %s sur batterie.&quot;
NOTIFYMSG LOWBATT	&quot;UPS %s batterie faible.&quot;
NOTIFYMSG FSD		&quot;UPS %s: arrêt forcé en cours.&quot;
NOTIFYMSG COMMOK	&quot;Communications avec l&#039;UPS %s établie.&quot;
NOTIFYMSG COMMBAD	&quot;Communications avec l&#039;UPS %s perdue.&quot;
NOTIFYMSG SHUTDOWN	&quot;Déconnexion et arrêt automatiques engagés.&quot;
NOTIFYMSG REPLBATT	&quot;UPS %s La batterie doit être remplacée.&quot;
NOTIFYMSG NOCOMM	&quot;UPS %s indisponible.&quot;
NOTIFYMSG NOPARENT	&quot;mort du processus upsmon parent - arrêt impossible&quot;</pre>

</div>
</div>

<h4 id="utilisation_de_upssched">Utilisation de upssched</h4>
<div class="level4">

<p>
Si vous souhaitez effectuer des actions différentes selon le type d&#039;événement, il est préférable d&#039;utiliser upssched.
</p>

<p>
fichier upsmon.conf (exemple) :
</p>
<pre class="file">NOTIFYCMD /sbin/upssched

NOTIFYFLAG ONLINE	SYSLOG+WALL+EXEC
NOTIFYFLAG ONBATT	SYSLOG+WALL+EXEC
NOTIFYFLAG LOWBATT	SYSLOG+WALL+EXEC
NOTIFYFLAG FSD	SYSLOG+WALL+EXEC
NOTIFYFLAG COMMOK	SYSLOG+EXEC
NOTIFYFLAG COMMBAD	SYSLOG+EXEC
NOTIFYFLAG SHUTDOWN	SYSLOG+WALL+EXEC
NOTIFYFLAG REPLBATT	SYSLOG+WALL+EXEC
NOTIFYFLAG NOCOMM	SYSLOG+WALL+EXEC
NOTIFYFLAG NOPARENT	SYSLOG+WALL+EXEC</pre>

<p>
Créer le fichier de config /etc/nut/upssched.conf
</p>
<pre class="file"># the script to be executed
CMDSCRIPT /usr/local/bin/upsalert.sh

# mandatory fields that must be set before AT commands
PIPEFN /var/run/nut/upssched.pipe
LOCKFN /var/run/nut/upssched.lock

# the timers, here 30 sec after the ONBATT (ups on battery) event
AT ONBATT * START-TIMER onbatt-timer 120

# cancel the countdown is power is back
AT ONLINE * CANCEL-TIMER onbatt-timer

AT COMMBAD * EXECUTE commbad
AT COMMOK * EXECUTE commok
AT NOCOMM * EXECUTE nocomm
AT ONBATT * EXECUTE onbatt
AT LOWBATT * EXECUTE lowbatt
AT ONLINE * EXECUTE online
AT FSD	* EXECUTE fsd
AT SHUTDOWN * EXECUTE shutdown
AT REPLBATT * EXECUTE replbatt
AT NOPARENT * EXECUTE noparent</pre>

<p>
Créer le script /usr/local/bin/upsalert.sh (<img src="/lib/images/smileys/fixme.gif" class="icon" alt="FIXME" /> exemple à revoir)
</p>
<pre class="file">#!/bin/bash
logfile=/var/log/ups.log
date=$(date +&quot;%F %T&quot;)

case $1 in
    commbad)
        echo &quot;$date : UPS communications failure.&quot; &gt;&gt; $logfile
        ;;
    commok)
        echo &quot;$date : UPS communications restored.&quot; &gt;&gt; $logfile
        echo &quot;$date :     Current status=[$(/bin/upsc localups ups.status)], Charge=$(/bin/upsc localups battery.charge)%, Load=$(/bin/upsc localups ups.load)%.&quot; &gt;&gt; $logfile
        sudo /bin/upscmd -u login -p pwd localups beeper.enable 2&gt;&gt; $logfile
        ;;
    nocomm)
        echo &quot;$date : UPS communications cannot be established.&quot; &gt;&gt; $logfile
        ;;
    onbatt)
        echo &quot;$date : UPS is on battery. Trying to suspend.&quot; &gt;&gt; $logfile
        echo &quot;$date :     Current status=[$(/bin/upsc localups ups.status)], Charge=$(/bin/upsc localups battery.charge)%, Load=$(/bin/upsc localups ups.load)%.&quot; &gt;&gt; $logfile
        sudo /bin/upscmd -u login -p pwd localups beeper.mute 120 2&gt;&gt; $logfile
        sudo /usr/sbin/pm-suspend-hybrid --quirk-none 2&gt;&amp;1 &gt;&gt; $logfile
        ;;
    onbatt-timer)
        echo &quot;$date : UPS is on battery for more than 2 min. Trying to hibernate.&quot; &gt;&gt; $logfile
       $echo &quot;$date :     Current status=[$(/bin/upsc localups ups.status)], Charge=$(/bin/upsc localups battery.charge)%, Load=$(/bin/upsc localups ups.load)%.&quot; &gt;&gt; $logfile
        sudo /bin/upscmd -u login -p pwd localups beeper.mute 300 2&gt;&gt; $logfile
        sudo /usr/sbin/pm-hibernate --quirk-none 2&amp;&gt;1 &gt;&gt;$logfile
        ;;
    lowbatt)
        echo &quot;$date : UPS has a low battery. Current load=$(/bin/upsc localups ups.status)%. Trying forced-shutdown.&quot; &gt;&gt; $logfile
        echo &quot;$date :     Current status=[$(/bin/upsc localups ups.status)], Charge=$(/bin/upsc localups battery.charge)%, Load=$(/bin/upsc localups ups.load)%.&quot; &gt;&gt; $logfile
        sleep 1
	sudo /bin/upscmd -u login -p pwd localups beeper.enable 2&gt;&gt; $logfile
        sudo /sbin/upsmon -c fsd 2&gt;&amp;1 &gt;&gt; $logfile
        ;;
    online)
        echo &quot;$date : UPS on line. Shutdown aborted.&quot; &gt;&gt; $logfile
        echo &quot;$date :     Current status=[$(/bin/upsc localups ups.status)], Charge=$(/bin/upsc localups battery.charge)%, Load=$(/bin/upsc localups ups.load)%.&quot; &gt;&gt; $logfile
        sudo /bin/upscmd -u login -p pwd localups shutdown.stop
        sleep 1
        sudo /sbin/upsmon -K &amp;&amp; echo &quot;$date : WARN : fsd flag is still on !&quot; &gt;&gt; $logfile
        sudo /bin/upscmd -u login -p pwd localups beeper.enable 2&gt;$logfile
        ;;
    fsd)
        echo &quot;$date : UPS is being forced-shutdown by the master.&quot; &gt;&gt; $logfile
        echo &quot;$date :     Current status=[$(/bin/upsc localups ups.status)], Charge=$(/bin/upsc localups battery.charge)%, Load=$(/bin/upsc localups ups.load)%.&quot; &gt;&gt; $logfile
        sleep 1
        sudo /bin/upscmd -u login -p pwd localups beeper.mute 300 2&gt;&gt; $logfile
        ;;
    shutdown)
        echo &quot;$date : The system is being shutdown.&quot; &gt;&gt; $logfile
        echo &quot;$date :     Current status=[$(/bin/upsc localups ups.status)], Charge=$(/bin/upsc localups battery.charge)%, Load=$(/bin/upsc localups ups.load)%.&quot; &gt;&gt; $logfile
        sudo /bin/upscmd -u login -p pwd localups beeper.mute 300 2&gt;&gt; $logfile
        ;;
    replbatt)
        echo &quot;$date : UPS battery is bad and needs to be replaced !!!&quot; &gt;&gt; $logfile
        echo &quot;$date :     Current status=[$(/bin/upsc localups ups.status)], Charge=$(/bin/upsc localups battery.charge)%, Load=$(/bin/upsc localups ups.load)%.&quot; &gt;&gt; $logfile
        sudo /bin/upscmd -u login -p pwd localups beeper.enable 2&gt;&gt; $logfile
        ;;
    noparent)
        echo &quot;$date : The process that shuts down the system has died (shutdown impossible).&quot; &gt;&gt; $logfile
        sudo /sbin/shutdown -h now 2&gt;&amp;1 &gt;&gt; $logfile
        ;;
    *)
        echo &quot;$date : $0 &gt; Unrecognized command: $1&quot; | tee -a $logfile 1&gt;&amp;2
        echo &quot;$date :     Current status=[$(/bin/upsc localups ups.status)], Charge=$(/bin/upsc localups battery.charge)%, Load=$(/bin/upsc localups ups.load)%.&quot; &gt;&gt; $logfile
        ;;
esac
exit 0</pre>

</div>

<h1 class="sectionedit4 page-header" id="reduire_le_nombre_d_ecriture_sur_disque_pour_les_log_et_sauver_la_vie_du_ssd_ryan">Réduire le nombre d&#039;écriture sur disque pour les log et sauver la vie du SSD Ryan</h1>
<div class="level1">
<ol class=" fix-media-list-overlap">
<li class="level1"><div class="li"> Créer un dossier pour les log permanentes : sudo mkdir -p /var/log.hdd/</div>
</li>
<li class="level1"><div class="li"> Modifier le fichier de config de /etc/logrotate.conf et ajouter la ligne <code>olddir /var/log.hdd/</code> :</div>
</li>
</ol>
<pre class="file"># see &quot;man logrotate&quot; for details
# rotate log files weekly
weekly

# keep 4 weeks worth of backlogs
rotate 4

# create new (empty) log files after rotating old ones
create

# uncomment this if you want your log files compressed
#compress

olddir /var/log.hdd/

# packages drop log rotation information into this directory
include /etc/logrotate.d

# no packages own wtmp, or btmp -- we&#039;ll rotate them here
/var/log/wtmp {
    missingok
    monthly
    create 0664 root utmp
    rotate 1
}

/var/log/btmp {
    missingok
    monthly
    create 0660 root utmp
    rotate 1
}

# system-specific logs may be configured here</pre>
<ol class=" fix-media-list-overlap">
<li class="level1"><div class="li"> Modifier /etc/fstab pour charge /var/log sur un tmpfs :</div>
</li>
</ol>
<pre class="file"># dossier en RAM (volatile)
tmpfs						/tmp            	tmpfs   defaults           				0    	0
tmpfs     					/var/tmp      		tmpfs   defaults    					0      	0
tmpfs     					/var/lock      		tmpfs   defaults    					0      	0
tmpfs						/var/log		tmpfs	defaults					0	0</pre>
<div class="noteimportant">Il est possible de s&#039;arrêter là, si le système est rarement rebooté, et que l&#039;on accepte de perdre les logs depuis la dernière rotation
</div>
</div>

<h4 id="mod_easy">Mod easy</h4>
<div class="level4">
<div class="notetip"><img src="/lib/images/smileys/fixme.gif" class="icon" alt="FIXME" /> devrait bien marcher pour systèmes avec peu de reboot, et permet de ne perdre aucun log !!
</div><ol class=" fix-media-list-overlap">
<li class="level1"><div class="li"> <img src="/lib/images/smileys/fixme.gif" class="icon" alt="FIXME" /> Créer un script dans /etc/init.d/ qui appele logrotate en mode forcé pour recopier les log dans /var/log.hdd si appelé avec <code>stop</code></div>
</li>
</ol>
<pre class="code">#!/bin/sh
case &quot;$1&quot; in
stop)
logrotate -f /etc/logrotate.conf
;;
*)
#no-op
;;
esac
exit 0</pre>
<ol class=" fix-media-list-overlap">
<li class="level1"><div class="li"> Lier le script dans /etc/rc0.d/S39savelogs</div>
</li>
</ol>
<blockquote><div class="no">
 Le mieux serait de faire un service qui écoute le bon événement et ferait la manip juste avant le démontage (S40umountfs).</div></blockquote>
<div class="notewarning">Cela ne respecte pas les règles logrotate (daily, weekly …) donc risque de perdre rapidement des données si peu de génération sont conservées pour un fichier donné !
</div>
</div>

<h4 id="mod_avance">Mod avancé</h4>
<div class="level4">
<ol class=" fix-media-list-overlap">
<li class="level1 node"><div class="li"> <img src="/lib/images/smileys/fixme.gif" class="icon" alt="FIXME" /> Créer un script dans /etc/init.d qui fait :</div>
<ul class=" fix-media-list-overlap">
<li class="level2"><div class="li"> en stop : copie des fichiers de /var/log vers /var/log.hdd &amp;&amp; umount de /var/log &amp;&amp; création des liens symboliques avec le même nom que les fichiers copiés de /var/log vers /var/log.hdd (ou lien symbolique des dossiers directement) <img src="/lib/images/smileys/fixme.gif" class="icon" alt="FIXME" /> utiliser le contenu de /var/lib/logrotate/status ? (cf. /etc/cron.daily/logrotate )</div>
</li>
<li class="level2"><div class="li"> en start (juste après mount), copier les log de /var/log/ à la suite des fichiers existant puis écrasement des fichiers de /var/log/ par ceux de /var/log.hdd</div>
</li>
</ul>
</li>
</ol>
<div class="notewarning"><img src="/lib/images/smileys/fixme.gif" class="icon" alt="FIXME" /> besoin de créer 2 liens symbolique différents : nécessité de tester le nom d&#039;appel pour vérifier si Start ou Stop &amp;&amp; avant/après mount/umount. start + après mount = OK ; stop + avant umount = OK ; sinon ne rien faire.
</div>
</div>

</div><!-- /CONTENT --></div>
          </div>
        </div>

        <div class="small text-right">

                    <span class="docInfo">
            <ul class="list-inline"><li><i class="fa fa-fw fa-file-text-o text-muted"></i> <span title="utilisateurs/draco31.fr/brouillon.txt">utilisateurs/draco31.fr/brouillon.txt</span></li><li><i class="fa fa-fw fa-calendar text-muted"></i> Dernière modification: <span title="Le 19/08/2012, 23:16">Le 19/08/2012, 23:16</span></li><li class="text-muted">par draco31.fr</li></ul>          </span>
          
          
        </div>

      </article>

      
    </main>

    <footer id="dw__footer" class="navbar navbar-default">
  <div class="container">

    <div class="small navbar-text">

            <div class="footer-dw-title row">
        <div class="media col-sm-4">
          <!--<div class="media-left">
            <img src="/_media/logo.png" alt="Wiki ubuntu-fr" class="media-object" style="width:32px" />
          </div> -->
          <div class="media-body">
            <h4 class="media-heading">Documentation ubuntu-fr</h4>
            <p>
              Les pages de cette documentation sont rédigées par les utilisateurs
              pour les utilisateurs. Apportez-nous votre aide pour améliorer
              le contenu de cette documentation.
            </p>
          </div>
        </div>
        <div class="col-sm-4">
          <h4>Liens utiles</h4>
          <ul class="list-group list-unstyled">
            <li>
              <a href="/debutant" ><i class="fa fa-fw fa-child" style="font-size: 1.3em;"></i> Débuter sur Ubuntu</a>            </li>
            <li>
              <a href="/wiki/participer_wiki" ><i class="fa fa-fw fa-edit" style="font-size: 1.3em;"></i> Participer à la documentation</a>            </li>
            <li>
              <a href="/documentation_hors_ligne" ><i class="fa fa-fw fa-book" style="font-size: 1.3em;"></i> Documentation hors ligne</a>            </li>
            <li>
              <a href="//www.ubuntu-fr.org/telechargement" ><i class="fa fa-fw fa-arrow-circle-down" style="font-size: 1.3em;"></i> Télécharger Ubuntu</a>            </li>
          </ul>
        </div>
        <div class="col-sm-4">
          <h4>Obtenir de l'aide</h4>
          <ul class="list-group list-unstyled">
            <li>
              <a href="/tutoriel/comment_obtenir_une_reponse_satisfaisante" ><i class="fa fa-fw fa-info-circle" style="font-size: 1.3em;"></i> Chercher de l'aide</a>            </li>
            <li>
              <a href="//doc.ubuntu-fr.org/" ><i class="fa fa-fw fa-book" style="font-size: 1.3em;"></i> Consulter la documentation</a>            </li>
            <li>
              <a href="//forum.ubuntu-fr.org/" ><i class="fa fa-fw fa-comments" style="font-size: 1.3em;"></i> Consulter le Forum</a>            </li>
            <li>
              <a href="//guide.ubuntu-fr.org/" ><i class="fa fa-fw fa-question-circle" style="font-size: 1.3em;"></i> Lisez le guide</a>            </li>
          </ul>
        </div>
        <p>&nbsp;</p>
      </div>
      
      
      <div class="footer-license row">

        <div class="col-sm-6">
                    <p>
            <a href="http://creativecommons.org/licenses/by-sa/3.0/deed.fr" title="CC Paternité-Partage des Conditions Initiales à l'Identique 3.0 Unported" target="" itemscope itemtype="http://schema.org/CreativeWork" itemprop="license" rel="license" class="license"><img src="/lib/tpl/bootstrap3/images/license/cc.png" width="24" height="24" alt="cc" /> <img src="/lib/tpl/bootstrap3/images/license/by.png" width="24" height="24" alt="by" /> <img src="/lib/tpl/bootstrap3/images/license/sa.png" width="24" height="24" alt="sa" /> </a>          </p>
          <p class="small">
            Sauf mention contraire, le contenu de ce wiki est placé sous les termes de la licence suivante :<br/><a href="http://creativecommons.org/licenses/by-sa/3.0/deed.fr" title="CC Paternité-Partage des Conditions Initiales à l'Identique 3.0 Unported" target="" itemscope itemtype="http://schema.org/CreativeWork" itemprop="license" rel="license" class="license">CC Paternité-Partage des Conditions Initiales à l'Identique 3.0 Unported</a>          </p>
                  </div>

        <div class="col-sm-6">
                    <ul id="dw__badges" class="list-inline text-right hidden-print">

  <li>
    <a href="https://www.dokuwiki.org/template:bootstrap3" title="Bootstrap template for DokuWiki" target="">
      <img src="/lib/tpl/bootstrap3/images/bootstrap.png" width="20" alt="Bootstrap template for DokuWiki" />
    </a>
  </li>

  <li>
    <a href="https://www.php.net" title="Powered by PHP" target="">
      <img src="/lib/tpl/bootstrap3/images/php.png" width="20" alt="Powered by PHP" />
    </a>
  </li>

  <li>
    <a href="http://validator.w3.org/check/referer" title="Valid HTML5" target="">
      <img src="/lib/tpl/bootstrap3/images/html5.png" width="20" alt="Valid HTML5" />
    </a>
  </li>

  <li>
    <a href="http://jigsaw.w3.org/css-validator/check/referer?profile=css3" title="Valid CSS" target="">
      <img src="/lib/tpl/bootstrap3/images/css3.png" width="20" alt="Valid CSS" />
    </a>
  </li>

  <li>
    <a href="https://www.dokuwiki.org/" title="Driven by DokuWiki" target="">
      <img src="/lib/tpl/bootstrap3/images/logo.png" width="20" alt="Driven by DokuWiki" />
    </a>
  </li>

</ul>
                  </div>

      </div>

    </div>

  </div>
</footer>
<img src="/lib/exe/indexer.php?id=utilisateurs%3Adraco31.fr%3Abrouillon&amp;1635533914" width="2" height="1" alt="" />
    <a href="#dokuwiki__top" class="back-to-top hidden-print btn btn-default btn-sm" title="Aller au contenu" accesskey="t"><i class="fa fa-chevron-up"></i></a>

    <div id="screen__mode">      <span class="visible-xs-block"></span>
      <span class="visible-sm-block"></span>
      <span class="visible-md-block"></span>
      <span class="visible-lg-block"></span>
    </div>

  </div>

    <!-- Piwik -->
		<script type="text/javascript">
		  var _paq = _paq || [];
		  _paq.push(["setDomains", ["*.doc.ubuntu-fr.org","*.doc.edubuntu-fr.org","*.doc.lubuntu-fr.org","*.doc.xubuntu-fr.org","*.doc.edubuntu-fr.org","*.doc.lubuntu-fr.org","*.doc.ubuntu-fr.org","*.doc.xubuntu-fr.org"]]);
		  _paq.push(['trackPageView']);
		  _paq.push(['enableLinkTracking']);
		  (function() {
		    var u="//piwik.ubuntu-fr.org/";
		    _paq.push(['setTrackerUrl', u+'piwik.php']);
		    _paq.push(['setSiteId', 3]);
		    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
		    g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'piwik.js'; s.parentNode.insertBefore(g,s);
		  })();
		</script>
		<noscript><p><img src="//piwik.ubuntu-fr.org/piwik.php?idsite=3" style="border:0;" alt="" /></p></noscript>
		<!-- End Piwik Code -->

</body>
</html>
