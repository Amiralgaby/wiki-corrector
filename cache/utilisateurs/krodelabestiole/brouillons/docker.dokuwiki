{{tag>Xenial Bionic Focal}}

{{ :docker_container_engine_logo.png?200|}}

====== Docker ======

**Docker** est un logiciel libre (sous [[wpfr>Licence_Apache|licence Apache 2.0]]) de containerisation. Il permet de manipuler des conteneurs de logiciels. Avec Docker un conteneur est un système léger individuel permettant de faire tourner un logiciel, qui fournit un service. Chaque conteneur correspond donc à un service et embarque toutes les dépendances et configurations nécessaires (on parle d'//image//). L'idée est d'isoler les services les uns des autres, ce qui apporte en sécurité et en souplesse, en permettant de les manipuler indépendamment.

Docker fonctionne sur n'importe quel système Linux, ainsi que sur Mac OS ou Windows (grâce à [[:wsl|WSL2]]).

L'intérêt principal de docker est de permettre de déployer des services simplement (quelques fichiers textes et lines de commande), indépendamment du système utilisés. Cela permet par ex. de déployer un environnement de développement ou de production en quelques minutes sur n'importe quelle machine.

Cette pratique se rapproche donc de la virtualisation (en isolant les éléments les uns des autres), mais apporte beaucoup plus de souplesse et de légèreté (seul le noyau natif de l'hôte est utilisé).

Docker fournit aussi [[https://hub.docker.com|Docker Hub]], un dépôt central d'images à partir duquel on peut télécharger et partager des applications sans avoir à réinventer la roue. Il s'agit souvent d'images officielles fournies par les développeurs des applications.
En ce sens, Docker se rapproche de techniques de mise en paquet et de distribution de logiciels tels que [[:Snap]] et [[:Flatpak]].

<note>Il existe désormais une alternative à Docker, poussée par Red Hat. Il s'agit de [[https://podman.io|Podman]]. La commande ''podamn'' reste très similaire à ''docker'' (au point que la documentation conseille de créer un alias de ''docker'' vers ''podman''), mais résout en particulier des problèmes de sécurité liés à Docker (escalade de privilège de l'utilisateur qui lance les conteneurs).</note>

<note tip>Pour mettre en place un serveur LAMP grâce à Docker, n'hésitez pas à consulter [[:docker_lamp|ce tutoriel]].</note>

==== Docker Compose ====

Docker s'utilise en principe en ligne de commande (il existe cependant des outils comme [[#Portainer]] pour gérer ses conteneurs graphiquement).
Étant donné le nombre de paramètres de configuration nécessaires à l'utilisation de certains conteneurs, cette manière de fonctionner n'est pas toujours pratique et donne des lignes de commande excessivement longues.

Docker Compose est une application tierce qui permet de déclarer ses conteneurs ainsi que tous leurs paramètres dans des fichiers de configuration (au format [[wpfr>YAML]]). Cette manière de faire étant très pratique et courante, c'est celle que nous documenterons en particulier ici.

===== Installation =====

==== Pré-requis  ====
 
  * Disposer des [[:sudo|droits d'administration]] (ce qui n'est par contre pas indispensable avec [[https://podman.io|Podman]]).
  * Disposer d'une connexion à Internet configurée et activée.

==== Méthode conseillée : installation depuis les dépôts officiels ====

Pour installer **Docker** il suffit d'[[:tutoriel:comment_installer_un_paquet|installer le paquet]] **[[apt>docker.io]]**. Docker Compose est quant à lui disponible via le paquet **[[apt>docker-compose]]** :

<code>sudo apt install docker.io docker-compose</code>

==== Méthode conseillée par le site docker.com ====

Il existe 2 versions de Docker : Docker CE (Community Edition) et Docker EE (Enterprise Edition). La version CE est gratuite et open-source, et correspond à la version packagée par défaut dans les dépôts Ubuntu, mais en version plus récente. C'est donc l'installation de cette version qui est décrite ci-après, et qui utilise le dépôt officiel mis à disposition par le site Docker.
(page d'origine en anglais : https://docs.docker.com/install/linux/docker-ce/ubuntu/#install-docker-ce)

=== Configurer le dépôt ===

Mettre à jour APT :
<code>$ sudo apt-get update</code>
Installer les paquets permettant à APT d'utiliser un serveur HTTPS de dépôt :
<code>$ sudo apt-get install \
        apt-transport-https \
        ca-certificates \
        curl \
        software-properties-common</code>
Puis ajouter la clé GPG du site de Docker :
<code>$ curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -</code>
Vérifiez que vous avez bien installé cette clé en comparant avec les 8 derniers caractères de l'empreinte ci-dessous :
9DC8 5822 9FC7 DD38 854A E2D8 8D81 803C 0EBF CD88
Pour cela, taper :
<code>$ sudo apt-key fingerprint 0EBFCD88

    pub   4096R/0EBFCD88 2017-02-22
          Key fingerprint = 9DC8 5822 9FC7 DD38 854A  E2D8 8D81 803C 0EBF CD88
    uid                  Docker Release (CE deb) <docker@docker.com>
    sub   4096R/F273FCD8 2017-02-22</code>

Pointer vers le dépôt de la version "stable" de Docker CE :
<code>$ sudo add-apt-repository \
       "deb [arch=amd64] https://download.docker.com/linux/ubuntu \
       $(lsb_release -cs) \
       stable"</code>

=== Installer Docker CE ===

Mettre à jour l'index APT :
<code>$ sudo apt-get update</code>
Installer la dernière version de Docker CE :
<code>$ sudo apt-get install docker-ce</code>

==== Pour les versions précédentes ou pour obtenir les dernières versions de Docker ====

=== En utilisant le script d'installation fourni par Docker ===

Le script est à [[https://get.docker.com|télécharger depuis le site officiel]] de Docker.

- Télécharger le script et executer le script<code>
wget https://get.docker.com/ -O script.sh
chmod +x script.sh
./script.sh
</code>

=== Manuellement === 

(testé avec succès sur Ubuntu 16.04 64Bits)


  - Tout d'abord, [[:tutoriel:comment_modifier_un_fichier|ouvrez le fichier]] **/etc/apt/sources.list.d/docker.list** en modification, puis collez-y la ligne suivante : <file>deb http://get.docker.io/ubuntu docker main</file>
  - Télécharger la clé GPG et installer le package avec les [[commande_shell|commandes]] suivantes saisies dans un [[:terminal]] :<code>
sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 36A1D7869245C8950F966E92D8576A8BA88D21E9
sudo apt-get update
sudo apt-get install lxc-docker
</code>

===== Configuration =====

Dans un environnement privé, vous pouvez éventuellement ajouter votre utilisateur au groupe **docker** afin de manipuler les containers sans avoir à utiliser **sudo** systématiquement :
<note important>N'ajoutez pas votre utilisateur au groupe docker sur un serveur accessible publiquement : cette méthode pose un problème de sécurité. Il devient en effet possible d'élever les privilèges de l'utilisateur sans entrer à nouveau de mot de passe. Si vous êtes sur un serveur en production n'entrez pas cette commande et utilisez la commande **sudo docker** au lieu de **docker** pour l'ensemble des opérations.</note>
<code>sudo usermod -aG docker $USER</code>
<note>Vous devez fermer et rouvrir votre session pour que les changements prennent effet.</note>

Une fois Docker installé, vous pouvez lancer le service :

  sudo service docker start

et vérifier s'il fonctionne correctement (n'oubliez pas le //sudo// devant la commande docker si vous n'avez pas ajouté votre utilisateur au groupe //docker//) :

  docker run hello-world

À la première exécution, Docker ne doit pas trouver l'image de l'application //hello-word// en local. Il va alors tenter de télécharger la dernière version. En cas de réussite, il exécute l'application qui affiche une simple page d'explication sur la sortie standard et s'arrête.

===== Utilisation =====

==== Manipulation d’images ====

Prendre une Debian sur le dépôt officiel de Docker et se connecter dessus :

<code>
docker pull debian
docker run -i -t debian /bin/bash
</code>

Faire tout ce qu’on veut sur la nouvelle image

<code>
root@xxxxxx# …
</code>

Et sauvegarder les changements

<code>
root@xxxxxx# exit
docker commit xxxxxx le_nom_de_l_image
</code>

Supprimer une image :

<code>
docker image rm id_ou_nom_de_l_image
</code>
ou:

<code>
docker rmi id_ou_nom_de_l_image
</code>
==== Manipulation de conteneurs ====

<code>
JOB1=$(docker run -d conteneur)
docker logs $JOB1
docker stop $JOB1
</code>

Voir les conteneurs actifs ou les lister tous ou lister id des actifs :

<code>
docker container ps
docker container ps -a
docker container ps -q
</code>

Supprimer un conteneur ou supprimer tous les conteneurs :

<code>
docker container rm $JOB1
docker container rm id_du_conteneur
docker container rm $(docker container ps -a -q)
</code>



==== Import, export ====

Une des grandes forces de Docker est de pouvoir exporter et importer très facilement les images.

Exporter un container en tar.gz :

<code>
docker export 419eed6ff306 > nginx.tgz
</code>

Importer un tar.gz :

<code>
docker import - nginx < nginx.tgz
</code>

==== Automatisation avec un Dockerfile ====

Le dockerfile est un fichier texte qui inclut une liste d'actions à exécuter pour construire une image. 

Par exemple une image simpliste de Apache pourrait ressembler à ça :

<file>
# Apache et PHP dans un container
#
# VERSION               0.0.1
#

FROM     debian:wheezy
MAINTAINER Adminrezo "admin@adminrezo.fr"

ENV DEBIAN_FRONTEND noninteractive

# Depots, mises a jour et installs

RUN (apt-get update && apt-get upgrade -y -q && apt-get dist-upgrade -y -q && apt-get -y -q autoclean && apt-get -y -q autoremove)
RUN apt-get install -y -q apache2 libapache2-mod-php5 php5 supervisor
RUN rm /var/www/index.html
ADD index.php /var/www/index.php

# Config de Apache

ENV APACHE_RUN_USER www-data
ENV APACHE_RUN_GROUP www-data
ENV APACHE_LOG_DIR /var/log/apache2

EXPOSE 80

# Demarrage des services

RUN mkdir -p /var/log/supervisor
ADD apache.conf /etc/supervisor/conf.d/apache.conf

CMD source /etc/apache2/envvars && exec /usr/sbin/apache2 -DFOREGROUND
</file>

  * MAINTAINER : nom et mail de mainteneur du conteneur
  * FROM : image de base (ubuntu, debian)
  * VOLUME : Point de montage
  * RUN : commande à exécuter pour installer le conteneur.
  * ENTRYPOINT : commande qui s’exécute au démarrage du conteneur (une seule sera exécutée).
  * CMD : commande qui s’exécute au démarrage du conteneur.
  * ADD : Copier un fichier du répertoire courant dans le filesystem du conteneur.
  * USER : utilisateur qui exécute les commandes dans le conteneur.
  * EXPOSE : Port(s) à exposer à l’exterieur.

Construire un conteneur :

<code>
docker build -t nom_du_conteneur .
</code>

===== Divers =====
==== Date et heure ====
La date et l'heure du conteneur est basée sur celle du système hôte. Cependant il est possible de constater un écart d'heure entre le système et le conteneur. Ceci est dû au fait que  le conteneur peut-être configuré sur un autre fuseau horaire (timezone).

  * Date de votre système et fuseau : <code>
date
cat /etc/timezone</code>
  * Date du conteneur et fuseau : <code>
sudo docker attach CONTENEUR
date
cat /etc/timezone </code> ou : <code>
docker exec CONTENEUR bash -c "date ;  cat /etc/timezone"
</code>
  * Réglage du fuseau depuis le conteneur <code>
sudo docker attach CONTENEUR 
sudo dpkg-reconfigure tzdata
</code> ( se détacher du conteneur : CTRL-p CTRL-q )
<note important>Cette technique ci-dessus n'est pas forcément pertinente/persistante. Préférer ce qui suit : </note>
  * Créer un conteneur avec la time Zone configurée. Pour cela utiliser la variable d'environnement "TZ" (voir [[https://serverfault.com/questions/683605/docker-container-time-timezone-will-not-reflect-changes|ce post]] ) <code>
docker run -e TZ=Europe/Amsterdam debian:jessie date
</code>
  * Dans le Dockerfile : ajouter la ligne <code> ENV TZ Europe/Amsterdam </code> ou encore : <code> ENV TZ=America/Los_Angeles
RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone </code>


===== Désinstallation =====
 
Pour supprimer cette application, il suffit de [[:tutoriel:comment_supprimer_un_paquet|supprimer son paquet]]. Selon la méthode choisie, la configuration globale de l'application est conservée ou supprimée. Les journaux du système, et les fichiers de préférence des utilisateurs dans leurs dossiers personnels sont toujours conservés.

===== Logiciels tiers =====

==== Traefik ====

==== Portainer ====

==== Statping ====

===== Voir aussi =====

  * [[https://linuxfr.org/news/docker-tutoriel-pour-manipuler-les-conteneurs|Tutoriels et articles en français sur Docker]]
  * [[https://docs.docker.com/|Documentation officielle]]
  * [[https://xataz.developpez.com/tutoriels/utilisation-docker/|Tutoriel sur developpez.com (mis à jour en mai 2017)]]
  * [[https://www.it-connect.fr/debuter-avec-docker-et-les-containers-sous-debian-8/|Docker et les containers sous Debian 8 (oct 2014)]]

----

//Contributeur principal : [[:utilisateur:chacmool|Chacmool]]//

//Contributeurs : //
  * //[[:utilisateurs:chamblard|chamblard]]//