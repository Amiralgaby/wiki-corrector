<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="fr"
  lang="fr" dir="ltr" class="no-js">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>tutoriel:samba_ad_dc_members [Wiki ubuntu-fr]</title>
  <script>(function(H){H.className=H.className.replace(/\bno-js\b/,'js')})(document.documentElement)</script>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="shortcut icon" href="/_media/favicon.ico" />
<link rel="apple-touch-icon" href="/lib/tpl/bootstrap3/images/apple-touch-icon.png" />
    <meta name="generator" content="DokuWiki"/>
<meta name="robots" content="index,follow"/>
<meta name="keywords" content="tutoriel,samba,administration,windows,reseau"/>
<link type="text/css" rel="stylesheet" href="/lib/tpl/bootstrap3/assets/fonts/united.fonts.css"/>
<link type="text/css" rel="stylesheet" href="/lib/tpl/bootstrap3/assets/font-awesome/css/font-awesome.min.css"/>
<link type="text/css" rel="stylesheet" href="/lib/tpl/bootstrap3/assets/bootstrap/united/bootstrap.min.css"/>
<link rel="search" type="application/opensearchdescription+xml" href="/lib/exe/opensearch.php" title="Wiki ubuntu-fr"/>
<link rel="start" href="/"/>
<link rel="contents" href="/tutoriel/samba_ad_dc_members?do=index" title="Plan du site"/>
<link rel="manifest" href="/lib/exe/manifest.php"/>
<link rel="alternate" type="application/rss+xml" title="Derniers changements" href="/feed.php"/>
<link rel="alternate" type="application/rss+xml" title="Catégorie courante" href="/feed.php?mode=list&amp;ns=tutoriel"/>
<link rel="edit" title="Modifier cette page" href="/tutoriel/samba_ad_dc_members?do=edit"/>
<link rel="alternate" type="text/html" title="HTML brut" href="/_export/xhtml/tutoriel/samba_ad_dc_members"/>
<link rel="alternate" type="text/plain" title="Wiki balise" href="/_export/raw/tutoriel/samba_ad_dc_members"/>
<link rel="canonical" href="http://doc.ubuntu-fr.org/tutoriel/samba_ad_dc_members"/>
<link rel="stylesheet" type="text/css" href="/lib/exe/css.php?t=bootstrap3&amp;tseed=b4a19b95bb4d08daf02b6dd52d7e6abc"/>
<!--[if gte IE 9]><!-->
<script type="text/javascript">/*<![CDATA[*/var NS='tutoriel';var JSINFO = {"bootstrap3":{"mode":"show","toc":[],"config":{"collapsibleSections":0,"fixedTopNavbar":1,"showSemanticPopup":0,"sidebarOnNavbar":0,"tagsOnTop":1,"tocAffix":1,"tocCollapseOnScroll":1,"tocCollapsed":0,"tocLayout":"default","useAnchorJS":1}},"id":"tutoriel:samba_ad_dc_members","namespace":"tutoriel","ACT":"show","useHeadingNavigation":0,"useHeadingContent":0};
/*!]]>*/</script>
<script type="text/javascript" charset="utf-8" src="/lib/exe/jquery.php?tseed=23f888679b4f1dc26eef34902aca964f"></script>
<script type="text/javascript" charset="utf-8" src="/lib/exe/js.php?t=bootstrap3&amp;tseed=b4a19b95bb4d08daf02b6dd52d7e6abc"></script>
<script type="text/javascript" src="/lib/tpl/bootstrap3/assets/bootstrap/js/bootstrap.min.js"></script>
<script type="text/javascript" src="/lib/tpl/bootstrap3/assets/anchorjs/anchor.min.js"></script>
<script type="text/javascript" src="/lib/tpl/bootstrap3/assets/typeahead/bootstrap3-typeahead.min.js"></script>
<!--<![endif]-->
<style type="text/css">@media screen { body { margin-top: 70px; }  #dw__toc.affix { top: 60px; position: fixed !important; }  #dw__toc .nav .nav .nav { display: none; } }</style>
    <!--[if lt IE 9]>
  <script type="text/javascript" src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
  <script type="text/javascript" src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
  <![endif]-->
</head>
<body class="united dokuwiki mode_show tpl_bootstrap3 dw-page-on-panel" data-page-id="tutoriel:samba_ad_dc_members">

  <header id="dokuwiki__header" class="dokuwiki container">
    <nav id="dw__navbar" class="navbar navbar-fixed-top navbar-default" role="navigation">

  <div class="container">

    <div class="navbar-header">

      <button class="navbar-toggle" type="button" data-toggle="collapse" data-target=".navbar-collapse">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>

      <a href="/accueil"  accesskey="h" title="[H]" class="navbar-brand"><span class="uf uf-cof" id="dw__accueil" style="font-size: 35px;" ></span> <span id="dw__title" style="margin-top:-5px">Wiki ubuntu-fr<span id="dw__tagline">La Documentation francophone</span></span></a>
    </div>

    <div class="collapse navbar-collapse">

      
      <ul class="nav navbar-nav">
        <li>
          <a href="//ubuntu-fr.org/" ><i class="fa fa-2x fa-fw fa-home"></i><span> Accueil</span></a>        </li>
        <li>
          <a href="//forum.ubuntu-fr.org/" ><i class="fa fa-2x fa-fw fa-comments"></i><span> Forum</span></a>        </li>
        <li>
          <a href="//planet.ubuntu-fr.org/" ><i class="fa fa-2x fa-fw fa-globe"></i><span> Planet</span></a>        </li>
      </ul>

            
      
      <div class="navbar-right" id="dw__navbar_items">

        <form action="//forum.ubuntu-fr.org/search_ubuntufr.php" accept-charset="utf-8" class="navbar-form navbar-left search" id="dw__search" method="get" role="search"><div class="no"><input id="qsearch" autocomplete="off" type="search" placeholder="Rechercher" accesskey="f" name="q" class="form-control" title="[F]" /><button type="submit" title="Rechercher"><i class="fa fa-fw fa-search"></i></button><input type="hidden" name="do" value="search" /><input type="hidden" name="tsearch" value="wiki" /></div></form>
        
<ul class="nav navbar-nav dw-action-icon" id="dw__tools">


  <li class="dropdown">

    <a href="" class="dropdown-toggle" data-target="#" data-toggle="dropdown" title="" role="button" aria-haspopup="true" aria-expanded="false">
      <i class="fa fa-2x fa-fw fa-wrench"></i> <span class="hidden-lg hidden-md hidden-sm">Outils</span> <span class="caret"></span>
    </a>

    <ul class="dropdown-menu tools" role="menu">
    
      <li class="dropdown-header">
        <i class="fa fa-fw fa-cubes"></i> Outils du site      </li>
      <li><a href="/tutoriel/samba_ad_dc_members?do=recent"  class="action recent" accesskey="r" rel="nofollow" title="Derniers changements [R]">Derniers changements</a></li><li><a href="/tutoriel/samba_ad_dc_members?do=media&amp;ns=tutoriel"  class="action media" rel="nofollow" title="Gestionnaire Multimédia">Gestionnaire Multimédia</a></li><li><a href="/tutoriel/samba_ad_dc_members?do=index"  class="action index" accesskey="x" rel="nofollow" title="Plan du site [X]">Plan du site</a></li>
            <li class="divider" role="separator"></li>
      
    
      <li class="dropdown-header">
        <i class="fa fa-fw fa-file"></i> Outils de la page      </li>
      <li><a href="/tutoriel/samba_ad_dc_members?do=edit"  class="action edit" accesskey="e" rel="nofollow" title="Modifier cette page [E]">Modifier cette page</a></li><li><a href="/tutoriel/samba_ad_dc_members?do=revisions"  class="action revs" accesskey="o" rel="nofollow" title="Anciennes révisions [O]">Anciennes révisions</a></li><li><a href="/tutoriel/samba_ad_dc_members?do=backlink"  class="action backlink" rel="nofollow" title="Liens de retour">Liens de retour</a></li><li><a href="#dokuwiki__top"  class="action top" accesskey="t" rel="nofollow" title="Haut de page [T]">Haut de page</a></li>
      
        </ul>
  </li>


</ul>


        <ul class="nav navbar-nav">

          
          
                    <li>
            <span class="dw__actions dw-action-icon">
              <a href="/tutoriel/samba_ad_dc_members?do=login&amp;sectok="  class="action btn btn-default navbar-btn login" rel="nofollow" title="S&#039;identifier"><span class="">S'identifier</span></a>            </span>
          </li>
          
        </ul>

        
        

      </div>

    </div>
  </div>
</nav>
  </header>

  <div id="dokuwiki__top" class="dokuwiki container">

    <div id="dokuwiki__pageheader">

      
      
      <p class="pageId text-right small">
        <span class="label label-primary">tutoriel:samba_ad_dc_members</span>      </p>

      <div id="dw__msgarea" class="small">
              </div>

    </div>

    <main class="main row" role="main">

      
      <article id="dokuwiki__content" class="container" itemscope itemtype="http://schema.org/Article" itemref="dw__license">

        
<nav id="dw__pagetools" class="hidden-print">
  <div class="tools panel panel-default pull-right ">
    <ul class="nav nav-stacked nav-pills">
      <li><a href="/tutoriel/samba_ad_dc_members?do=edit"  class="action text-muted edit" accesskey="e" rel="nofollow" title="Modifier cette page [E]"><i class="fa fa-fw fa-pencil-square-o"></i><span class="sr-only"> Modifier cette page</span></a></li><li><a href="/tutoriel/samba_ad_dc_members?do=revisions"  class="action text-muted revs" accesskey="o" rel="nofollow" title="Anciennes révisions [O]"><i class="fa fa-fw fa-clock-o"></i><span class="sr-only"> </span></a></li><li><a href="/tutoriel/samba_ad_dc_members?do=backlink"  class="action text-muted backlink" rel="nofollow" title="Liens de retour"><i class="fa fa-fw fa-link"></i><span class="sr-only"> Liens de retour</span></a></li>    </ul>
  </div>
</nav>

        <div class="panel panel-default" itemprop="articleBody">
          <div class="page panel-body">

            <div class="dw-content-page "><div class="dw-toc hidden-print"><script>JSINFO.bootstrap3.toc = [{"link":"#prerequis","title":"Pr\u00e9requis","level":1},{"link":"#configuration_du_nom_de_machine","title":"Configuration du nom de machine","level":2},{"link":"#resolution_de_nom_de_domaine","title":"R\u00e9solution de nom de domaine","level":2},{"link":"#synchronisation_du_temps","title":"Synchronisation du temps","level":2},{"link":"#joindre_la_machine_au_domaine_samba_ad_dc","title":"Joindre la machine au domaine Samba AD DC","level":1},{"link":"#installer_samba","title":"Installer samba","level":2},{"link":"#configurer_samba","title":"Configurer samba","level":2},{"link":"#appliquer_les_modifications","title":"Appliquer les modifications","level":2},{"link":"#joindre_la_machine_au_domaine","title":"Joindre la machine au domaine","level":2},{"link":"#ticket_kerberos_de_la_machine","title":"Ticket Kerberos de la machine","level":2},{"link":"#authentifier_les_utilisateurs","title":"Authentifier les utilisateurs","level":1},{"link":"#installer_winbind","title":"Installer Winbind","level":2},{"link":"#configurer_le_name_service_switch","title":"Configurer le Name Service Switch","level":2},{"link":"#configurer_pam","title":"Configurer PAM","level":2},{"link":"#authentification_hors_ligne","title":"Authentification hors ligne","level":2},{"link":"#parametres_ameliorant_l_utilisation_de_la_machine","title":"Param\u00e8tres am\u00e9liorant l'utilisation de la machine","level":1},{"link":"#sudo","title":"Sudo","level":2},{"link":"#outils_kerberos","title":"Outils Kerberos","level":2},{"link":"#samba-tool","title":"Samba-tool","level":2},{"link":"#ssh","title":"ssh","level":2},{"link":"#apparmor","title":"AppArmor","level":2},{"link":"#policy-kit","title":"Policy-Kit","level":2},{"link":"#mise_en_correspondance_des_groupes","title":"Mise en correspondance des groupes","level":2},{"link":"#smb4k","title":"smb4k","level":2},{"link":"#references","title":"R\u00e9f\u00e9rences","level":1}];</script>
<!-- TOC START -->
<nav id="dw__toc" role="navigation" class="toc-panel panel panel-default small">
<h6 data-toggle="collapse" data-target="#dw__toc .toc-body" title="Table des matières" class="panel-heading toc-title"><i class="fa fa-fw fa-th-list"></i> <span>Table des matières</span> <i class="caret"></i></h6>
<div class="panel-body  toc-body collapse in">

<ul class="nav toc">
<li class="level1"><a href="#prerequis">Prérequis</a>
<ul class="nav toc">
<li class="level2"><a href="#configuration_du_nom_de_machine">Configuration du nom de machine</a></li>
<li class="level2"><a href="#resolution_de_nom_de_domaine">Résolution de nom de domaine</a></li>
<li class="level2"><a href="#synchronisation_du_temps">Synchronisation du temps</a></li>
</ul>
</li>
<li class="level1"><a href="#joindre_la_machine_au_domaine_samba_ad_dc">Joindre la machine au domaine Samba AD DC</a>
<ul class="nav toc">
<li class="level2"><a href="#installer_samba">Installer samba</a></li>
<li class="level2"><a href="#configurer_samba">Configurer samba</a></li>
<li class="level2"><a href="#appliquer_les_modifications">Appliquer les modifications</a></li>
<li class="level2"><a href="#joindre_la_machine_au_domaine">Joindre la machine au domaine</a></li>
<li class="level2"><a href="#ticket_kerberos_de_la_machine">Ticket Kerberos de la machine</a></li>
</ul>
</li>
<li class="level1"><a href="#authentifier_les_utilisateurs">Authentifier les utilisateurs</a>
<ul class="nav toc">
<li class="level2"><a href="#installer_winbind">Installer Winbind</a></li>
<li class="level2"><a href="#configurer_le_name_service_switch">Configurer le Name Service Switch</a></li>
<li class="level2"><a href="#configurer_pam">Configurer PAM</a></li>
<li class="level2"><a href="#authentification_hors_ligne">Authentification hors ligne</a></li>
</ul>
</li>
<li class="level1"><a href="#parametres_ameliorant_l_utilisation_de_la_machine">Paramètres améliorant l&#039;utilisation de la machine</a>
<ul class="nav toc">
<li class="level2"><a href="#sudo">Sudo</a></li>
<li class="level2"><a href="#outils_kerberos">Outils Kerberos</a></li>
<li class="level2"><a href="#samba-tool">Samba-tool</a></li>
<li class="level2"><a href="#ssh">ssh</a></li>
<li class="level2"><a href="#apparmor">AppArmor</a></li>
<li class="level2"><a href="#policy-kit">Policy-Kit</a></li>
<li class="level2"><a href="#mise_en_correspondance_des_groupes">Mise en correspondance des groupes</a></li>
<li class="level2"><a href="#smb4k">smb4k</a></li>
</ul>
</li>
<li class="level1"><a href="#references">Références</a></li>
</ul>

</div>
</nav>
<!-- TOC END -->
</div><!-- CONTENT --><div class="dw-content"><div class="tags"><span>
	<a href="/tutoriel" class="wikilink1" title="tutoriel" rel="tag">tutoriel</a>,
	<a href="/samba" class="wikilink1" title="samba" rel="tag">samba</a>,
	<a href="/administration" class="wikilink1" title="administration" rel="tag">administration</a>,
	<a href="/windows" class="wikilink1" title="windows" rel="tag">windows</a>,
	<a href="/reseau" class="wikilink1" title="reseau" rel="tag">réseau</a>
</span></div>
<hr />

<h1 class="sectionedit1 page-header" id="samba_ad_dc_-_integration_de_machines_au_domaine">Samba AD DC - Intégration de machines au domaine</h1>
<div class="level1">

<p>
L&#039;intégration d&#039;une machine dans un domaine Active Directory (AD) va permettre d&#039;authentifier les utilisateurs du domaine sur cette machine. Cette authentification se fait vis-à-vis d&#039;un domaine contrôleur (DC).
</p>

<p>
La création d&#039;un domaine contrôleur Active Directory est détaillée dans <a href="/samba-active-directory" class="wikilink1" title="samba-active-directory">Samba - Active Directory Domain Controller (AD DC)</a>. Pour l&#039;exemple, le nom de la machine qui sera jointe au domaine est UBNWKS01.
</p>

</div>
<div class='secedit editbutton_section editbutton_1'><form class="button btn_secedit form-inline" method="post" action="/tutoriel/samba_ad_dc_members"><div class="no"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="1531773927" /><input type="hidden" name="summary" value="[Samba AD DC - Intégration de machines au domaine] " /><input type="hidden" name="target" value="section" /><input type="hidden" name="hid" value="samba_ad_dc_-_integration_de_machines_au_domaine" /><input type="hidden" name="codeblockOffset" value="0" /><input type="hidden" name="range" value="61-576" /><button type="submit" title="Samba AD DC - Intégration de machines au domaine" class=" btn btn-default btn btn-xs btn-default">Modifier</button></div></form></div>
<h2 class="sectionedit2 page-header" id="prerequis">Prérequis</h2>
<div class="level2">

</div>
<div class='secedit editbutton_section editbutton_2'><form class="button btn_secedit form-inline" method="post" action="/tutoriel/samba_ad_dc_members"><div class="no"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="1531773927" /><input type="hidden" name="summary" value="[Prérequis] " /><input type="hidden" name="target" value="section" /><input type="hidden" name="hid" value="prerequis" /><input type="hidden" name="codeblockOffset" value="0" /><input type="hidden" name="range" value="577-599" /><button type="submit" title="Prérequis" class=" btn btn-default btn btn-xs btn-default">Modifier</button></div></form></div>
<h3 class="sectionedit3" id="configuration_du_nom_de_machine">Configuration du nom de machine</h3>
<div class="level3">

<p>
Il est recommandé de mettre le FQDN <sup><a href="#fn__1" id="fnt__1" class="fn_top">1)</a></sup> de la machine dans le fichier /etc/hostname
</p>
<dl class="file">
<dt><a href="/_export/code/tutoriel/samba_ad_dc_members?codeblock=0" title="Télécharger cet extrait" class="mediafile mf_">/etc/hostname</a></dt>
<dd><pre class="file">ubnwks01.example.com</pre>
</dd></dl>

<p>
Pour faciliter la résolution de nom sans passer par le serveur <abbr title="Domain Name System">DNS</abbr>, il faut également ajouter le FQDN dans le fichier /etc/hosts
</p>
<dl class="file">
<dt><a href="/_export/code/tutoriel/samba_ad_dc_members?codeblock=1" title="Télécharger cet extrait" class="mediafile mf_">/etc/hosts</a></dt>
<dd><pre class="file">127.0.0.1       localhost
127.0.1.1       ubnwks01.example.com ubnwks01

# The following lines are desirable for IPv6 capable hosts
::1     localhost ip6-localhost ip6-loopback
ff02::1 ip6-allnodes
ff02::2 ip6-allrouters</pre>
</dd></dl>

<p>
Les commandes <em>hostname</em> et <em>hostname -f</em> doivent retourner le même résultat, le FQDN de la machine, ubnwks01.example.com. Il est important que ce soit le FQDN qui suit en premier l&#039;adresse 127.0.1.1.
</p>

</div>
<div class='secedit editbutton_section editbutton_3'><form class="button btn_secedit form-inline" method="post" action="/tutoriel/samba_ad_dc_members"><div class="no"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="1531773927" /><input type="hidden" name="summary" value="[Configuration du nom de machine] " /><input type="hidden" name="target" value="section" /><input type="hidden" name="hid" value="configuration_du_nom_de_machine" /><input type="hidden" name="codeblockOffset" value="0" /><input type="hidden" name="range" value="600-1436" /><button type="submit" title="Configuration du nom de machine" class=" btn btn-default btn btn-xs btn-default">Modifier</button></div></form></div>
<h3 class="sectionedit4" id="resolution_de_nom_de_domaine">Résolution de nom de domaine</h3>
<div class="level3">

<p>
Une bonne résolution de nom de domaine est indispensable au sein d&#039;un domaine Samba AD DC. Dans le fichier /etc/resolv.conf, il faut retrouver un serveur <abbr title="Domain Name System">DNS</abbr> du domaine et le domaine de recherche.
</p>
<dl class="file">
<dt><a href="/_export/code/tutoriel/samba_ad_dc_members?codeblock=2" title="Télécharger cet extrait" class="mediafile mf_conf">/etc/resolv.conf</a></dt>
<dd><pre class="file">nameserver 192.168.1.11
search example.com</pre>
</dd></dl>

<p>
Ces paramètres sont soit fournis par le serveur <abbr title="Dynamic Host Configuration Protocol">DHCP</abbr> du réseau ou configurés de façon statique dans le fichier <strong>/etc/network/interfaces</strong> (obsolète à partir de 18.04) ou dans un fichier YAML dans <strong>/etc/netplan</strong> (par défaut à partir de 18.04) (se référer à <a href="/tutoriel/comment_configurer_son_reseau_local" class="wikilink1" title="tutoriel:comment_configurer_son_reseau_local">Comment configurer son réseau local ?</a> et <a href="/utilisateurs/ool/netplan" class="wikilink1" title="utilisateurs:ool:netplan">netplan</a>)
</p>

<p>
Les tests suivant devraient renvoyer des résultats corrects (se référer à <a href="/samba-active-directory#tests_du_dns" class="wikilink1" title="samba-active-directory">Samba AD DC - Tests du DNS</a>)
</p>
<pre class="code">dig ubndc01.example.com</pre>
<pre class="code">dig -t SRV _kerberos._tcp.example.com</pre>
<pre class="code">dig doc.ubuntu-fr.org</pre>

</div>
<div class='secedit editbutton_section editbutton_4'><form class="button btn_secedit form-inline" method="post" action="/tutoriel/samba_ad_dc_members"><div class="no"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="1531773927" /><input type="hidden" name="summary" value="[Résolution de nom de domaine] " /><input type="hidden" name="target" value="section" /><input type="hidden" name="hid" value="resolution_de_nom_de_domaine" /><input type="hidden" name="codeblockOffset" value="2" /><input type="hidden" name="range" value="1437-2420" /><button type="submit" title="Résolution de nom de domaine" class=" btn btn-default btn btn-xs btn-default">Modifier</button></div></form></div>
<h3 class="sectionedit5" id="synchronisation_du_temps">Synchronisation du temps</h3>
<div class="level3">

<p>
Pour plusieurs raisons dont l&#039;authentification Kerberos, la synchronisation des horloges entre les machines est indispensable.
</p>

<p>
Pour ce faire, il faut installer le paquet <strong><a href="apt://ntp" class="interwiki iw_apt" title="apt://ntp">ntp</a></strong>
</p>
<pre class="code">sudo apt-get install ntp</pre>

<p>
Configurer <em>ntp</em> pour qu&#039;il se synchronise sur le DC. Voici un exemple de configuration simplifiée :
</p>
<dl class="file">
<dt><a href="/_export/code/tutoriel/samba_ad_dc_members?codeblock=7" title="Télécharger cet extrait" class="mediafile mf_conf">/etc/ntp.conf</a></dt>
<dd><pre class="file">driftfile      /var/lib/ntp/ntp.drift
logfile        /var/log/ntp

# Specify one or more NTP servers.
server ubndc01.example.com

# By default, exchange time with everybody, but don&#039;t allow configuration.
restrict default kod notrap nomodify nopeer mssntp limited

# Local users may interrogate the ntp server more closely.
restrict 127.0.0.1</pre>
</dd></dl>

<p>
Redémarrer le service <em>ntp</em>
</p>
<pre class="code">sudo service ntp restart</pre>

<p>
Vérifier le bon fonctionnement de ntp
</p>
<pre class="code">ntpq -p
     remote           refid      st t when poll reach   delay   offset  jitter
 ==============================================================================
 192.168.1.11    10.240.242.252  10 u  887 1024  377    0.632   -0.919   2.476</pre>

</div>
<div class='secedit editbutton_section editbutton_5'><form class="button btn_secedit form-inline" method="post" action="/tutoriel/samba_ad_dc_members"><div class="no"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="1531773927" /><input type="hidden" name="summary" value="[Synchronisation du temps] " /><input type="hidden" name="target" value="section" /><input type="hidden" name="hid" value="synchronisation_du_temps" /><input type="hidden" name="codeblockOffset" value="6" /><input type="hidden" name="range" value="2421-3530" /><button type="submit" title="Synchronisation du temps" class=" btn btn-default btn btn-xs btn-default">Modifier</button></div></form></div>
<h2 class="sectionedit6 page-header" id="joindre_la_machine_au_domaine_samba_ad_dc">Joindre la machine au domaine Samba AD DC</h2>
<div class="level2">

</div>
<div class='secedit editbutton_section editbutton_6'><form class="button btn_secedit form-inline" method="post" action="/tutoriel/samba_ad_dc_members"><div class="no"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="1531773927" /><input type="hidden" name="summary" value="[Joindre la machine au domaine Samba AD DC] " /><input type="hidden" name="target" value="section" /><input type="hidden" name="hid" value="joindre_la_machine_au_domaine_samba_ad_dc" /><input type="hidden" name="codeblockOffset" value="10" /><input type="hidden" name="range" value="3531-3585" /><button type="submit" title="Joindre la machine au domaine Samba AD DC" class=" btn btn-default btn btn-xs btn-default">Modifier</button></div></form></div>
<h3 class="sectionedit7" id="installer_samba">Installer samba</h3>
<div class="level3">

<p>
Il faut installer le paquet <strong><a href="apt://samba" class="interwiki iw_apt" title="apt://samba">samba</a></strong>
</p>
<pre class="code">sudo apt-get install samba</pre>

<p>
Stopper les services
</p>
<pre class="code">sudo service smbd stop
sudo service nmbd stop</pre>

</div>
<div class='secedit editbutton_section editbutton_7'><form class="button btn_secedit form-inline" method="post" action="/tutoriel/samba_ad_dc_members"><div class="no"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="1531773927" /><input type="hidden" name="summary" value="[Installer samba] " /><input type="hidden" name="target" value="section" /><input type="hidden" name="hid" value="installer_samba" /><input type="hidden" name="codeblockOffset" value="10" /><input type="hidden" name="range" value="3586-3779" /><button type="submit" title="Installer samba" class=" btn btn-default btn btn-xs btn-default">Modifier</button></div></form></div>
<h3 class="sectionedit8" id="configurer_samba">Configurer samba</h3>
<div class="level3">

<p>
La configuration de samba peut être réécrite comme suit :
</p>
<ul class=" fix-media-list-overlap">
<li class="level1"><div class="li"> Pour Ubuntu 14.04 et 16.04 (avant Samba 4.6)</div>
</li>
</ul>
<dl class="file">
<dt><a href="/_export/code/tutoriel/samba_ad_dc_members?codeblock=12" title="Télécharger cet extrait" class="mediafile mf_conf">/etc/samba/smb.conf</a></dt>
<dd><pre class="file"># Global parameters                                                                         
[global]
        workgroup = EXAMPLE
        realm = EXAMPLE.COM
        netbios name = ubnwks01
        security = ADS
        encrypt passwords = yes

        idmap config EXAMPLE:backend = ad
        idmap config EXAMPLE:schema_mode = rfc2307
        idmap config EXAMPLE:range = 10000-39999

        idmap config *:backend = tdb
        idmap config *:range = 40000-49999

        winbind nss info = rfc2307
        winbind trusted domains only = no
        winbind use default domain = yes
        winbind enum users = yes
        winbind enum groups = yes
        winbind refresh tickets = yes
                
        kerberos method = system keytab</pre>
</dd></dl>
<ul class=" fix-media-list-overlap">
<li class="level1"><div class="li"> A partir d&#039;Ubuntu 17.10 (à partir de Samba 4.6)</div>
</li>
</ul>
<dl class="file">
<dt><a href="/_export/code/tutoriel/samba_ad_dc_members?codeblock=13" title="Télécharger cet extrait" class="mediafile mf_conf">/etc/samba/smb.conf</a></dt>
<dd><pre class="file"># Global parameters                                                                         
[global]
        workgroup = EXAMPLE
        realm = EXAMPLE.COM
        netbios name = ubnwks01
        security = ADS
        encrypt passwords = yes

        idmap config EXAMPLE:backend = ad
        idmap config EXAMPLE:schema_mode = rfc2307
        idmap config EXAMPLE:range = 10000-39999
        idmap config EXAMPLE:unix_nss_info = yes

        idmap config *:backend = tdb
        idmap config *:range = 40000-49999

        winbind trusted domains only = no
        winbind use default domain = yes
        winbind enum users = yes
        winbind enum groups = yes
        winbind refresh tickets = yes
                
        kerberos method = system keytab</pre>
</dd></dl>

<p>
Les lignes <em>idmap config EXAMPLE …</em> sont très importantes. Elles définissent le backend (méthode d&#039;accès) AD (Active Directory), le schéma rfc2307 (contenant les extensions NIS utiles pour les systèmes Linux et UNIX) et la plage d&#039;identifiants numériques pour les utilisateurs et groupes du domaine EXAMPLE. Cette plage doit être définie dans la politique du domaine. Afin d&#039;éviter des usurpations d&#039;identité et de droits, il faut garantir que ces numéros soient uniques. Ils ne peuvent donc pas être utilisés localement (sur aucune machine du domaine).
</p>

<p>
Les lignes <em>idmap config *:… </em> définissent le backend tdb (base de données locale) et la plage d&#039;identifiants pour les utilisateurs et groupes venant d&#039;autres domaines. On retrouve ici entre-autre les groupes venant de BUILTIN. Par défaut, une machine qui rejoint le domaine reçoit deux groupes locaux, <em>BUILTIN\Administrators</em> et <em>BUILTIN\Users</em>. Par défaut, le groupe <em>EXAMPLE\Domain Admins</em> est membre du groupe <em>BUILTIN\Administrators</em> et le groupe <em>EXAMPLE\Domain Users</em> est membre du groupe <em>BUILTIN\Users</em>. Les autres groupes qui seraient créés localement sur la machine auront la forme <em>UBNWKS01\Nom du groupe</em>.
</p>

<p>
Les lignes <em>winbind …</em> définissent d&#039;autres options pour l&#039;utilisation de <em>winbind</em>. Notamment, la ligne <em>use default domain</em> permet de ne pas devoir inscrire à chaque fois le nom du domaine pour un utilisateur ou un groupe appartenant au domaine par défaut. 
</p>

<p>
La ligne <em>kerberos method = system keytab</em> va générer, lorsque l&#039;on joint la machine au domaine, et maintenir à jour un fichier keytab propre à la machine (/etc/krb5.keytab). Ce fichier est le jeton d&#039;authentification Kerberos pour la machine (UBNWKS01$). Ce jeton comme toute autre jeton Kerberos expire après un certain délais (10 jours ?). Avec cette option, le service <em>samba</em> maintient à jour ce jeton en le renouvelant régulièrement à condition d&#039;avoir une connexion avec le DC.
</p>
<div class="noteimportant">A partir de Samba 4.6, le paramètre <strong>winbind nss info = rfc2307</strong> est remplacé par <strong>idmap config EXAMPLE:unix_nss_info = yes</strong><sup><a href="#fn__2" id="fnt__2" class="fn_top">2)</a></sup>
</div>
</div>
<div class='secedit editbutton_section editbutton_8'><form class="button btn_secedit form-inline" method="post" action="/tutoriel/samba_ad_dc_members"><div class="no"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="1531773927" /><input type="hidden" name="summary" value="[Configurer samba] " /><input type="hidden" name="target" value="section" /><input type="hidden" name="hid" value="configurer_samba" /><input type="hidden" name="codeblockOffset" value="12" /><input type="hidden" name="range" value="3780-7834" /><button type="submit" title="Configurer samba" class=" btn btn-default btn btn-xs btn-default">Modifier</button></div></form></div>
<h3 class="sectionedit9" id="appliquer_les_modifications">Appliquer les modifications</h3>
<div class="level3">

<p>
Redémarrer les services <em>smbd</em> et <em>nmbd</em>.
</p>
<pre class="code">sudo service smbd start
sudo service nmbd start</pre>

</div>
<div class='secedit editbutton_section editbutton_9'><form class="button btn_secedit form-inline" method="post" action="/tutoriel/samba_ad_dc_members"><div class="no"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="1531773927" /><input type="hidden" name="summary" value="[Appliquer les modifications] " /><input type="hidden" name="target" value="section" /><input type="hidden" name="hid" value="appliquer_les_modifications" /><input type="hidden" name="codeblockOffset" value="14" /><input type="hidden" name="range" value="7835-7981" /><button type="submit" title="Appliquer les modifications" class=" btn btn-default btn btn-xs btn-default">Modifier</button></div></form></div>
<h3 class="sectionedit10" id="joindre_la_machine_au_domaine">Joindre la machine au domaine</h3>
<div class="level3">

<p>
Bien que l&#039;option <strong>createupn</strong> ne soit pas obligatoire pour joindre la machine dans le domaine, certaines fonctionnalités tel que <a href="/tutoriel/samba_ad_dc_nfs4_kerberized" class="wikilink1" title="tutoriel:samba_ad_dc_nfs4_kerberized">Partage NFSv4 avec authentification Kerberos</a> auront besoin que cette information soit présente dans l&#039;AD. Il est donc recommandé de directement fournir ces informations plutôt que de ne pas le faire, attendre et finalement s&#039;amuser à modifier ultérieurement l&#039;objet dans l&#039;AD.
</p>
<pre class="code">sudo net join -U Administrator</pre>

<p>
ou
</p>
<pre class="code">sudo net join createupn=UBNWS01.EXAMPLE.COM\$@EXAMPLE.COM -U Administrator
Enter Administrator&#039;s password:
Using short domain name -- EXAMPLE
Joined &#039;UBNWKS01&#039; to dns domain &#039;example.com&#039;</pre>
<div class="noteclassic">En cas d&#039;erreur: &quot;No <abbr title="Domain Name System">DNS</abbr> domain configure for ubnwks01. Unable to perform <abbr title="Domain Name System">DNS</abbr> Update. <abbr title="Domain Name System">DNS</abbr> update failed …&quot;
<p>
Ceci peut résulter du fait que le fichier /etc/hostname ne contenait pas le FQDN de la machine. Pour y remédier, on peut ajouter manuellement le record dans le <abbr title="Domain Name System">DNS</abbr> avec la commande qui suit :
</p>
<pre class="code">samba-tool dns add ubndc01 example.com ubnwks01 A 192.168.1.101 -U Administrator</pre>

</div>
</div>
<div class='secedit editbutton_section editbutton_10'><form class="button btn_secedit form-inline" method="post" action="/tutoriel/samba_ad_dc_members"><div class="no"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="1531773927" /><input type="hidden" name="summary" value="[Joindre la machine au domaine] " /><input type="hidden" name="target" value="section" /><input type="hidden" name="hid" value="joindre_la_machine_au_domaine" /><input type="hidden" name="codeblockOffset" value="15" /><input type="hidden" name="range" value="7982-9138" /><button type="submit" title="Joindre la machine au domaine" class=" btn btn-default btn btn-xs btn-default">Modifier</button></div></form></div>
<h3 class="sectionedit11" id="ticket_kerberos_de_la_machine">Ticket Kerberos de la machine</h3>
<div class="level3">

<p>
Si la ligne <em>kerberos method = system keytab</em> était présente dans la partie globale du fichier /etc/samba/smb.conf, un fichier /etc/krb5.keytab a été crée lorsque la machine a été jointe au domaine. Ce fichier contient le ticket Kerberos de la machine (UBNWKS01$). De par sa nature, cette information est sensible et donc protégée par des droits d&#039;accès restreints (<code>-rw------ root root</code>). Tant que la ligne <em>kerberos method = system keytab</em>, ce jeton d&#039;authentification sera renouvellé à temps à condition de ne pas dépasser le délais de renouvellement.
</p>

<p>
On peut vérifier si le fichier existe avec
</p>
<pre class="code">ls -l /etc/krb5.keytab
-rw------- 1 root root 1057 Nov  4 19:37 /etc/krb5.keytab</pre>

<p>
Avec les <a href="/utilisateurs/qedinux/samba_ad_dc_members#kerberos" class="wikilink1" title="utilisateurs:qedinux:samba_ad_dc_members">outils Kerberos</a>, on peut lire ce ticket 
</p>
<pre class="code">sudo klist -ket
Keytab name: FILE:/etc/krb5.keytab
KVNO Timestamp           Principal
---- ------------------- ------------------------------------------------------
   1 11/04/2014 19:37:24 host/ubnwks01.example.com@EXAMPLE.COM (des-cbc-crc) 
   1 11/04/2014 19:37:24 host/ubnwks01.example.com@EXAMPLE.COM (des-cbc-md5) 
   1 11/04/2014 19:37:24 host/ubnwks01.example.com@EXAMPLE.COM (aes128-cts-hmac-sha1-96) 
   1 11/04/2014 19:37:24 host/ubnwks01.example.com@EXAMPLE.COM (aes256-cts-hmac-sha1-96) 
   1 11/04/2014 19:37:24 host/ubnwks01.example.com@EXAMPLE.COM (arcfour-hmac) 
   1 11/04/2014 19:37:24 host/ubnwks01@EXAMPLE.COM (des-cbc-crc) 
   1 11/04/2014 19:37:24 host/ubnwks01@EXAMPLE.COM (des-cbc-md5) 
   1 11/04/2014 19:37:24 host/ubnwks01@EXAMPLE.COM (aes128-cts-hmac-sha1-96) 
   1 11/04/2014 19:37:25 host/ubnwks01@EXAMPLE.COM (aes256-cts-hmac-sha1-96) 
   1 11/04/2014 19:37:25 host/ubnwks01@EXAMPLE.COM (arcfour-hmac) 
   1 11/04/2014 19:37:25 UBNWKS01$@EXAMPLE.COM (des-cbc-crc) 
   1 11/04/2014 19:37:25 UBNWKS01$@EXAMPLE.COM (des-cbc-md5) 
   1 11/04/2014 19:37:25 UBNWKS01$@EXAMPLE.COM (aes128-cts-hmac-sha1-96) 
   1 11/04/2014 19:37:25 UBNWKS01$@EXAMPLE.COM (aes256-cts-hmac-sha1-96) 
   1 11/04/2014 19:37:25 UBNWKS01$@EXAMPLE.COM (arcfour-hmac) </pre>

<p>
On peut vérifier que ce fichier est toujours valide pour authentifier la machine et ses services vis-à-vis du serveur Kerberos
</p>
<pre class="code">sudo kinit -V -k &#039;UBNWKS01$&#039; -c /dev/null
Using default cache: /tmp/krb5cc_1000
Using principal: UBNWKS01$@EXAMPLE.COM
Authenticated to Kerberos v5</pre>

<p>
La ligne <em>Authenticated to Kerberos v5</em> témoigne de la bonne exécution et donc de la validité du fichier /etc/krb5.keytab. Si au contraire, on reçoit <em>kinit: Bad encryption type while getting initial credentials</em>. Ceci signifie que le ticket d&#039;authentification présent dans ce fichier est expiré. Il faut le régénérer avec la commande <em>net ads keytab create</em>. On verra alors avec la commande <em>klist -ket</em> que le chiffre dans la colonne KVNO a été incrémenté (une ou plusieurs fois)
</p>

<p>
Si le fichier /etc/krb5.keytab n&#039;existe pas ou que le ticket d&#039;authentification a expiré, il faut vérifier la présence de la ligne <em>kerberos method = system keytab</em> dans la partie globale du fichier /etc/samba/smb.conf et recréer manuellement le fichier. Deux opérations sont nécessaires. La première consiste à obtenir un ticket Kerberos au nom de <em>Administrator</em> (un compte du domaine possédant les droits d&#039;administration sur celui-ci) pour le superutilisateur <em>root</em>.
</p>
<pre class="code">sudo kinit administrator
Password for administrator@EXAMPLE.COM:</pre>

<p>
La seconde interroge le DC pour recevoir un nouveau jeton et crée le fichier /etc/krb5.keytab sur la machine.
</p>
<pre class="code">sudo net ads keytab create -k</pre>
<div class="notetip">Vous recevez un avertissement si le paramètre &quot;kerberos method&quot; n&#039;est pas définit dans /etc/samba/smb.conf 
<pre class="code">Warning: &quot;kerberos method&quot; must be set to a keytab method to use keytab functions.</pre>

</div>
<p>
Finalement et pour la sécurité, on peut détruire le ticket Kerberos utilisé avec les droits root
</p>
<pre class="code">sudo kdestroy</pre>

</div>
<div class='secedit editbutton_section editbutton_11'><form class="button btn_secedit form-inline" method="post" action="/tutoriel/samba_ad_dc_members"><div class="no"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="1531773927" /><input type="hidden" name="summary" value="[Ticket Kerberos de la machine] " /><input type="hidden" name="target" value="section" /><input type="hidden" name="hid" value="ticket_kerberos_de_la_machine" /><input type="hidden" name="codeblockOffset" value="18" /><input type="hidden" name="range" value="9139-13154" /><button type="submit" title="Ticket Kerberos de la machine" class=" btn btn-default btn btn-xs btn-default">Modifier</button></div></form></div>
<h2 class="sectionedit12 page-header" id="authentifier_les_utilisateurs">Authentifier les utilisateurs</h2>
<div class="level2">

</div>
<div class='secedit editbutton_section editbutton_12'><form class="button btn_secedit form-inline" method="post" action="/tutoriel/samba_ad_dc_members"><div class="no"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="1531773927" /><input type="hidden" name="summary" value="[Authentifier les utilisateurs] " /><input type="hidden" name="target" value="section" /><input type="hidden" name="hid" value="authentifier_les_utilisateurs" /><input type="hidden" name="codeblockOffset" value="25" /><input type="hidden" name="range" value="13155-13197" /><button type="submit" title="Authentifier les utilisateurs" class=" btn btn-default btn btn-xs btn-default">Modifier</button></div></form></div>
<h3 class="sectionedit13" id="installer_winbind">Installer Winbind</h3>
<div class="level3">

<p>
Il faut installer <strong><a href="apt://libnss-winbind" class="interwiki iw_apt" title="apt://libnss-winbind">libnss-winbind</a></strong>, <strong><a href="apt://libpam-winbind" class="interwiki iw_apt" title="apt://libpam-winbind">libpam-winbind</a></strong> et <strong><a href="apt://winbind" class="interwiki iw_apt" title="apt://winbind">winbind</a></strong>
</p>
<pre class="code">sudo apt-get install libnss-winbind libpam-winbind winbind</pre>

<p>
A ce stade, la commande <em>wbinfo</em> devrait déjà fonctionner mais pas <em>getent</em> pour les utilisateurs et groupes du domaine (correctement configurés).
</p>
<pre class="code">wbinfo -u
wbinfo -g</pre>

</div>
<div class='secedit editbutton_section editbutton_13'><form class="button btn_secedit form-inline" method="post" action="/tutoriel/samba_ad_dc_members"><div class="no"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="1531773927" /><input type="hidden" name="summary" value="[Installer Winbind] " /><input type="hidden" name="target" value="section" /><input type="hidden" name="hid" value="installer_winbind" /><input type="hidden" name="codeblockOffset" value="25" /><input type="hidden" name="range" value="13198-13581" /><button type="submit" title="Installer Winbind" class=" btn btn-default btn btn-xs btn-default">Modifier</button></div></form></div>
<h3 class="sectionedit14" id="configurer_le_name_service_switch">Configurer le Name Service Switch</h3>
<div class="level3">

<p>
Il faut ajouter <strong>winbind</strong> aux possibilités <em>passwd</em> et <em>group</em>.
</p>
<dl class="file">
<dt><a href="/_export/code/tutoriel/samba_ad_dc_members?codeblock=27" title="Télécharger cet extrait" class="mediafile mf_conf">/etc/nsswitch.conf</a></dt>
<dd><pre class="file">passwd:         compat winbind
group:          compat winbind</pre>
</dd></dl>
<div class="noteimportant">Ceci ne montre que les modifications apportées au fichier
</div>
<p>
A ce stade, la commande <em>getent passwd</em> devrait lister les utilisateurs du domaine (correctement configurés).
</p>
<pre class="code">getent passwd
...
administrator:*:10000:10000:Administrator:/home/example/administrator:/bin/bash
...</pre>

<p>
A ce stade, la commande <em>getent group</em> ne devrait pas lister les groupes du domaine (correctement configurés) à cause de la ligne <em>winbind use default domain = yes</em> présente dans /etc/samba/smb.conf. Mais, on peut obtenir les informations sur un groupe du domaine en spécifiant ce groupe à la commande <em>getent</em>
</p>
<pre class="code">getent group &quot;Domain Admins&quot;
domain admins:x:10000:administrator</pre>

<p>
La commande <em>id</em> peut également être utilisée pour lister l&#039;identifiant d&#039;un utilisateur du domaine (son UID), l&#039;identifiant de son groupe principal (GID) et les identifiants des autres groupes auxquels il appartient tenant compte de l&#039;héritage.
</p>
<pre class="code">id administrator
uid=10000(administrator) gid=10000(domain admins) groups=10000(domain admins),10005(schema admins),10007(group policy creator owners),10017(denied rodc password replication group),10004(enterprise admins),10003(domain users)</pre>
<div class="noteclassic">Les commandes ci-dessus ne mentionnent pas le domaine auquel appartient l&#039;utilisateur ou le groupe. Cette information n&#039;est pas nécessaire car <em>samba</em> est configuré pour utiliser le domaine par défaut avec la ligne <em>winbind use default domain = yes</em>. Dans le cas contraire, il aurait fallu noter EXAMPLE\Administrator
</div>
<p>
Tout ceci montre une situation correctement configurée c&#039;est-à-dire que chaque utilisateur ou groupe du domaine possède un identifiant NIS unique. Dans le cas contraire, par exemple pas d&#039;identifiant pour le groupe <em>schema admins</em> donnerait ce résultat avec la commande <em>id</em>
</p>
<pre class="code">id administrator
uid=10000(administrator) gid=10000(domain admins) groups=10000(domain admins),4294967295,10007(group policy creator owners),10017(denied rodc password replication group),10004(enterprise admins),10003(domain users)</pre>
<div class="notewarning">L&#039;identifiant <strong>4294967295</strong> n&#039;est pas dans le range du domaine (10000-39999) ou des autres domaines (40000-49999). Ceci montre que l&#039;utilisateur administrator est membre d&#039;un groupe que le système n&#039;est pas capable d&#039;identifier correctement. Ceci générera des problèmes futures. Il faut y remédier. Une possibilité est l&#039;utilisation d&#039;un script qui parcours l&#039;ensemble des utilisateurs et groupes du domaine pour vérifier et au besoin ajouter un identifiant NIS. Plus d&#039;infos <a href="https://wiki.samba.org/index.php/Using_RFC2307_on_a_Samba_DC" class="urlextern" title="https://wiki.samba.org/index.php/Using_RFC2307_on_a_Samba_DC" rel="nofollow">ici</a>.
</div><div class="notetip">Après avoir rejoint le domaine, il est possible que les groupes BUILTIN\Administrators et BUILTIN\Users ne soient pas correctement reconnu par <em>winbind</em>. Dans ce cas, on peut les lister. Cette opération semble remédier au problème. Après, il faut vider le cache et redémarrer le service <em>winbind</em>.
<pre class="code">net rpc group list -U Administrator
Administrators
Users
sudo net cache flush
sudo service winbind restart</pre>

</div>
</div>
<div class='secedit editbutton_section editbutton_14'><form class="button btn_secedit form-inline" method="post" action="/tutoriel/samba_ad_dc_members"><div class="no"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="1531773927" /><input type="hidden" name="summary" value="[Configurer le Name Service Switch] " /><input type="hidden" name="target" value="section" /><input type="hidden" name="hid" value="configurer_le_name_service_switch" /><input type="hidden" name="codeblockOffset" value="27" /><input type="hidden" name="range" value="13582-16902" /><button type="submit" title="Configurer le Name Service Switch" class=" btn btn-default btn btn-xs btn-default">Modifier</button></div></form></div>
<h3 class="sectionedit15" id="configurer_pam">Configurer PAM</h3>
<div class="level3">

<p>
Le module PAM de winbind gère le mécanisme d&#039;authentification des utilisateurs. C&#039;est celui-ci qui va permettre aux utilisateurs de se loguer sur la machine physiquement ou de façon distante. Par défaut, il ne faut rien faire. Cependant lorsqu&#039;un utilisateur du domaine voudra se loguer sur la machine, son répertoire HOME n&#039;existera probablement pas sur cette machine. Afin de remédier à ce problème, il faut créer un fichier /usr/share/pam-configs/mkhomedir qui va permettre de créer automatiquement le répertoire HOME de l&#039;utilisateur qui se connecte.
</p>
<dl class="file">
<dt><a href="/_export/code/tutoriel/samba_ad_dc_members?codeblock=33" title="Télécharger cet extrait" class="mediafile mf_">/usr/share/pam-configs/mkhomedir</a></dt>
<dd><pre class="file">Name: Create home directory during login
Default: yes
Priority: 900
Session-Type: Additional
Session: required pam_mkhomedir.so umask=0077 skel=/etc/skel</pre>
</dd></dl>

<p>
Il faut finalement activer le module qui vient d&#039;être créé
</p>
<pre class="code">sudo pam-auth-update</pre>
<pre class="code">Package configuration                                                           
                                                                                
   ┌─────────────────────────┤ PAM configuration ├──────────────────────────┐   
   │ PAM profiles to enable:                                                │   
   │                                                                        │   
   │    [*] Create home directory during login                              │   
   │    [*] Unix authentication                                             │   
   │    [*] Winbind NT/Active Directory authentication                      │   
   │    [*] Register user sessions in the systemd control group hierarchy   │   
   │    [*] Inheritable Capabilities Management                             │   
   │                                                                        │   
   │                   &lt;Ok&gt;                       &lt;Cancel&gt;                  │   
   └────────────────────────────────────────────────────────────────────────┘   </pre>

<p>
On peut à présent tester l&#039;authentification soit sur une autre console (Ctrl+F2), soit avec ssh
</p>
<pre class="code">ssh administrator@localhost
...
administrator@localhost&#039;s password:
Creating directory &#039;/home/example/administrator&#039;.
...
administrator@ubnwks01:~$ pwd
/home/example/administrator</pre>

<p>
On voit que le répertoire HOME de l&#039;utilisateur a été créé lors du processus de login (même par SSH).
</p>

</div>
<div class='secedit editbutton_section editbutton_15'><form class="button btn_secedit form-inline" method="post" action="/tutoriel/samba_ad_dc_members"><div class="no"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="1531773927" /><input type="hidden" name="summary" value="[Configurer PAM] " /><input type="hidden" name="target" value="section" /><input type="hidden" name="hid" value="configurer_pam" /><input type="hidden" name="codeblockOffset" value="33" /><input type="hidden" name="range" value="16903-19558" /><button type="submit" title="Configurer PAM" class=" btn btn-default btn btn-xs btn-default">Modifier</button></div></form></div>
<h3 class="sectionedit16" id="authentification_hors_ligne">Authentification hors ligne</h3>
<div class="level3">
<div class="noteclassic">A mettre à jour cfr <a href="https://wiki.samba.org/index.php/PAM_Offline_Authentication" class="urlextern" title="https://wiki.samba.org/index.php/PAM_Offline_Authentication" rel="nofollow">PAM Offline Authentication</a>
</div>
<p>
Le cas des ordinateurs portables est typique d&#039;une situation dans laquelle l&#039;utilisateur est amené à ne pas être connecté au réseau et par conséquence, ne pas être capable de se faire authentifier par le DC. Une solution à ce problème consiste à mettre en place un cache des authentifications sur base des authentifications réussies. Ainsi, lorsque le DC est inaccessible, le cache permet d&#039;authentifier l&#039;utilisateur lui permettant de travailler.
</p>

<p>
La ligne <em>winbind offline login = yes</em> dans le fichier /etc/samba/smb.conf indique au PAM pour Winbind d&#039;autoriser l&#039;authentification sur base d&#039;un cache. Il faut donc ajouter cette ligne.
</p>
<dl class="file">
<dt><a href="/_export/code/tutoriel/samba_ad_dc_members?codeblock=37" title="Télécharger cet extrait" class="mediafile mf_conf">/etc/samba/smb.conf</a></dt>
<dd><pre class="file">...
        winbind offline logon = yes
...</pre>
</dd></dl>

<p>
Il faut également ajouter l&#039;option <em>cached_login</em> au PAM pour Winbind en créant ou modifiant le fichier /etc/security/pam_winbind.conf et en rechargeant PAM
</p>
<dl class="file">
<dt><a href="/_export/code/tutoriel/samba_ad_dc_members?codeblock=38" title="Télécharger cet extrait" class="mediafile mf_conf">/etc/security/pam_winbind.conf</a></dt>
<dd><pre class="file">[global]
# request a cached login if possible (needs &quot;winbind offline logon = yes&quot; in smb.conf)
cached_login = yes</pre>
</dd></dl>
<pre class="code">sudo pam-auth-update</pre>

<p>
<del>Afin de réaliser le cache des d&#039;informations d&#039;authentification, il faut installer le PAM pour CCRED (Cache Credentials) avec le paquet <strong><a href="apt://libpam-ccreds" class="interwiki iw_apt" title="apt://libpam-ccreds">libpam-ccreds</a></strong></del>
</p>
<pre class="code">sudo apt-get install libpam-ccreds</pre>

<p>
<del>Le PAM pour CCRED (Cache Credentials) réalise le cache des informations d&#039;authentification. Ce cache est stocké dans une base de données de type Berkeley DB, /var/cache/.security.db. Il est possible d&#039;interroger cette base de données avec les outils <em>cc_dump</em> et <em>cc_test</em> fournis par le paquet <em>libpam-ccreds</em>. Cette base de données équivaut au <em>shadow</em> du NSS.</del>
</p>

<p>
<del>Il faut également ajouter le paquet <strong><a href="apt://nss-updatedb" class="interwiki iw_apt" title="apt://nss-updatedb">nss-updatedb</a></strong></del>
</p>
<pre class="code">sudo apt-get install nss-updatedb</pre>

<p>
<del>Le paquet <em>nss-updatedb</em> fourni la commande <em>nss_updatedb</em> qui permet de créer des bases de données de type Berkeley DB stockant les données équivalentes aux <em>passwd</em> et <em>group</em> du NSS. Il faut l&#039;invoquer régulièrement afin de maintenir à jour ces bases de données.</del>
</p>
<pre class="code">sudo nss_updatedb winbind</pre>

<p>
<del>De plus, il faut informer le système qu&#039;il peut utiliser ces bases de données comme source pour <em>passwd</em> et <em>group</em> en ajoutant <em>db</em> aux entrées respectives du fichier <em>/etc/nsswitch.conf</em></del>
</p>
<dl class="file">
<dt><a href="/_export/code/tutoriel/samba_ad_dc_members?codeblock=43" title="Télécharger cet extrait" class="mediafile mf_conf">/etc/nsswitch.conf</a></dt>
<dd><pre class="file">passwd:        compat winbind db
group:         compat winbind db</pre>
</dd></dl>

<p>
Une fois ceci mis en place, un utilisateur du domaine pourra se reconnecter à sa session lorsqu&#039;il est hors ligne.
</p>

</div>
<div class='secedit editbutton_section editbutton_16'><form class="button btn_secedit form-inline" method="post" action="/tutoriel/samba_ad_dc_members"><div class="no"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="1531773927" /><input type="hidden" name="summary" value="[Authentification hors ligne] " /><input type="hidden" name="target" value="section" /><input type="hidden" name="hid" value="authentification_hors_ligne" /><input type="hidden" name="codeblockOffset" value="37" /><input type="hidden" name="range" value="19559-22305" /><button type="submit" title="Authentification hors ligne" class=" btn btn-default btn btn-xs btn-default">Modifier</button></div></form></div>
<h2 class="sectionedit17 page-header" id="parametres_ameliorant_l_utilisation_de_la_machine">Paramètres améliorant l&#039;utilisation de la machine</h2>
<div class="level2">

</div>
<div class='secedit editbutton_section editbutton_17'><form class="button btn_secedit form-inline" method="post" action="/tutoriel/samba_ad_dc_members"><div class="no"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="1531773927" /><input type="hidden" name="summary" value="[Paramètres améliorant l&#039;utilisation de la machine] " /><input type="hidden" name="target" value="section" /><input type="hidden" name="hid" value="parametres_ameliorant_l_utilisation_de_la_machine" /><input type="hidden" name="codeblockOffset" value="44" /><input type="hidden" name="range" value="22306-22370" /><button type="submit" title="Paramètres améliorant l&#039;utilisation de la machine" class=" btn btn-default btn btn-xs btn-default">Modifier</button></div></form></div>
<h3 class="sectionedit18" id="sudo">Sudo</h3>
<div class="level3">

<p>
Afin de donner les droits superutilisateur local à un groupe du domaine (Domain Admins), il faut modifier avec la commande <strong>visudo</strong> le fichier /etc/sudoers.
</p>
<pre class="code">sudo visudo</pre>

<p>
Et ajouter les lignes
</p>
<dl class="file">
<dt><a href="/_export/code/tutoriel/samba_ad_dc_members?codeblock=45" title="Télécharger cet extrait" class="mediafile mf_">/etc/sudoers</a></dt>
<dd><pre class="file">...
# Allow members of domain group &quot;Domain Admins&quot; to execute any command
%domain\ admins ALL=(ALL:ALL) ALL
...</pre>
</dd></dl>

<p>
A présent, les membres du groupe &quot;Domain Admins&quot; peuvent exécuter toutes les commandes avec <em>sudo</em>.
</p>

</div>
<div class='secedit editbutton_section editbutton_18'><form class="button btn_secedit form-inline" method="post" action="/tutoriel/samba_ad_dc_members"><div class="no"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="1531773927" /><input type="hidden" name="summary" value="[Sudo] " /><input type="hidden" name="target" value="section" /><input type="hidden" name="hid" value="sudo" /><input type="hidden" name="codeblockOffset" value="44" /><input type="hidden" name="range" value="22371-22841" /><button type="submit" title="Sudo" class=" btn btn-default btn btn-xs btn-default">Modifier</button></div></form></div>
<h3 class="sectionedit19" id="outils_kerberos">Outils Kerberos</h3>
<div class="level3">

<p>
Il pourra être utile d&#039;installer les outils Kerberos (notamment kinit, klist, kdestroy, …) pour investiguer, tester et dépanner les problèmes relatifs à Kerberos.
</p>
<pre class="code">sudo apt-get install krb5-user</pre>

<p>
Plus d&#039;infos, se référer à <a href="/samba-active-directory#tests_de_kerberos" class="wikilink1" title="samba-active-directory">Samba AD DC - Tests de Kerberos</a>
</p>

</div>
<div class='secedit editbutton_section editbutton_19'><form class="button btn_secedit form-inline" method="post" action="/tutoriel/samba_ad_dc_members"><div class="no"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="1531773927" /><input type="hidden" name="summary" value="[Outils Kerberos] " /><input type="hidden" name="target" value="section" /><input type="hidden" name="hid" value="outils_kerberos" /><input type="hidden" name="codeblockOffset" value="46" /><input type="hidden" name="range" value="22842-23190" /><button type="submit" title="Outils Kerberos" class=" btn btn-default btn btn-xs btn-default">Modifier</button></div></form></div>
<h3 class="sectionedit20" id="samba-tool">Samba-tool</h3>
<div class="level3">

<p>
L&#039;outil <em>samba-tool</em> peut être utilisé pour administrer à distance le domaine en ajoutant en fin de commande -H ldap://ubndc01.example.com. Ne pas mettre l&#039;IP d&#039;un serveur !
</p>

<p>
L&#039;authentification peut se faire de façon traditionnelle pour tous les utilisateurs en ajoutant en fin de commande -U &lt;domain username&gt;
</p>
<pre class="code">localuser@ubnwks01:~$ samba-tool user list -U Administrator -H ldap://ubndc01.example.com
Password for [EXAMPLE\Administrator]:
administrator
krbtgt
Guest</pre>

<p>
Ou sur base du ticket Kerberos en ajoutant en fin de commande -k yes pour un utilisateur du domaine correctement authentifié
</p>
<pre class="code">administrator@ubnwks01:~$ samba-tool user list -k yes -H ldap://ubndc01.example.com
administrator
krbtgt
Guest</pre>

<p>
Ou sur base du ticket Kerberos en ajoutant en fin de commande -k yes pour un utilisateur quelconque ayant demandé un ticket avec <em>kinit</em> pour le compte d&#039;un utilisateur du domaine
</p>
<pre class="code">localuser@ubnwks01:~$ kinit administrator@EXAMPLE.COM
Password for administrator@EXAMPLE.COM: 
localuser@ubnwks01:~$ klist
Ticket cache: FILE:/tmp/krb5cc_1000
Default principal: administrator@EXAMPLE.COM

Valid starting       Expires              Service principal
10/31/2014 15:41:37  11/01/2014 01:41:37  krbtgt/EXAMPLE.COM@EXAMPLE.COM
        renew until 11/01/2014 15:41:31
localuser@ubnwks01:~$ samba-tool user list -k yes -H ldap://ubndc01.example.com
administrator
krbtgt
Guest
localuser@ubnwks01:~$ kdestroy</pre>

</div>
<div class='secedit editbutton_section editbutton_20'><form class="button btn_secedit form-inline" method="post" action="/tutoriel/samba_ad_dc_members"><div class="no"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="1531773927" /><input type="hidden" name="summary" value="[Samba-tool] " /><input type="hidden" name="target" value="section" /><input type="hidden" name="hid" value="samba-tool" /><input type="hidden" name="codeblockOffset" value="47" /><input type="hidden" name="range" value="23191-24665" /><button type="submit" title="Samba-tool" class=" btn btn-default btn btn-xs btn-default">Modifier</button></div></form></div>
<h3 class="sectionedit21" id="ssh">ssh</h3>
<div class="level3">

<p>
Pour activer l&#039;utilisation de l&#039;authentification par Kerberos pour SSH, il faut décommenter les lignes concernant GSSAPIAuthentication dans /etc/ssh/sshd_config (pour la partie serveur) et GSSAPIAuthentication et GSSAPIDelegateCredentials dans /etc/ssh/ssh_config (pour la partie cliente) et activer ces options en passant la valeur à <em>yes</em> au lieu de <em>no</em>.
</p>
<dl class="file">
<dt><a href="/_export/code/tutoriel/samba_ad_dc_members?codeblock=50" title="Télécharger cet extrait" class="mediafile mf_">/etc/ssh/sshd_config</a></dt>
<dd><pre class="file">...
        GSSAPIAuthentication = yes
...</pre>
</dd></dl>
<dl class="file">
<dt><a href="/_export/code/tutoriel/samba_ad_dc_members?codeblock=51" title="Télécharger cet extrait" class="mediafile mf_">/etc/ssh/ssh_config</a></dt>
<dd><pre class="file">...
        GSSAPIAuthentication = yes
        GSSAPIDelegateCredentials = yes
...</pre>
</dd></dl>

<p>
La modification du fichier /etc/ssh/ssh_config doit se faire sur chaque machine à partir de laquelle un client essaye d&#039;ouvrir une session SSH.
</p>

<p>
La modification du fichier /etc/ssh/sshd_config doit se faire sur chaque machine sur laquelle un client essaye d&#039;ouvrir une session SSH.
</p>

<p>
Pour que le serveur SSH puissent accepter l&#039;authentification de l&#039;utilisateur, il doit posséder lui-même un ticket Kerberos valide. Sans configuration particulière, le serveur SSH utilisera le ticket Kerberos de la machine pour s&#039;authentifier (c-à-d. le fichier /etc/krb5.keytab). En cas de problème, il faut vérifier la validité du ticket (se référer à <a href="/utilisateurs/qedinux/samba_ad_dc_members#ticket_kerberos_de_la_machine" class="wikilink1" title="utilisateurs:qedinux:samba_ad_dc_members">Ticket Kerberos de la machine</a>)
</p>

<p>
A présent, un utilisateur du domaine utilisant une autre machine du domaine peut ouvrir une session SSH sur la machine <em>ubnwks01</em> sans devoir introduire son mot de passe.
</p>

</div>
<div class='secedit editbutton_section editbutton_21'><form class="button btn_secedit form-inline" method="post" action="/tutoriel/samba_ad_dc_members"><div class="no"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="1531773927" /><input type="hidden" name="summary" value="[ssh] " /><input type="hidden" name="target" value="section" /><input type="hidden" name="hid" value="ssh" /><input type="hidden" name="codeblockOffset" value="50" /><input type="hidden" name="range" value="24666-26172" /><button type="submit" title="ssh" class=" btn btn-default btn btn-xs btn-default">Modifier</button></div></form></div>
<h3 class="sectionedit22" id="apparmor">AppArmor</h3>
<div class="level3">

<p>
Afin d&#039;éviter de désagréables dysfonctionnements provoqués par AppArmor, il faut le reconfigurer pour définir le chemin des répertoires <em>home</em> des utilisateurs du domaine, typiquement <em>/home/example/ </em>
</p>
<pre class="code">sudo dpkg-reconfigure apparmor</pre>
<pre class="code">   ┌────────────────────────────────────────────────┤ Configuration de apparmor ├────────────────────────────────────────────────┐   
   │ Veuillez indiquer, séparés par des espaces, les emplacements des répertoires personnels (« home ») supplémentaires des      │   
   │ utilisateurs. Ces répertoires seront ajoutés à ceux qui sont indiqués dans /etc/apparmor.d/tunables/home ; ils doivent se   │   
   │ terminer par un « / ».                                                                                                      │   
   │                                                                                                                             │   
   │ Exemple : si les répertoires des utilisateurs sont stockés dans /srv/nfs/home et /mnt/homes, vous devriez entrer «          │   
   │ /srv/nfs/home/ /mnt/homes/ ».                                                                                               │   
   │                                                                                                                             │   
   │ Emplacement du répertoire personnel supplémentaire :                                                                        │   
   │                                                                                                                             │   
   │ /home/example/                                                                                                              │   
   │                                                                                                                             │   
   │                                                           &lt;Ok&gt;                                                              │   
   │                                                                                                                             │   
   └─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘   </pre>

<p>
Ceci va modifier le fichier <em>/etc/apparmor.d/tunables/home.d/ubuntu</em>
</p>
<dl class="file">
<dt><a href="/_export/code/tutoriel/samba_ad_dc_members?codeblock=54" title="Télécharger cet extrait" class="mediafile mf_d_ubuntu">/etc/apparmor.d/tunables/home.d/ubuntu</a></dt>
<dd><pre class="file">@{HOMEDIRS}+=/home/example/</pre>
</dd></dl>

</div>
<div class='secedit editbutton_section editbutton_22'><form class="button btn_secedit form-inline" method="post" action="/tutoriel/samba_ad_dc_members"><div class="no"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="1531773927" /><input type="hidden" name="summary" value="[AppArmor] " /><input type="hidden" name="target" value="section" /><input type="hidden" name="hid" value="apparmor" /><input type="hidden" name="codeblockOffset" value="52" /><input type="hidden" name="range" value="26173-29150" /><button type="submit" title="AppArmor" class=" btn btn-default btn btn-xs btn-default">Modifier</button></div></form></div>
<h3 class="sectionedit23" id="policy-kit">Policy-Kit</h3>
<div class="level3">

<p>
Les droits d&#039;administration pour PolicyKit sont définis par les fichiers dans <em>/etc/polkit-1/localauthority.conf.d</em>. Par défaut dans ce répertoire, il existe déjà 2 fichiers <em>50-localauthority.conf</em> et <em>51-ubuntu-admin.conf</em>. Ces deux fichiers définissent le même paramètre de configuration <em>AdminIdentities</em>, les identités des administrateurs. Le fichier ayant le plus grand nombre écrase les paramètres identiques définis par les fichiers ayant un nombre inférieure. Ainsi par défaut sous Ubuntu, c&#039;est le fichier <em>51-ubuntu-admin.conf</em> qui sera utilisé pour définir les identités des administrateurs. Pour redéfinir ces identités d&#039;administration, il est recommandé de créer un nouveau fichier car les fichiers existant pourraient être automatiquement modifiés lors d&#039;une mise à jour. Ce nouveau fichier doit alors avoir un nombre supérieur à 51.
</p>

<p>
Par exemple, pour ne donner les droits qu&#039;aux administrateurs du domaine
</p>
<dl class="file">
<dt><a href="/_export/code/tutoriel/samba_ad_dc_members?codeblock=55" title="Télécharger cet extrait" class="mediafile mf_conf">/etc/polkit-1/localauthority.conf.d/60-example.com-admin.conf</a></dt>
<dd><pre class="file">[Configuration]
AdminIdentities=unix-group:Domain Admins</pre>
</dd></dl>

<p>
<em class="u">Ou</em> pour donner les droits aux administrateurs du domaine et aux administrateurs locaux (environnement mixte)
</p>
<dl class="file">
<dt><a href="/_export/code/tutoriel/samba_ad_dc_members?codeblock=56" title="Télécharger cet extrait" class="mediafile mf_conf">/etc/polkit-1/localauthority.conf.d/60-example.com-admin.conf</a></dt>
<dd><pre class="file">[Configuration]
AdminIdentities=unix-group:Domain Admins;unix-group:sudo;unix-group:admin</pre>
</dd></dl>

</div>
<div class='secedit editbutton_section editbutton_23'><form class="button btn_secedit form-inline" method="post" action="/tutoriel/samba_ad_dc_members"><div class="no"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="1531773927" /><input type="hidden" name="summary" value="[Policy-Kit] " /><input type="hidden" name="target" value="section" /><input type="hidden" name="hid" value="policy-kit" /><input type="hidden" name="codeblockOffset" value="55" /><input type="hidden" name="range" value="29151-30551" /><button type="submit" title="Policy-Kit" class=" btn btn-default btn btn-xs btn-default">Modifier</button></div></form></div>
<h3 class="sectionedit24" id="mise_en_correspondance_des_groupes">Mise en correspondance des groupes</h3>
<div class="level3">

<p>
Les utilisateurs du domaine peuvent être directement ajoutés aux groupes Unix locaux mais la tâche serait fastidieuse et ingérable dans un domaine comportant un grand nombre de machine et d&#039;utilisateur. Pour ce faire, il est possible de mettre en correspondance un groupe Samba local avec un groupe Unix local et d&#039;ajouter un ou des groupes ou utilisateurs du domaine à ce groupe Samba local. Ainsi, les utilisateurs du domaine peuvent devenir membre des groupes Unix locaux.
</p>

<p>
Voici un exemple plus parlant:
</p>
<ul class=" fix-media-list-overlap">
<li class="level1"><div class="li"> Considérons l&#039;utilisateur du domaine <em>Administrator</em> membre du groupe du domaine <em>Domain Admins</em>. Supposons qu&#039;il veuille lire les fichiers log (auth.log, syslog) d&#039;une machine linux membre du domaine. Cette action est tout à fait normale. Cependant, par défaut, cet utilisateur n&#039;est pas membre du groupe Unix local <em>adm</em>. Il ne pourrait donc pas les lire ces fichiers sauf si les droits <em>sudo</em> lui ont été octroyés comme expliqué ci-dessus. L&#039;alternative serait de le mettre automatiquement dans le groupe Unix local <em>adm</em>.</div>
</li>
</ul>

<p>
Pour ce faire, il faut créer une correspondance entre le group Unix local <em>adm</em> et un groupe Samba local avec la commande suivante:
</p>
<pre class="code">sudo net groupmap add unixgroup=adm type=local
No rid or sid specified, choosing a RID
Got RID 1001
Successfully added group adm to the mapping db as a alias (local) group</pre>

<p>
Premièrement, il est possible de définir manuellement le RID du group Samba local. Quel intérêt ? Deuxièment, il est également possible de définir le nom du groupe Samba local. Par défaut, ce dernier prend le même nom que le groupe Unix local.
</p>

<p>
Finalement, il faut ajouter le groupe du domaine <em>Domain Admins</em> (ou l&#039;utilisateur <em>Administrator</em>) au groupe Samba local. Cependant, la commande qui va ajouter le groupe ou l&#039;utilisateur du domaine utilise les SID de ceux-ci ainsi que le SID du groupe local. Les commandes qui suivent vont premièrement afficher le SID du groupe local <em>adm</em>, deuxièment afficher le SID du groupe du domaine <em>Domain Admin</em> et finalement rendre le second membre du premier.
</p>
<pre class="code">sudo net groupmap list ntgroup=adm
adm (S-1-5-21-1757501545-3173013020-1010731404-1001) -&gt; adm

wbinfo -n &quot;Domain Admins&quot;
S-1-5-21-118621575-641544407-1507140581-512 SID_DOM_GROUP (2)

sudo net groupmap addmem S-1-5-21-1757501545-3173013020-1010731404-1001 S-1-5-21-118621575-641544407-1507140581-512</pre>

<p>
Quelques commandes pour vérifier
</p>
<ul class=" fix-media-list-overlap">
<li class="level1"><div class="li"> Pour lister les groupes Samba locaux</div>
</li>
</ul>
<pre class="code">sudo net groupmap list verbose
adm
        SID       : S-1-5-21-1757501545-3173013020-1010731404-1001
        Unix gid  : 4
        Unix group: adm
        Group type: Local Group
        Comment   : Local Unix group
Administrators
        SID       : S-1-5-32-544
        Unix gid  : 40000
        Unix group: BUILTIN\administrators
        Group type: Local Group
        Comment   : 
Users
        SID       : S-1-5-32-545
        Unix gid  : 40001
        Unix group: BUILTIN\users
        Group type: Local Group
        Comment   : </pre>

<p>
On remarque que par défaut, il existe 2 groupes locaux <em>BUILTIN</em>, Administrators et Users, dont les groupes du domaine <em>Domain Admins</em> et <em>Domain Users</em> sont respectivement membres.
</p>
<ul class=" fix-media-list-overlap">
<li class="level1"><div class="li"> Pour lister les groupes du domaine membres d&#039;un groupe Samba local</div>
</li>
</ul>
<pre class="code">sudo net groupmap listmem S-1-5-21-1757501545-3173013020-1010731404-1001
S-1-5-21-118621575-641544407-1507140581-512</pre>
<ul class=" fix-media-list-overlap">
<li class="level1"><div class="li"> Pour résoudre cet SID en nom</div>
</li>
</ul>
<pre class="code">wbinfo -s S-1-5-21-118621575-641544407-1507140581-512
EXAMPLE\Domain Admins 2</pre>

<p>
Le code qui suit représente le type de l&#039;objet: 1 pour un utilisateur, 2 pour un groupe.
</p>
<div class="notetip">Essentiellement après avoir supprimé des groupes Samba locaux, il faut vider le cache de IDMAP pour que cette suppression soit immédiatement effective.
<pre class="code">sudo net cache flush</pre>

</div><div class="noteclassic">La mise en correspondance des groupes du domaine avec les groupes Unix locaux est une méthode plus simple et plus efficace que de réaliser de multiples modifications des droits pour les donner aux utilisateurs du domaine. Ceci peut donc rendre inutile la modification précédente concernant Policy-Kit. Il serait également possible de ne pas réaliser la modification concernant <em>sudo</em>. Cependant, si la correspondance des groupes vient à être perdue, l&#039;administrateur du domaine ne pourrait plus corriger la situation. Cette raison peut donc justifier le fait de conserver cette modification.
</div>
</div>
<div class='secedit editbutton_section editbutton_24'><form class="button btn_secedit form-inline" method="post" action="/tutoriel/samba_ad_dc_members"><div class="no"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="1531773927" /><input type="hidden" name="summary" value="[Mise en correspondance des groupes] " /><input type="hidden" name="target" value="section" /><input type="hidden" name="hid" value="mise_en_correspondance_des_groupes" /><input type="hidden" name="codeblockOffset" value="57" /><input type="hidden" name="range" value="30552-35075" /><button type="submit" title="Mise en correspondance des groupes" class=" btn btn-default btn btn-xs btn-default">Modifier</button></div></form></div>
<h3 class="sectionedit25" id="smb4k">smb4k</h3>
<div class="level3">

<p>
Se référer à <a href="/smb4k" class="wikilink1" title="smb4k">Monter des partages Windows sous KDE</a>.
</p>

<p>
Dans <em>smb4k</em>, il existe l&#039;option <em>Essayer de s&#039;authentifier avec Kerberos</em> de l&#039;onglet <em>Paramètres généraux</em> dans <em>Configuration Smb4k / Samba</em> qui sert lors de l&#039;authentification de l&#039;utilisateur vis-à-vis du serveur de fichier distant. Cependant, il faut utiliser l&#039;option avancée <em>Mode de sécurité</em> de l&#039;onglet <em>Montage</em> dans <em>Configuration Smb4k / Samba</em> et choisir <em>Kerberos 5 authentication</em>. Cette option permet de monter un partage Windows (CIFS) à partir du ticket Kerberos de l&#039;utilisateur reçu lors de son login. Elle correspond exactement à l&#039;option sec=krb5 de <em>mount.cifs</em>.
</p>

<p>
Ceci reviendrait à exécuter la commande :
</p>
<pre class="code">sudo mount.cifs //server/share /mnt/point -o sec=krb5</pre>

<p>
Sous Trusty (14.04), lorsque l&#039;utilisateur essaie de monter son partage ainsi, il reçoit le message d&#039;erreur : <em>&quot;Mount error (126): Required key not available. Refer to the mount.cifs(8) manual page.&quot;</em> Le problème vient de l&#039;accès au ticket Kerberos. L&#039;application <em>mount.cifs</em>, étant toujours exécutée par root via le setuid bit, cherche le ticket Kerberos de l&#039;utilisateur root et non celui de l&#039;utilisateur réel. Ne le trouvant pas, l&#039;application renvoie l&#039;erreur ci-dessus.
</p>

<p>
La solution à ce problème est de passer l&#039;option <em>cruid</em> avec la valeur UID de l&#039;utilisateur dans le champ <em>Options supplémentaires</em> de l&#039;onglet <em>Montage</em> dans <em>Configuration Smb4k / Samba</em>, par exemple <em>cruid=10000</em>. Ceci résout le problème et permet d&#039;accéder au partage.
</p>

<p>
Ceci reviendrait à exécuter la commande :
</p>
<pre class="code">sudo mount.cifs //server/share /mnt/point -o sec=krb5,cruid=$UID</pre>

<p>
Cependant, l&#039;utilisation de l&#039;option <em>cruid</em> représente une faille de sécurité qui permet à un utilisateur d&#039;encoder l&#039;UID d&#039;un autre utilisateur et ainsi d&#039;obtenir les droits de cet utilisateur (CVE-2014-2581). Actuellement, Trusty (14.04) fourni le paquet <em>smb4k</em> en v1.0.9 sans appliquer une mise à jour de sécurité concernant cette faille. A partir de la version 1.1.1, le réglage du paramètre <em>cruid</em> est refusé par l&#039;application <em>smb4k</em>. En arrière plan, l&#039;application utilise ce paramètre avec la valeur UID de l&#039;utilisateur réel. Il est donc recommandé d&#039;utiliser la v1.1.2 disponible pour Utopic (14.10) parfaitement compatible d&#039;un point de vue de ces dépendances avec Trusty (14.04).
</p>

<p>
Pour les utilisateurs de Trusty (14.04), la méthode la plus simple consiste à installer le paquet <em>smb4k</em> qui installera automatiquement les dépendances. Après, il faut désinstaller ce paquet mais pas ses dépendances. Il ne faut donc pas exécuter un <em>autoremove</em>. Et finalement, il faut télécharger le paquet depuis un dépôt officiel (attention au choix de l&#039;architecture amd64 ou i386) et l&#039;installer manuellement.
</p>
<pre class="code">sudo apt-get install smb4k
sudo apt-get remove smb4k
wget http://archive.ubuntu.com/ubuntu/pool/universe/s/smb4k/smb4k_1.1.2-1_amd64.deb
sudo dpkg -i smb4k_1.1.2-1_amd64.deb</pre>

</div>
<div class='secedit editbutton_section editbutton_25'><form class="button btn_secedit form-inline" method="post" action="/tutoriel/samba_ad_dc_members"><div class="no"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="1531773927" /><input type="hidden" name="summary" value="[smb4k] " /><input type="hidden" name="target" value="section" /><input type="hidden" name="hid" value="smb4k" /><input type="hidden" name="codeblockOffset" value="63" /><input type="hidden" name="range" value="35076-38129" /><button type="submit" title="smb4k" class=" btn btn-default btn btn-xs btn-default">Modifier</button></div></form></div>
<h2 class="sectionedit26 page-header" id="references">Références</h2>
<div class="level2">
<ul class=" fix-media-list-overlap">
<li class="level1"><div class="li"> <a href="https://wiki.samba.org/index.php/Using_RFC2307_on_a_Samba_DC" class="urlextern" title="https://wiki.samba.org/index.php/Using_RFC2307_on_a_Samba_DC" rel="nofollow">Using RFC2307 on a Samba DC</a></div>
</li>
<li class="level1"><div class="li"> <a href="https://wiki.samba.org/index.php/Setup_a_Samba_AD_Member_Server" class="urlextern" title="https://wiki.samba.org/index.php/Setup_a_Samba_AD_Member_Server" rel="nofollow">Setup a Samba AD Member Server</a></div>
</li>
<li class="level1"><div class="li"> <a href="https://help.ubuntu.com/community/ActiveDirectoryHowto" class="urlextern" title="https://help.ubuntu.com/community/ActiveDirectoryHowto" rel="nofollow">Active Directoy HowTo</a></div>
</li>
<li class="level1"><div class="li"> <a href="https://wiki.debian.org/LDAP/PAM" class="urlextern" title="https://wiki.debian.org/LDAP/PAM" rel="nofollow">Debian Wiki : LDAP/PAM</a></div>
</li>
</ul>

<p>
<em>Contributeur principal : <a href="/utilisateurs/qedinux" class="wikilink1" title="utilisateurs:qedinux">Qedinux</a></em>
</p>

</div>
<div class='secedit editbutton_section editbutton_26'><form class="button btn_secedit form-inline" method="post" action="/tutoriel/samba_ad_dc_members"><div class="no"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="1531773927" /><input type="hidden" name="summary" value="[Références] " /><input type="hidden" name="target" value="section" /><input type="hidden" name="hid" value="references" /><input type="hidden" name="codeblockOffset" value="66" /><input type="hidden" name="range" value="38130-" /><button type="submit" title="Références" class=" btn btn-default btn btn-xs btn-default">Modifier</button></div></form></div><hr/><div class="footnotes">
<div class="fn"><sup><a href="#fnt__1" id="fn__1" class="fn_bot">1)</a></sup> 
<div class="content">Fully Qualified Domain Name: Nom de machine incluant la partie domaine</div></div>
<div class="fn"><sup><a href="#fnt__2" id="fn__2" class="fn_bot">2)</a></sup> 
<div class="content"><a href="https://wiki.samba.org/index.php/Idmap_config_ad#The_RFC2307_and_template_Mode_Options" class="urlextern" title="https://wiki.samba.org/index.php/Idmap_config_ad#The_RFC2307_and_template_Mode_Options" rel="nofollow">The RFC2307 and template Mode Options</a></div></div>
</div>

</div><!-- /CONTENT --></div>
          </div>
        </div>

        <div class="small text-right">

                    <span class="docInfo">
            <ul class="list-inline"><li><i class="fa fa-fw fa-file-text-o text-muted"></i> <span title="tutoriel/samba_ad_dc_members.txt">tutoriel/samba_ad_dc_members.txt</span></li><li><i class="fa fa-fw fa-calendar text-muted"></i> Dernière modification: <span title="Le 16/07/2018, 22:45">Le 16/07/2018, 22:45</span></li><li class="text-muted">par Qedinux</li></ul>          </span>
          
          
        </div>

      </article>

      
    </main>

    <footer id="dw__footer" class="navbar navbar-default">
  <div class="container">

    <div class="small navbar-text">

            <div class="footer-dw-title row">
        <div class="media col-sm-4">
          <!--<div class="media-left">
            <img src="/_media/logo.png" alt="Wiki ubuntu-fr" class="media-object" style="width:32px" />
          </div> -->
          <div class="media-body">
            <h4 class="media-heading">Documentation ubuntu-fr</h4>
            <p>
              Les pages de cette documentation sont rédigées par les utilisateurs
              pour les utilisateurs. Apportez-nous votre aide pour améliorer
              le contenu de cette documentation.
            </p>
          </div>
        </div>
        <div class="col-sm-4">
          <h4>Liens utiles</h4>
          <ul class="list-group list-unstyled">
            <li>
              <a href="/debutant" ><i class="fa fa-fw fa-child" style="font-size: 1.3em;"></i> Débuter sur Ubuntu</a>            </li>
            <li>
              <a href="/wiki/participer_wiki" ><i class="fa fa-fw fa-edit" style="font-size: 1.3em;"></i> Participer à la documentation</a>            </li>
            <li>
              <a href="/documentation_hors_ligne" ><i class="fa fa-fw fa-book" style="font-size: 1.3em;"></i> Documentation hors ligne</a>            </li>
            <li>
              <a href="//www.ubuntu-fr.org/telechargement" ><i class="fa fa-fw fa-arrow-circle-down" style="font-size: 1.3em;"></i> Télécharger Ubuntu</a>            </li>
          </ul>
        </div>
        <div class="col-sm-4">
          <h4>Obtenir de l'aide</h4>
          <ul class="list-group list-unstyled">
            <li>
              <a href="/tutoriel/comment_obtenir_une_reponse_satisfaisante" ><i class="fa fa-fw fa-info-circle" style="font-size: 1.3em;"></i> Chercher de l'aide</a>            </li>
            <li>
              <a href="//doc.ubuntu-fr.org/" ><i class="fa fa-fw fa-book" style="font-size: 1.3em;"></i> Consulter la documentation</a>            </li>
            <li>
              <a href="//forum.ubuntu-fr.org/" ><i class="fa fa-fw fa-comments" style="font-size: 1.3em;"></i> Consulter le Forum</a>            </li>
            <li>
              <a href="//guide.ubuntu-fr.org/" ><i class="fa fa-fw fa-question-circle" style="font-size: 1.3em;"></i> Lisez le guide</a>            </li>
          </ul>
        </div>
        <p>&nbsp;</p>
      </div>
      
      
      <div class="footer-license row">

        <div class="col-sm-6">
                    <p>
            <a href="http://creativecommons.org/licenses/by-sa/3.0/deed.fr" title="CC Paternité-Partage des Conditions Initiales à l'Identique 3.0 Unported" target="" itemscope itemtype="http://schema.org/CreativeWork" itemprop="license" rel="license" class="license"><img src="/lib/tpl/bootstrap3/images/license/cc.png" width="24" height="24" alt="cc" /> <img src="/lib/tpl/bootstrap3/images/license/by.png" width="24" height="24" alt="by" /> <img src="/lib/tpl/bootstrap3/images/license/sa.png" width="24" height="24" alt="sa" /> </a>          </p>
          <p class="small">
            Sauf mention contraire, le contenu de ce wiki est placé sous les termes de la licence suivante :<br/><a href="http://creativecommons.org/licenses/by-sa/3.0/deed.fr" title="CC Paternité-Partage des Conditions Initiales à l'Identique 3.0 Unported" target="" itemscope itemtype="http://schema.org/CreativeWork" itemprop="license" rel="license" class="license">CC Paternité-Partage des Conditions Initiales à l'Identique 3.0 Unported</a>          </p>
                  </div>

        <div class="col-sm-6">
                    <ul id="dw__badges" class="list-inline text-right hidden-print">

  <li>
    <a href="https://www.dokuwiki.org/template:bootstrap3" title="Bootstrap template for DokuWiki" target="">
      <img src="/lib/tpl/bootstrap3/images/bootstrap.png" width="20" alt="Bootstrap template for DokuWiki" />
    </a>
  </li>

  <li>
    <a href="https://www.php.net" title="Powered by PHP" target="">
      <img src="/lib/tpl/bootstrap3/images/php.png" width="20" alt="Powered by PHP" />
    </a>
  </li>

  <li>
    <a href="http://validator.w3.org/check/referer" title="Valid HTML5" target="">
      <img src="/lib/tpl/bootstrap3/images/html5.png" width="20" alt="Valid HTML5" />
    </a>
  </li>

  <li>
    <a href="http://jigsaw.w3.org/css-validator/check/referer?profile=css3" title="Valid CSS" target="">
      <img src="/lib/tpl/bootstrap3/images/css3.png" width="20" alt="Valid CSS" />
    </a>
  </li>

  <li>
    <a href="https://www.dokuwiki.org/" title="Driven by DokuWiki" target="">
      <img src="/lib/tpl/bootstrap3/images/logo.png" width="20" alt="Driven by DokuWiki" />
    </a>
  </li>

</ul>
                  </div>

      </div>

    </div>

  </div>
</footer>
<img src="/lib/exe/indexer.php?id=tutoriel%3Asamba_ad_dc_members&amp;1635535289" width="2" height="1" alt="" />
    <a href="#dokuwiki__top" class="back-to-top hidden-print btn btn-default btn-sm" title="Aller au contenu" accesskey="t"><i class="fa fa-chevron-up"></i></a>

    <div id="screen__mode">      <span class="visible-xs-block"></span>
      <span class="visible-sm-block"></span>
      <span class="visible-md-block"></span>
      <span class="visible-lg-block"></span>
    </div>

  </div>

    <!-- Piwik -->
		<script type="text/javascript">
		  var _paq = _paq || [];
		  _paq.push(["setDomains", ["*.doc.ubuntu-fr.org","*.doc.edubuntu-fr.org","*.doc.lubuntu-fr.org","*.doc.xubuntu-fr.org","*.doc.edubuntu-fr.org","*.doc.lubuntu-fr.org","*.doc.ubuntu-fr.org","*.doc.xubuntu-fr.org"]]);
		  _paq.push(['trackPageView']);
		  _paq.push(['enableLinkTracking']);
		  (function() {
		    var u="//piwik.ubuntu-fr.org/";
		    _paq.push(['setTrackerUrl', u+'piwik.php']);
		    _paq.push(['setSiteId', 3]);
		    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
		    g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'piwik.js'; s.parentNode.insertBefore(g,s);
		  })();
		</script>
		<noscript><p><img src="//piwik.ubuntu-fr.org/piwik.php?idsite=3" style="border:0;" alt="" /></p></noscript>
		<!-- End Piwik Code -->

</body>
</html>
