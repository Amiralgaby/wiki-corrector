<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="fr"
  lang="fr" dir="ltr" class="no-js">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>postfix_mysql_tls_sasl [Wiki ubuntu-fr]</title>
  <script>(function(H){H.className=H.className.replace(/\bno-js\b/,'js')})(document.documentElement)</script>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="shortcut icon" href="/_media/favicon.ico" />
<link rel="apple-touch-icon" href="/lib/tpl/bootstrap3/images/apple-touch-icon.png" />
    <meta name="generator" content="DokuWiki"/>
<meta name="robots" content="index,follow"/>
<meta name="keywords" content="serveur"/>
<link type="text/css" rel="stylesheet" href="/lib/tpl/bootstrap3/assets/fonts/united.fonts.css"/>
<link type="text/css" rel="stylesheet" href="/lib/tpl/bootstrap3/assets/font-awesome/css/font-awesome.min.css"/>
<link type="text/css" rel="stylesheet" href="/lib/tpl/bootstrap3/assets/bootstrap/united/bootstrap.min.css"/>
<link rel="search" type="application/opensearchdescription+xml" href="/lib/exe/opensearch.php" title="Wiki ubuntu-fr"/>
<link rel="start" href="/"/>
<link rel="contents" href="/postfix_mysql_tls_sasl?do=index" title="Plan du site"/>
<link rel="manifest" href="/lib/exe/manifest.php"/>
<link rel="alternate" type="application/rss+xml" title="Derniers changements" href="/feed.php"/>
<link rel="alternate" type="application/rss+xml" title="Catégorie courante" href="/feed.php?mode=list&amp;ns="/>
<link rel="edit" title="Modifier cette page" href="/postfix_mysql_tls_sasl?do=edit"/>
<link rel="alternate" type="text/html" title="HTML brut" href="/_export/xhtml/postfix_mysql_tls_sasl"/>
<link rel="alternate" type="text/plain" title="Wiki balise" href="/_export/raw/postfix_mysql_tls_sasl"/>
<link rel="canonical" href="http://doc.ubuntu-fr.org/postfix_mysql_tls_sasl"/>
<link rel="stylesheet" type="text/css" href="/lib/exe/css.php?t=bootstrap3&amp;tseed=b4a19b95bb4d08daf02b6dd52d7e6abc"/>
<!--[if gte IE 9]><!-->
<script type="text/javascript">/*<![CDATA[*/var NS='';var JSINFO = {"bootstrap3":{"mode":"show","toc":[],"config":{"collapsibleSections":0,"fixedTopNavbar":1,"showSemanticPopup":0,"sidebarOnNavbar":0,"tagsOnTop":1,"tocAffix":1,"tocCollapseOnScroll":1,"tocCollapsed":0,"tocLayout":"default","useAnchorJS":1}},"id":"postfix_mysql_tls_sasl","namespace":"","ACT":"show","useHeadingNavigation":0,"useHeadingContent":0};
/*!]]>*/</script>
<script type="text/javascript" charset="utf-8" src="/lib/exe/jquery.php?tseed=23f888679b4f1dc26eef34902aca964f"></script>
<script type="text/javascript" charset="utf-8" src="/lib/exe/js.php?t=bootstrap3&amp;tseed=b4a19b95bb4d08daf02b6dd52d7e6abc"></script>
<script type="text/javascript" src="/lib/tpl/bootstrap3/assets/bootstrap/js/bootstrap.min.js"></script>
<script type="text/javascript" src="/lib/tpl/bootstrap3/assets/anchorjs/anchor.min.js"></script>
<script type="text/javascript" src="/lib/tpl/bootstrap3/assets/typeahead/bootstrap3-typeahead.min.js"></script>
<!--<![endif]-->
<style type="text/css">@media screen { body { margin-top: 70px; }  #dw__toc.affix { top: 60px; position: fixed !important; }  #dw__toc .nav .nav .nav { display: none; } }</style>
    <!--[if lt IE 9]>
  <script type="text/javascript" src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
  <script type="text/javascript" src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
  <![endif]-->
</head>
<body class="united dokuwiki mode_show tpl_bootstrap3 dw-page-on-panel" data-page-id="postfix_mysql_tls_sasl">

  <header id="dokuwiki__header" class="dokuwiki container">
    <nav id="dw__navbar" class="navbar navbar-fixed-top navbar-default" role="navigation">

  <div class="container">

    <div class="navbar-header">

      <button class="navbar-toggle" type="button" data-toggle="collapse" data-target=".navbar-collapse">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>

      <a href="/accueil"  accesskey="h" title="[H]" class="navbar-brand"><span class="uf uf-cof" id="dw__accueil" style="font-size: 35px;" ></span> <span id="dw__title" style="margin-top:-5px">Wiki ubuntu-fr<span id="dw__tagline">La Documentation francophone</span></span></a>
    </div>

    <div class="collapse navbar-collapse">

      
      <ul class="nav navbar-nav">
        <li>
          <a href="//ubuntu-fr.org/" ><i class="fa fa-2x fa-fw fa-home"></i><span> Accueil</span></a>        </li>
        <li>
          <a href="//forum.ubuntu-fr.org/" ><i class="fa fa-2x fa-fw fa-comments"></i><span> Forum</span></a>        </li>
        <li>
          <a href="//planet.ubuntu-fr.org/" ><i class="fa fa-2x fa-fw fa-globe"></i><span> Planet</span></a>        </li>
      </ul>

            
      
      <div class="navbar-right" id="dw__navbar_items">

        <form action="//forum.ubuntu-fr.org/search_ubuntufr.php" accept-charset="utf-8" class="navbar-form navbar-left search" id="dw__search" method="get" role="search"><div class="no"><input id="qsearch" autocomplete="off" type="search" placeholder="Rechercher" accesskey="f" name="q" class="form-control" title="[F]" /><button type="submit" title="Rechercher"><i class="fa fa-fw fa-search"></i></button><input type="hidden" name="do" value="search" /><input type="hidden" name="tsearch" value="wiki" /></div></form>
        
<ul class="nav navbar-nav dw-action-icon" id="dw__tools">


  <li class="dropdown">

    <a href="" class="dropdown-toggle" data-target="#" data-toggle="dropdown" title="" role="button" aria-haspopup="true" aria-expanded="false">
      <i class="fa fa-2x fa-fw fa-wrench"></i> <span class="hidden-lg hidden-md hidden-sm">Outils</span> <span class="caret"></span>
    </a>

    <ul class="dropdown-menu tools" role="menu">
    
      <li class="dropdown-header">
        <i class="fa fa-fw fa-cubes"></i> Outils du site      </li>
      <li><a href="/postfix_mysql_tls_sasl?do=recent"  class="action recent" accesskey="r" rel="nofollow" title="Derniers changements [R]">Derniers changements</a></li><li><a href="/postfix_mysql_tls_sasl?do=media&amp;ns="  class="action media" rel="nofollow" title="Gestionnaire Multimédia">Gestionnaire Multimédia</a></li><li><a href="/postfix_mysql_tls_sasl?do=index"  class="action index" accesskey="x" rel="nofollow" title="Plan du site [X]">Plan du site</a></li>
            <li class="divider" role="separator"></li>
      
    
      <li class="dropdown-header">
        <i class="fa fa-fw fa-file"></i> Outils de la page      </li>
      <li><a href="/postfix_mysql_tls_sasl?do=edit"  class="action edit" accesskey="e" rel="nofollow" title="Modifier cette page [E]">Modifier cette page</a></li><li><a href="/postfix_mysql_tls_sasl?do=revisions"  class="action revs" accesskey="o" rel="nofollow" title="Anciennes révisions [O]">Anciennes révisions</a></li><li><a href="/postfix_mysql_tls_sasl?do=backlink"  class="action backlink" rel="nofollow" title="Liens de retour">Liens de retour</a></li><li><a href="#dokuwiki__top"  class="action top" accesskey="t" rel="nofollow" title="Haut de page [T]">Haut de page</a></li>
      
        </ul>
  </li>


</ul>


        <ul class="nav navbar-nav">

          
          
                    <li>
            <span class="dw__actions dw-action-icon">
              <a href="/postfix_mysql_tls_sasl?do=login&amp;sectok="  class="action btn btn-default navbar-btn login" rel="nofollow" title="S&#039;identifier"><span class="">S'identifier</span></a>            </span>
          </li>
          
        </ul>

        
        

      </div>

    </div>
  </div>
</nav>
  </header>

  <div id="dokuwiki__top" class="dokuwiki container">

    <div id="dokuwiki__pageheader">

      
      
      <p class="pageId text-right small">
        <span class="label label-primary">postfix_mysql_tls_sasl</span>      </p>

      <div id="dw__msgarea" class="small">
              </div>

    </div>

    <main class="main row" role="main">

      
      <article id="dokuwiki__content" class="container" itemscope itemtype="http://schema.org/Article" itemref="dw__license">

        
<nav id="dw__pagetools" class="hidden-print">
  <div class="tools panel panel-default pull-right ">
    <ul class="nav nav-stacked nav-pills">
      <li><a href="/postfix_mysql_tls_sasl?do=edit"  class="action text-muted edit" accesskey="e" rel="nofollow" title="Modifier cette page [E]"><i class="fa fa-fw fa-pencil-square-o"></i><span class="sr-only"> Modifier cette page</span></a></li><li><a href="/postfix_mysql_tls_sasl?do=revisions"  class="action text-muted revs" accesskey="o" rel="nofollow" title="Anciennes révisions [O]"><i class="fa fa-fw fa-clock-o"></i><span class="sr-only"> </span></a></li><li><a href="/postfix_mysql_tls_sasl?do=backlink"  class="action text-muted backlink" rel="nofollow" title="Liens de retour"><i class="fa fa-fw fa-link"></i><span class="sr-only"> Liens de retour</span></a></li>    </ul>
  </div>
</nav>

        <div class="panel panel-default" itemprop="articleBody">
          <div class="page panel-body">

            <div class="dw-content-page "><div class="dw-toc hidden-print"><script>JSINFO.bootstrap3.toc = [{"link":"#premiere_partie","title":"Premi\u00e8re partie","level":1},{"link":"#postfix","title":"Postfix","level":2},{"link":"#tls_imap_tls","title":"TLS (Imap TLS)","level":2},{"link":"#sasl","title":"SASL","level":2},{"link":"#courier_mtapop3_imap","title":"Courier (MTA: Pop3, IMAP)","level":2},{"link":"#deuxieme_partie","title":"Deuxi\u00e8me Partie","level":1},{"link":"#amavis","title":"Amavis","level":2},{"link":"#spamassassin","title":"Spamassassin","level":2},{"link":"#creation_des_utilisateursdomaines","title":"Cr\u00e9ation des utilisateurs\/domaines","level":1},{"link":"#creation_du_repertoire_de_stockage_des_mails","title":"Cr\u00e9ation du r\u00e9pertoire de stockage des mails","level":1},{"link":"#en_cas_d_erreurs","title":"En cas d'erreurs","level":1}];</script>
<!-- TOC START -->
<nav id="dw__toc" role="navigation" class="toc-panel panel panel-default small">
<h6 data-toggle="collapse" data-target="#dw__toc .toc-body" title="Table des matières" class="panel-heading toc-title"><i class="fa fa-fw fa-th-list"></i> <span>Table des matières</span> <i class="caret"></i></h6>
<div class="panel-body  toc-body collapse in">

<ul class="nav toc">
<li class="level1"><a href="#premiere_partie">Première partie</a>
<ul class="nav toc">
<li class="level2"><a href="#postfix">Postfix</a></li>
<li class="level2"><a href="#tls_imap_tls">TLS (Imap TLS)</a></li>
<li class="level2"><a href="#sasl">SASL</a></li>
<li class="level2"><a href="#courier_mtapop3_imap">Courier (MTA: Pop3, IMAP)</a></li>
</ul>
</li>
<li class="level1"><a href="#deuxieme_partie">Deuxième Partie</a>
<ul class="nav toc">
<li class="level2"><a href="#amavis">Amavis</a></li>
<li class="level2"><a href="#spamassassin">Spamassassin</a></li>
</ul>
</li>
<li class="level1"><a href="#creation_des_utilisateursdomaines">Création des utilisateurs/domaines</a></li>
<li class="level1"><a href="#creation_du_repertoire_de_stockage_des_mails">Création du répertoire de stockage des mails</a></li>
<li class="level1"><a href="#en_cas_d_erreurs">En cas d&#039;erreurs</a></li>
</ul>

</div>
</nav>
<!-- TOC END -->
</div><!-- CONTENT --><div class="dw-content"><div class="tags"><span>
	<a href="/serveur" class="wikilink1" title="serveur" rel="tag">serveur</a>
</span></div>
<hr />

<h1 class="sectionedit1 page-header" id="installation_de_postfix_avec_tls_sasl_mysql_clamav_spamassassin">Installation de Postfix avec TLS, SASL, MySQL, Clamav, SpamAssassin</h1>
<div class="level1">

<p>
Ce tuto a été réalisé sur une Debian Etch. Il est compatible pour Ubuntu.
La mise en place d&#039;une telle solution demande du temps ainsi qu&#039;un certain niveau pour savoir étudier les logs s&#039;il y a une erreur.
</p>
<div class="noteclassic">note du 15 mars 2014 : Ce tuto nécesssite d&#039;être revu du fait de l&#039;obsolescence de certains paquets
</div>
<p>
Niveau confirmé.
Temps d&#039;application : une bonne demi-heure.
</p>

<p>
<a href="http://www.postfix.org/" class="urlextern" title="http://www.postfix.org/" rel="nofollow">Postfix</a> est un mta (Mail Transfer Agent, simple d&#039;utilisation contrairement à Sendmail ou bien qmail. Postfix est utilisé par défaut chez Mac <abbr title="Operating System">OS</abbr> X, disponible sur <abbr title="GNU&#039;s Not Unix">GNU</abbr>/Linux, la famille <abbr title="Berkeley Software Distribution">BSD</abbr> et d&#039;autres unix encore. 
</p>

<p>
Ce tuto vous permettra de mettre en place une solution multi-domaine basée sur des utilisateurs et domaines virtuels, couplée avec MySQL. Postfix peut être couplé a <abbr title="Lightweight Directory Access Protocol">LDAP</abbr> et ProgresSQL.
</p>

<p>
Le tuto n&#039;est pas tout à fait finalisé, mais il est opérationnel. Je n&#039;utilise pas la commande sudo, je travaille directement sous root, c&#039;est moins prise de tête que taper sudo devant chaque commande. Pour travailler sous le compte root, faite un sudo -i puis votre mot de passe habituel.
</p>

</div>
<div class='secedit editbutton_section editbutton_1'><form class="button btn_secedit form-inline" method="post" action="/postfix_mysql_tls_sasl"><div class="no"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="1429912807" /><input type="hidden" name="summary" value="[Installation de Postfix avec TLS, SASL, MySQL, Clamav, SpamAssassin] " /><input type="hidden" name="target" value="section" /><input type="hidden" name="hid" value="installation_de_postfix_avec_tls_sasl_mysql_clamav_spamassassin" /><input type="hidden" name="codeblockOffset" value="0" /><input type="hidden" name="range" value="25-1232" /><button type="submit" title="Installation de Postfix avec TLS, SASL, MySQL, Clamav, SpamAssassin" class=" btn btn-default btn btn-xs btn-default">Modifier</button></div></form></div>
<h2 class="sectionedit2 page-header" id="premiere_partie">Première partie</h2>
<div class="level2">

<p>
Paquets principaux <a href="/tutoriel/comment_installer_un_paquet" class="wikilink1" title="tutoriel:comment_installer_un_paquet">à installer</a> : <strong>postfix postfix-mysql mysql-client-5.0 mysql-server-5.0 courier-authdaemon courier-authlib-mysql courier-pop courier-pop-ssl  courier-imap courier-imap-ssl postfix-tls libsasl2-2 libsasl2-modules libsasl2-modules-sql sasl2-bin libpam-mysql openssl phpmyadmin</strong>
</p>
<div class="notewarning">postfix-tls est un paquet obsolète il semble faire partie de postfix 
</div><div class="noteclassic">je préfère mettre mysql-client mysql-server (sans préciser la version) pour réussir l&#039;installation à tous les coups
</div><div class="notetip">Chez moi, le package courier-authlib-mysql s&#039;appelle courier-authmysql
</div>
<p>
Si c&#039;est la 1ère fois que vous installez MySQL, définissez un mot de passe pour le root
</p>
<pre class="code">mysqladmin -u root password &#039;motdepasse&#039;</pre>

<p>
Si jamais le mot de passe root ne peut être changé voici une petite procédure pour pouvoir le faire:<br/>

</p>
<pre class="code">/etc/init.d/mysql stop
rm -Rf /var/lib/mysql/*
mysql_install_db
/etc/init.d/mysql start
mysqladmin -u root password &#039;xxxxxxxx&#039;</pre>

</div>
<div class='secedit editbutton_section editbutton_2'><form class="button btn_secedit form-inline" method="post" action="/postfix_mysql_tls_sasl"><div class="no"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="1429912807" /><input type="hidden" name="summary" value="[Première partie] " /><input type="hidden" name="target" value="section" /><input type="hidden" name="hid" value="premiere_partie" /><input type="hidden" name="codeblockOffset" value="0" /><input type="hidden" name="range" value="1233-2304" /><button type="submit" title="Première partie" class=" btn btn-default btn btn-xs btn-default">Modifier</button></div></form></div>
<h3 class="sectionedit3" id="postfix">Postfix</h3>
<div class="level3">

<p>
Création de la base de donnée nommée postfix
</p>
<pre class="code">mysqladmin -u root --password=&#039;motdepasse&#039; create postfix</pre>

<p>
Création de l&#039;utilisateur postfix
</p>
<pre class="code">$ mysql -u root -p
Enter password:
GRANT ALL PRIVILEGES ON postfix.* TO &quot;postfix&quot;@&quot;localhost&quot; IDENTIFIED BY &#039;motdepasse&#039;;</pre>

<p>
Insertion des tables dans la base de données 
</p>
<pre class="code">USE postfix;
CREATE TABLE `alias` (
`address` varchar(255) NOT NULL default &#039;&#039;,
`goto` text NOT NULL,
`domain` varchar(255) NOT NULL default &#039;&#039;,
`created` datetime NOT NULL default &#039;0000-00-00 00:00:00&#039;,
`modified` datetime NOT NULL default &#039;0000-00-00 00:00:00&#039;,
`active` tinyint(1) NOT NULL default &#039;1&#039;,
PRIMARY KEY  (address)
) ENGINE=MyISAM COMMENT=&#039;Postfix Admin - Virtual Aliases&#039;;</pre>
<pre class="code">USE postfix;
CREATE TABLE `domain` (
`domain` varchar(255) NOT NULL default &#039;&#039;,
`description` varchar(255) NOT NULL default &#039;&#039;,
`aliases` int(10) NOT NULL default &#039;0&#039;,
`mailboxes` int(10) NOT NULL default &#039;0&#039;,
`maxquota` int(10) NOT NULL default &#039;0&#039;,
`transport` varchar(255) default NULL,
`backupmx` tinyint(1) NOT NULL default &#039;0&#039;,
`created` datetime NOT NULL default &#039;0000-00-00 00:00:00&#039;,
`modified` datetime NOT NULL default &#039;0000-00-00 00:00:00&#039;,
`active` tinyint(1) NOT NULL default &#039;1&#039;,
PRIMARY KEY  (domain)
) ENGINE=MyISAM COMMENT=&#039;Postfix Admin - Virtual Domains&#039;;</pre>
<pre class="code">USE postfix;
CREATE TABLE `mailbox` (
`username` varchar(255) NOT NULL default &#039;&#039;,
`password` varchar(255) NOT NULL default &#039;&#039;,
`name` varchar(255) NOT NULL default &#039;&#039;,
`maildir` varchar(255) NOT NULL default &#039;&#039;,
`quota` int(10) NOT NULL default &#039;0&#039;,
`domain` varchar(255) NOT NULL default &#039;&#039;,
`created` datetime NOT NULL default &#039;0000-00-00 00:00:00&#039;,
`modified` datetime NOT NULL default &#039;0000-00-00 00:00:00&#039;,
`active` tinyint(1) NOT NULL default &#039;1&#039;,
PRIMARY KEY  (username)
) ENGINE=MyISAM COMMENT=&#039;Postfix Admin - Virtual Mailboxes&#039;;</pre>
<pre class="code">quit;</pre>

<p>
On crée un dossier nommé vmail. Ce dossier regroupera les boîtes mail des utilisateurs. 
</p>
<pre class="code"> $ groupadd -g 5000 vmail
 $ useradd -g vmail -u 5000 vmail -d /home/vmail -m</pre>

<p>
On ajoute dans /etc/postfix/main.cf en fin de fichier
</p>
<pre class="code"># Support Mysql
virtual_alias_maps = mysql:/etc/postfix/mysql_virtual_alias_maps.cf
virtual_gid_maps = static:5000
virtual_mailbox_base = /home/vmail
virtual_mailbox_domains = mysql:/etc/postfix/mysql_virtual_domains_maps.cf
virtual_mailbox_limit = 51200000
virtual_mailbox_maps = mysql:/etc/postfix/mysql_virtual_mailbox_maps.cf
virtual_minimum_uid = 5000
virtual_transport = virtual
virtual_uid_maps = static:5000
# Support du quota
virtual_create_maildirsize = yes
virtual_mailbox_extended = yes
virtual_mailbox_limit_maps = mysql:/etc/postfix/mysql_virtual_mailbox_limit_maps.cf
virtual_mailbox_limit_override = yes
virtual_maildir_limit_message = Desole, la boite email de l&#039;utilisateur est pleine, essayez plus tard.
virtual_overquota_bounce = yes
# Suport du relay
#relay_domains = mysql:/etc/postfix/mysql_relay_domains_maps.cf</pre>

<p>
Le smtp de postfix est chrooté, il faut donc le retirer afin d&#039;assurer son bon fonctionnement. On retire le chroot dans /etc/postfix/master.cf et modifier comme dessous.
</p>
<pre class="code">#
# Postfix master process configuration file.  For details on the format
# of the file, see the Postfix master(5) manual page.
#
# ==========================================================================
# service type  private unpriv  chroot  wakeup  maxproc command + args
#               (yes)   (yes)   (yes)   (never) (100)
# ==========================================================================
smtp      inet  n       -       n       -       -       smtpd
cleanup   unix  n       -       n       -       0       cleanup
rewrite   unix  -       -       n       -       -       trivial-rewrite</pre>

<p>
On va désormais créer les fichiers de configuration de postfix pour MySQL. Dans /etc/postfix, créer les fichiers suivants, tout en modifiant le mot de passe.
</p>
<div class="notetip">Pour aller plus vite, ne modifiez pas le mot de passe et copier-coller tels quels les fichiers. Une fois terminé, lancez la ligne de commande suivante en prenant soin de remplacer VOTREMOTDEPASSE par le bon. Tous les fichiers seront alors modifié en même temps, vous limiterez ainsi les erreurs <img src="/lib/images/smileys/icon_wink.gif" class="icon" alt=";-)" /> :
<p>
$ <code>sed -i &#039;s/motdepasse/VOTREMOTDEPASSE/&#039; /etc/postfix/mysql_*.cf</code>
</p>

<p>
Cela peut également vous servir le jour où vous désirez modifier le mot de passe…
</p>

</div>
<p>
Creation des fichiers : mysql_virtual_alias_maps.cf, mysql_virtual_domains_maps.cf, mysql_virtual_mailbox_maps.cf, mysql_virtual_mailbox_limit_maps.cf, mysql_relay_domains_maps.cf
</p>
<pre class="code">MYSQL_USER=postfix
MYSQL_PASSWORD=motdepasse
MYSQL_HOST=127.0.0.1

cat &lt;&lt; EOF &gt;/etc/postfix/mysql_virtual_alias_maps.cf
user = $MYSQL_USER
password = $MYSQL_PASSWORD
hosts = $MYSQL_HOST
dbname = postfix
query = SELECT goto FROM alias WHERE address=&#039;%s&#039; AND active = 1
EOF

cat &lt;&lt;EOF &gt;/etc/postfix/mysql_virtual_domains_maps.cf
user = $MYSQL_USER
password = $MYSQL_PASSWORD
hosts = $MYSQL_HOST
dbname = postfix
query = SELECT domain FROM domain WHERE domain=&#039;%s&#039;
#optional query to use when relaying for backup MX
#query = SELECT domain FROM domain WHERE domain=&#039;%s&#039; and backupmx = &#039;0&#039; and active = &#039;1&#039;
EOF

cat &lt;&lt;EOF &gt;/etc/postfix/mysql_virtual_mailbox_maps.cf
user = $MYSQL_USER
password = $MYSQL_PASSWORD
hosts = $MYSQL_HOST
dbname = postfix
query = SELECT maildir FROM mailbox WHERE username=&#039;%s&#039; AND active = 1
EOF

cat &lt;&lt;EOF&gt;/etc/postfix/mysql_virtual_mailbox_limit_maps.cf
user = $MYSQL_USER
password = $MYSQL_PASSWORD
hosts = $MYSQL_HOST
dbname = postfix
query = SELECT quota FROM mailbox WHERE username=&#039;%s&#039;
EOF

cat &lt;&lt;EOF&gt;/etc/postfix/mysql_relay_domains_maps.cf
user = $MYSQL_USER
password = $MYSQL_PASSWORD
hosts = $MYSQL_HOST
dbname = postfix
query = SELECT domain FROM domain WHERE domain=&#039;%s&#039; and backupmx = &#039;1&#039;
EOF</pre>

<p>
Pour le bon fonctionnement et la sécurité il faut exécuter ces deux lignes de commandes
</p>
<pre class="code">  chmod 640 mysql_*
  chgrp postfix mysql_*</pre>

<p>
On crée des liens pour le bon fonctionnement de l&#039;ensemble
</p>
<pre class="code"> mkdir -p /var/spool/postfix/var/run/mysqld
 chown mysql /var/spool/postfix/var/run/mysqld
 ln -s /var/run/mysqld/mysqld.sock /var/spool/postfix/var/run/mysqld/mysqld.sock</pre>
<pre class="code"> mkdir -p /var/spool/postfix/var/run/courier/authdaemon
 ln -s /var/run/courier/authdaemon/socket /var/spool/postfix/var/run/courier/authdaemon/socket
 chown -R daemon:daemon /var/spool/postfix/var/run/courier
 chmod 755 /var/spool/postfix/var/run/courier/authdaemon</pre>

</div>
<div class='secedit editbutton_section editbutton_3'><form class="button btn_secedit form-inline" method="post" action="/postfix_mysql_tls_sasl"><div class="no"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="1429912807" /><input type="hidden" name="summary" value="[Postfix] " /><input type="hidden" name="target" value="section" /><input type="hidden" name="hid" value="postfix" /><input type="hidden" name="codeblockOffset" value="1" /><input type="hidden" name="range" value="2305-8949" /><button type="submit" title="Postfix" class=" btn btn-default btn btn-xs btn-default">Modifier</button></div></form></div>
<h3 class="sectionedit4" id="tls_imap_tls">TLS (Imap TLS)</h3>
<div class="level3">

<p>
Pour le support du <abbr title="Transport Layer Security">TLS</abbr> il faut créer une clef SSL toujours dans le répertoire /etc/postfix/
</p>
<pre class="code"> $ openssl req -new -outform PEM -out smtpd.cert -newkey rsa:2048 -nodes -keyout smtpd.key -keyform PEM -days 365 -x509</pre>
<pre class="code">&lt;-- Enter your Country Name (e.g., &quot;FR&quot;).
&lt;-- Enter your State or Province Name.
&lt;-- Enter your City.
&lt;-- Enter your Organization Name (e.g., the name of your company).
&lt;-- Enter your Organizational Unit Name (e.g. &quot;IT Department&quot;).
&lt;-- Enter the Fully Qualified Domain Name of the system (e.g. &quot;server.domain.tld&quot;).
&lt;-- Enter your Email Address.</pre>
<pre class="code"> $ chmod o= /etc/postfix/smtpd.key</pre>

<p>
Ajoutez dans /etc/postfix/main.cf
</p>
<pre class="code"># Support TLS
smtpd_tls_cert_file = /etc/postfix/smtpd.cert
smtpd_tls_key_file = /etc/postfix/smtpd.key</pre>

</div>
<div class='secedit editbutton_section editbutton_4'><form class="button btn_secedit form-inline" method="post" action="/postfix_mysql_tls_sasl"><div class="no"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="1429912807" /><input type="hidden" name="summary" value="[TLS (Imap TLS)] " /><input type="hidden" name="target" value="section" /><input type="hidden" name="hid" value="tls_imap_tls" /><input type="hidden" name="codeblockOffset" value="1" /><input type="hidden" name="range" value="8950-9739" /><button type="submit" title="TLS (Imap TLS)" class=" btn btn-default btn btn-xs btn-default">Modifier</button></div></form></div>
<h3 class="sectionedit5" id="sasl">SASL</h3>
<div class="level3">

<p>
Pour l&#039;ajout du sasl mettez en fin de fichier de /etc/postfix/main.cf
</p>
<pre class="code"># Support SASL
broken_sasl_auth_clients = yes
smtpd_recipient_restrictions = 
  permit_mynetworks,
  permit_sasl_authenticated,
  reject_non_fqdn_hostname,
  reject_non_fqdn_sender,
  reject_non_fqdn_recipient,  
  reject_unauth_destination,
  reject_unauth_pipelining,   
  reject_invalid_hostname,
  reject_rbl_client list.dsbl.org,
  reject_rbl_client bl.spamcop.net,
  reject_rbl_client sbl-xbl.spamhaus.org
smtpd_sasl_auth_enable = yes
smtpd_sasl_local_domain = $myhostname
smtpd_sasl_security_options = noanonymous
broken_sasl_auth_clients = yes
smtpd_sasl_type = cyrus
cyrus_sasl_config_path = /etc/postfix/sasl</pre>

<p>
On peut supprimer reject_rbl_client opm.blitzed.org, le projet étant abandonné depuis mai 2006 : <a href="http://wiki.blitzed.org/OPM_status" class="urlextern" title="http://wiki.blitzed.org/OPM_status" rel="nofollow">http://wiki.blitzed.org/OPM_status</a>.
</p>

<p>
Créez le fichier smtpd.conf dans /etc/postfix/sasl et ajoutez :
</p>
<pre class="code">pwcheck_method: saslauthd
mech_list: login plain</pre>
<div class="notetip">Pour certaines personnes qui ont eu ce message d&#039;erreur:
<p>
warning: SASL authentication failure: cannot connect to saslauthd server: No such file or directory
</p>

<p>
Il faut ajouter, dans le fichier     /etc/postfix/sasl/smtpd.conf la ligne: 
</p>
<pre class="code">saslauthd_path: /var/spool/postfix/var/run/saslauthd/mux</pre>

</div>
<p>
Editez le fichier /etc/default/saslauthd de façon à ce qu&#039;il ait la configuration suivante
</p>
<pre class="code">START=yes
MECHANISMS=&quot;pam&quot;
OPTIONS=&quot;-c -r -m /var/spool/postfix/var/run/saslauthd&quot;</pre>

<p>
Créez les répertoires et attribuez les droits.
</p>
<pre class="code">mkdir -p /var/spool/postfix/var/run/saslauthd
chown -R root:sasl /var/spool/postfix/var/run/saslauthd
chmod 710 /var/spool/postfix/var/run/saslauthd</pre>

<p>
Créez un  lien symbolique pour que cela fonctionne lorsque postfix est chrooté [sionib] :
</p>
<pre class="code"> ln -s /var/spool/postfix/var/run/saslauthd /var/run/saslauthd
 </pre>

<p>
<img src="/lib/images/smileys/fixme.gif" class="icon" alt="FIXME" />
</p>
<div class="notewarning">Sur debian il faut faire [sebtiz13] :
<pre class="code"> ln -s /var/spool/postfix/var/run/saslauthd /var/run/</pre>

</div><div class="notewarning"> Depuis au moins Ubuntu 14.04, le lien symbolique disparaît à chaque reboot. Comme workaround, éditez /etc/init.d/rc.local : 
<pre class="code"> sudo vi /etc/init.d/rc.local</pre>

<p>
Et ajoutez ces lignes tout à la fin du fichier : 
 
</p>
<pre class="code"> /bin/sleep 5
 ln -s /var/spool/postfix/var/run/saslauthd /var/run/saslauthd
 /etc/init.d/saslauthd restart</pre>

<p>
Ainsi le lien sera recréé à chaque reboot et sasl fonctionnera correctement.
</p>

</div>
<p>
Créez le fichier /etc/pam.d/smtp en prenant soin le cas échéant de remettre votre mot de passe. (chez moi il a fallu nommer ce fichier smtpd [jblanche])
</p>
<pre class="code">auth       required     pam_mysql.so user=postfix passwd=motdepasse host=127.0.0.1 db=postfix table=mailbox usercolumn=username passwdcolumn=password crypt=1
account    sufficient   pam_mysql.so user=postfix passwd=motdepasse host=127.0.0.1 db=postfix table=mailbox usercolumn=username passwdcolumn=password crypt=1</pre>

<p>
Redémarrez sasl
</p>
<pre class="code"> /etc/init.d/saslauthd restart</pre>

<p>
Rajouter l&#039;utilisateur postfix au groupe sasl :
</p>
<pre class="code"> adduser postfix sasl</pre>

</div>
<div class='secedit editbutton_section editbutton_5'><form class="button btn_secedit form-inline" method="post" action="/postfix_mysql_tls_sasl"><div class="no"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="1429912807" /><input type="hidden" name="summary" value="[SASL] " /><input type="hidden" name="target" value="section" /><input type="hidden" name="hid" value="sasl" /><input type="hidden" name="codeblockOffset" value="1" /><input type="hidden" name="range" value="9740-12787" /><button type="submit" title="SASL" class=" btn btn-default btn btn-xs btn-default">Modifier</button></div></form></div>
<h3 class="sectionedit6" id="courier_mtapop3_imap">Courier (MTA: Pop3, IMAP)</h3>
<div class="level3">

<p>
Editez le fichier /etc/courier/authdaemonrc
Cherchez la ligne authmodulelist=&quot;authpam&quot; et remplacez par authmodulelist=&quot;authmysql&quot;
</p>

<p>
Editez le fichier /etc/courier/authmysqlrc de façon à ce qui ressemble à ceci en n&#039;oubliant pas de changer le mot de passe à la ligne 3 :
</p>
<pre class="code">MYSQL_SERVER            127.0.0.1
MYSQL_USERNAME          postfix
MYSQL_PASSWORD          motdepasse
#MYSQL_SOCKET           /var/lib/mysql/mysql.sock
MYSQL_PORT              0
MYSQL_OPT               0
MYSQL_DATABASE          postfix
MYSQL_USER_TABLE        mailbox
MYSQL_CRYPT_PWFIELD     password
#DEFAULT_DOMAIN         domain.tld
MYSQL_UID_FIELD         5000
MYSQL_GID_FIELD         5000
MYSQL_LOGIN_FIELD       username
MYSQL_HOME_FIELD        &quot;/home/vmail&quot;
MYSQL_NAME_FIELD        name
MYSQL_MAILDIR_FIELD     maildir
#MYSQL_QUOTA_FIELD      quota
#MYSQL_WHERE_CLAUSE     server=&#039;exemple.domain.tld&#039;</pre>

<p>
Redémarrez courier
</p>
<pre class="code"> $ /etc/init.d/courier-authdaemon restart</pre>

</div>
<div class='secedit editbutton_section editbutton_6'><form class="button btn_secedit form-inline" method="post" action="/postfix_mysql_tls_sasl"><div class="no"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="1429912807" /><input type="hidden" name="summary" value="[Courier (MTA: Pop3, IMAP)] " /><input type="hidden" name="target" value="section" /><input type="hidden" name="hid" value="courier_mtapop3_imap" /><input type="hidden" name="codeblockOffset" value="1" /><input type="hidden" name="range" value="12788-13811" /><button type="submit" title="Courier (MTA: Pop3, IMAP)" class=" btn btn-default btn btn-xs btn-default">Modifier</button></div></form></div>
<h2 class="sectionedit7 page-header" id="deuxieme_partie">Deuxième Partie</h2>
<div class="level2">

<p>
<strong>Ajout d&#039;un anti-spam, anti-virus</strong>
</p>

<p>
Cette deuxième partie n&#039;est pas obligatoire pour le bon fonctionnement du serveur de mail. Elle est juste présente afin d&#039;ajouter de nouvelles fonctionnalités pour l&#039;utilisateur.
</p>
<pre class="code"> $ sudo apt-get install amavisd-new spamassassin clamav clamav-daemon zoo unzip arj bzip2 razor pyzor dcc-client</pre>
<div class="notewarning"> les paquets dcc-client dcc-server dcc-common n&#039;existent plus sous debian note du 15/03/2014
</div>
<p>
Sous hardy 8.4, le paquet dcc-client n&#039;existe plus, pas même dcc-server. <a href="http://www.howtoforge.com/the-perfect-spamsnake-ubuntu-8.04" class="urlextern" title="http://www.howtoforge.com/the-perfect-spamsnake-ubuntu-8.04" rel="nofollow">http://www.howtoforge.com/the-perfect-spamsnake-ubuntu-8.04</a> est peut être une piste en attendant la mise à jour de cette documentation.
</p>

<p>
Il est toujours possible de télécharger le paquet dcc-server (qui remplace dcc-client) via les paquets ubuntu cela marche avec la version 8.4 et la version 8.10.
Premièrement le paquet dcc-server a besoin de dcc-common pour fonctionner.
</p>
<ul class=" fix-media-list-overlap">
<li class="level1"><div class="li"> dcc-common : <a href="http://packages.ubuntu.com/gutsy/dcc-common" class="urlextern" title="http://packages.ubuntu.com/gutsy/dcc-common" rel="nofollow">http://packages.ubuntu.com/gutsy/dcc-common</a></div>
</li>
<li class="level1"><div class="li"> dcc-server : <a href="http://packages.ubuntu.com/gutsy/dcc-server" class="urlextern" title="http://packages.ubuntu.com/gutsy/dcc-server" rel="nofollow">http://packages.ubuntu.com/gutsy/dcc-server</a></div>
</li>
</ul>

<p>
Par exemple on peut procéder ainsi :
</p>
<pre class="code">wget http://launchpadlibrarian.net/11565554/dcc-server_1.3.42-5_amd64.deb
wget http://launchpadlibrarian.net/11565552/dcc-common_1.3.42-5_amd64.deb
dpkg -i dcc-common_1.3.42-5_amd64.deb
dpkg -i dcc-server_1.3.42-5_amd64.deb

cdcc &quot;delete 127.0.0.1&quot;
cdcc &quot;delete 127.0.0.1 Greylist&quot;</pre>

</div>
<div class='secedit editbutton_section editbutton_7'><form class="button btn_secedit form-inline" method="post" action="/postfix_mysql_tls_sasl"><div class="no"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="1429912807" /><input type="hidden" name="summary" value="[Deuxième Partie] " /><input type="hidden" name="target" value="section" /><input type="hidden" name="hid" value="deuxieme_partie" /><input type="hidden" name="codeblockOffset" value="1" /><input type="hidden" name="range" value="13812-15209" /><button type="submit" title="Deuxième Partie" class=" btn btn-default btn btn-xs btn-default">Modifier</button></div></form></div>
<h3 class="sectionedit8" id="amavis">Amavis</h3>
<div class="level3">

<p>
Créer le fichier /etc/amavis/amavisd.conf
</p>
<pre class="code">use strict;

$MYHOME = &#039;/var/lib/amavis&#039;;   # (default is &#039;/var/amavis&#039;)

$mydomain = &#039;localhost&#039;;

# $myhostname = &#039;serveur.domain.tld&#039;;  # fqdn of this host, default by uname(3)

$daemon_user  = &#039;amavis&#039;;        # (no default (undef))
$daemon_group = &#039;amavis&#039;;        # (no default (undef))

$TEMPBASE = $MYHOME;           # (must be set if other config vars use is)

$pid_file  = &quot;/var/run/amavis/amavisd.pid&quot;;  # (default: &quot;$MYHOME/amavisd.pid&quot;)
$lock_file = &quot;/var/run/amavis/amavisd.lock&quot;; # (default: &quot;$MYHOME/amavisd.lock&quot;)

$ENV{TMPDIR} = $TEMPBASE;       # wise to set TMPDIR, but not obligatory

$max_servers  =  4;   # number of pre-forked children          (default 2)
$max_requests = 10;   # retire a child after that many accepts (default 10)

$child_timeout=5*60;  # abort child if it does not complete each task in n sec
                      # (default: 8*60 seconds)

# @bypass_virus_checks_acl = qw( . );  # uncomment to DISABLE anti-virus code
# @bypass_spam_checks_acl  = qw( . );  # uncomment to DISABLE anti-spam code

@local_domains_acl = ( &quot;.$mydomain&quot; );  # $mydomain and its subdomains

$relayhost_is_client = 0;         # (defaults to false)

$insert_received_line = 1;

$unix_socketname = undef;

$inet_socket_port = 10024;
$inet_socket_bind = &#039;127.0.0.1&#039;;
@inet_acl = qw( 127.0.0.1 );

$DO_SYSLOG = 1;
$LOGFILE = &quot;/var/log/amavis.log&quot;;  # (defaults to empty, no log)

#$log_level = 2;                # (defaults to 0)

$log_templ = &#039;[? %#V |[? %#F |[?%#D|Not-Delivered|Passed]|BANNED name/type (%F)]|INFECTED (%V)], #
[?%o|(?)|&lt;%o&gt;] -&gt; [&lt;%R&gt;|,][? %i ||, quarantine %i], Message-ID: %m, Hits: %c&#039;;

read_l10n_templates(&#039;en_US&#039;, &#039;/etc/amavis&#039;);

$final_virus_destiny      = D_REJECT; # (defaults to D_BOUNCE)
$final_banned_destiny     = D_REJECT;  # (defaults to D_BOUNCE)
$final_spam_destiny       = D_PASS;  # (defaults to D_REJECT)
$final_bad_header_destiny = D_PASS;  # (defaults to D_PASS), D_BOUNCE suggested

$viruses_that_fake_sender_re = new_RE(
  qr&#039;nimda|hybris|klez|bugbear|yaha|braid|sobig|fizzer|palyh|peido|holar&#039;i,
  qr&#039;tanatos|lentin|bridex|mimail|trojan\.dropper|dumaru|parite|spaces&#039;i,
  qr&#039;dloader|galil|gibe|swen|netwatch|bics|sbrowse|sober|rox|val(hal)?la&#039;i,
  qr&#039;frethem|sircam|be?agle|tanx|mydoom|novarg|shimg|netsky|somefool|moodown&#039;i,
  qr&#039;@mm|@MM&#039;,    # mass mailing viruses as labeled by f-prot and uvscan
  qr&#039;Worm&#039;i,      # worms as labeled by ClamAV, Kaspersky, etc
  [qr&#039;^(EICAR|Joke\.|Junk\.)&#039;i         =&gt; 0],
  [qr&#039;^(WM97|OF97|W95/CIH-|JS/Fort)&#039;i  =&gt; 0],
  [qr/.*/ =&gt; 1],  # true by default  (remove or comment-out if undesired)
);

$virus_admin = &quot;postmaster\@$mydomain&quot;;                # due to D_DISCARD default

$mailfrom_to_quarantine = &#039;&#039;;   # override sender address with null return path

$QUARANTINEDIR = &#039;/var/lib/amavis/virusmails&#039;;

$virus_quarantine_to  = &#039;virus-quarantine&#039;;    # traditional local quarantine
$spam_quarantine_to = &#039;spam-quarantine&#039;;

$X_HEADER_TAG = &#039;X-Virus-Scanned&#039;;        # (default: undef)
$X_HEADER_LINE = &quot;by $myversion (Debian) at $mydomain&quot;;

$undecipherable_subject_tag = &#039;***UNCHECKED*** &#039;;  # undef disables it

$remove_existing_x_scanned_headers = 0; # leave existing X-Virus-Scanned alone
#$remove_existing_x_scanned_headers= 1; # remove existing headers
                                        # (defaults to false)
#$remove_existing_spam_headers = 0;     # leave existing X-Spam* headers alone
$remove_existing_spam_headers  = 1;     # remove existing spam headers if
                                        # spam scanning is enabled (default)

$keep_decoded_original_re = new_RE(
# qr&#039;^MAIL$&#039;,   # retain full original message for virus checking (can be slow)
  qr&#039;^MAIL-UNDECIPHERABLE$&#039;,  # retain full mail if it contains undecipherables
  qr&#039;^(ASCII(?! cpio)|text|uuencoded|xxencoded|binhex)&#039;i,
# qr&#039;^Zip archive data&#039;,
);

$banned_filename_re = new_RE(
#  qr&#039;^UNDECIPHERABLE$&#039;,  # is or contains any undecipherable components
   qr&#039;\.[^.]*\.(exe|vbs|pif|scr|bat|cmd|com|dll)$&#039;i, # some double extensions
   qr&#039;[{}]&#039;,     # curly braces in names (serve as Class ID extensions - CLSID)
#  qr&#039;.\.(exe|vbs|pif|scr|bat|cmd|com)$&#039;i,           # banned extension - basic
#  qr&#039;.\.(ade|adp|bas|bat|chm|cmd|com|cpl|crt|exe|hlp|hta|inf|ins|isp|js|
#         jse|lnk|mdb|mde|msc|msi|msp|mst|pcd|pif|reg|scr|sct|shs|shb|vb|
#         vbe|vbs|wsc|wsf|wsh)$&#039;ix,                  # banned extension - long
#  qr&#039;.\.(mim|b64|bhx|hqx|xxe|uu|uue)$&#039;i, # banned extension - WinZip vulnerab.
#  qr&#039;^\.(zip|lha|tnef|cab)$&#039;i,                      # banned file(1) types
#  qr&#039;^\.exe$&#039;i,                                     # banned file(1) types
#  qr&#039;^application/x-msdownload$&#039;i,                  # banned MIME types
#  qr&#039;^application/x-msdos-program$&#039;i,
   qr&#039;^message/partial$&#039;i,  # rfc2046. this one is deadly for Outcrook
#  qr&#039;^message/external-body$&#039;i, # block rfc2046
);

@lookup_sql_dsn =
   ( [&#039;DBI:mysql:database=postfix;host=127.0.0.1;port=3306&#039;, &#039;postfix&#039;, &#039;motdepasse&#039;] );

$sql_select_policy = &#039;SELECT &quot;Y&quot; as local FROM domains WHERE CONCAT(&quot;@&quot;,domain) IN (%k)&#039;;

$sql_select_white_black_list = undef;  # undef disables SQL white/blacklisting

$recipient_delimiter = &#039;+&#039;;                # (default is &#039;+&#039;)

$replace_existing_extension = 1;        # (default is false)

$localpart_is_case_sensitive = 0;        # (default is false)

$blacklist_sender_re = new_RE(
    qr&#039;^(bulkmail|offers|cheapbenefits|earnmoney|foryou|greatcasino)@&#039;i,
    qr&#039;^(investments|lose_weight_today|market\.alert|money2you|MyGreenCard)@&#039;i,
    qr&#039;^(new\.tld\.registry|opt-out|opt-in|optin|saveonl|smoking2002k)@&#039;i,
    qr&#039;^(specialoffer|specialoffers|stockalert|stopsnoring|wantsome)@&#039;i,
    qr&#039;^(workathome|yesitsfree|your_friend|greatoffers)@&#039;i,
    qr&#039;^(inkjetplanet|marketopt|MakeMoney)\d*@&#039;i,
);

map { $whitelist_sender{lc($_)}=1 } (qw(
  nobody@cert.org
  owner-alert@iss.net
  slashdot@slashdot.org
  bugtraq@securityfocus.com
  NTBUGTRAQ@LISTSERV.NTBUGTRAQ.COM
  security-alerts@linuxsecurity.com
  amavis-user-admin@lists.sourceforge.net
  razor-users-admin@lists.sourceforge.net
  notification-return@lists.sophos.com
  mailman-announce-admin@python.org
  zope-announce-admin@zope.org
  owner-postfix-users@postfix.org
  owner-postfix-announce@postfix.org
  owner-sendmail-announce@lists.sendmail.org
  sendmail-announce-request@lists.sendmail.org
  ca+envelope@sendmail.org
  owner-technews@postel.ACM.ORGuse strict;
  lvs-users-admin@LinuxVirtualServer.org
  ietf-123-owner@loki.ietf.org
  cvs-commits-list-admin@gnome.org
  rt-users-admin@lists.fsck.com
  owner-announce@mnogosearch.org
  owner-hackers@ntp.org
  owner-bugs@ntp.org
  clp-request@comp.nus.edu.sg
  surveys-errors@lists.nua.ie
  emailNews@genomeweb.com
  owner-textbreakingnews@CNNIMAIL12.CNN.COM
  yahoo-dev-null@yahoo-inc.com
));

$MAXLEVELS = 14;                # (default is undef, no limit)

$MAXFILES = 1500;                # (default is undef, no limit)

$MIN_EXPANSION_QUOTA =      100*1024;  # bytes  (default undef, not enforced)
$MAX_EXPANSION_QUOTA = 300*1024*1024;  # bytes  (default undef, not enforced)
$MIN_EXPANSION_FACTOR =   5;  # times original mail size  (must be specified)
$MAX_EXPANSION_FACTOR = 500;  # times original mail size  (must be specified)

$path = &#039;/usr/local/sbin:/usr/local/bin:/usr/sbin:/sbin:/usr/bin:/bin&#039;;

$file   = &#039;file&#039;;   # file(1) utility; use 3.41 or later to avoid vulnerability

$gzip   = &#039;gzip&#039;;
$bzip2  = &#039;bzip2&#039;;
$lzop   = &#039;lzop&#039;;
$uncompress = [&#039;uncompress&#039;, &#039;gzip -d&#039;, &#039;zcat&#039;];
$unfreeze   = [&#039;unfreeze&#039;, &#039;freeze -d&#039;, &#039;melt&#039;, &#039;fcat&#039;];
$arc        = [&#039;nomarch&#039;, &#039;arc&#039;];
$unarj      = [&#039;arj&#039;, &#039;unarj&#039;];  # both can extract, arj is recommended
$unrar      = [&#039;rar&#039;, &#039;unrar&#039;];  # both can extract, same options
$zoo    = &#039;zoo&#039;;
$lha    = &#039;lha&#039;;
$cpio   = &#039;cpio&#039;;   # comment out if cpio does not support GNU options

$sa_local_tests_only = 0;   # (default: false)
#$sa_auto_whitelist = 1;    # turn on AWL (default: false)

# Timout for SpamAssassin. This is only used if spamassassin does NOT
# override it (which it often does if sa_local_tests_only is not true)
$sa_timeout = 30;           # timeout in seconds for a call to SpamAssassin
                            # (default is 30 seconds, undef disables it)

# AWL (auto whitelisting), requires spamassassin 2.44 or better
# $sa_auto_whitelist = 1;   # defaults to undef

$sa_mail_body_size_limit = 150*1024;

$sa_tag_level_deflt  = 3.0; # add spam info headers if at, or above that level
$sa_tag2_level_deflt = 4.0; # add &#039;spam detected&#039; headers at that level
$sa_kill_level_deflt = $sa_tag2_level_deflt;

$sa_dsn_cutoff_level = 10;

$sa_spam_subject_tag = &#039;***SPAM*** &#039;;

$first_infected_stops_scan = 1;

@av_scanners = (

### http://www.clamav.net/
[&#039;Clam Antivirus-clamd&#039;,
  \&amp;ask_daemon, [&quot;CONTSCAN {}\n&quot;, &quot;/var/run/clamav/clamd.ctl&quot;],
  qr/\bOK$/, qr/\bFOUND$/,
  qr/^.*?: (?!Infected Archive)(.*) FOUND$/ ],
# NOTE: run clamd under the same user as amavisd;  match the socket
# name (LocalSocket) in clamav.conf to the socket name in this entry
# When running chrooted one may prefer: [&quot;CONTSCAN {}\n&quot;,&quot;$MYHOME/clamd&quot;],

);

@av_scanners_backup = (

  ### http://www.clamav.net/
  [&#039;Clam Antivirus - clamscan&#039;, &#039;clamscan&#039;,
    &quot;--stdout --no-summary -r --tempdir=$TEMPBASE {}&quot;, [0], [1],
    qr/^.*?: (?!Infected Archive)(.*) FOUND$/ ],

);

1;  # insure a defined return</pre>

<p>
Pensez à changer le mot de passe à la ligne 112 par celui de votre base de donné postfix.
</p>

<p>
Configurez /etc/amavis/conf.d/05-node_id
</p>
<pre class="code">use strict;
# $myhostname is used by amavisd-new for node identification, and it is
# important to get it right (e.g. for ESMTP EHLO, loop detection, and so on).
chomp($myhostname = `hostname --fqdn`);
# To manually set $myhostname, edit the following line with the correct Fully
# Qualified Domain Name (FQDN) and remove the # at the beginning of the line.
#
$myhostname = &quot;your hostname mail&quot;;
1;  # ensure a defined return</pre>

<p>
Pensez à changer le nom d&#039;hôte mail &quot;your hostname mail&quot; à la ligne 9 par le votre (celui configurer dans /etc/postfix/main.cf)
</p>

<p>
Ajoutez en fin fichier /etc/postfix/master.cf
</p>
<pre class="code">amavis unix - - - - 2 smtp
        -o smtp_data_done_timeout=1200
        -o smtp_send_xforward_command=yes

127.0.0.1:10024 inet n - - - - smtpd
        -o content_filter=
        -o local_recipient_maps=
        -o relay_recipient_maps=
        -o smtpd_restriction_classes=
        -o smtpd_client_restrictions=
        -o smtpd_helo_restrictions=
        -o smtpd_sender_restrictions=
        -o smtpd_recipient_restrictions=permit_mynetworks,reject
        -o mynetworks=127.0.0.0/8
        -o strict_rfc821_envelopes=yes
        -o receive_override_options=no_unknown_recipient_checks,no_header_body_checks
        -o smtpd_bind_address=127.0.0.1</pre>

<p>
Ajoutez en fin de fichier /etc/postfix/main.cf
</p>
<pre class="code"># Support Amavis
content_filter = amavis:[127.0.0.1]:10024
receive_override_options = no_address_mappings</pre>

<p>
Testons la configuration de postfix
</p>
<pre class="code"> $ postfix check</pre>

<p>
S&#039;il n&#039;y a pas de réponse, c&#039;est que votre configuration est bonne. On peut recharger postfix.
</p>
<pre class="code"> $ postfix reload</pre>

</div>
<div class='secedit editbutton_section editbutton_8'><form class="button btn_secedit form-inline" method="post" action="/postfix_mysql_tls_sasl"><div class="no"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="1429912807" /><input type="hidden" name="summary" value="[Amavis] " /><input type="hidden" name="target" value="section" /><input type="hidden" name="hid" value="amavis" /><input type="hidden" name="codeblockOffset" value="2" /><input type="hidden" name="range" value="15210-26877" /><button type="submit" title="Amavis" class=" btn btn-default btn btn-xs btn-default">Modifier</button></div></form></div>
<h3 class="sectionedit9" id="spamassassin">Spamassassin</h3>
<div class="level3">

<p>
Avant tout, il faut créer l&#039;utilisateur &quot;spamd&quot;
</p>
<pre class="code"> sudo groupadd spamd
 sudo useradd -g spamd -s /sbin/nologin -d /var/lib/spamassassin spamd
 sudo mkdir /var/lib/spamassassin
 sudo chown spamd:spamd /var/lib/spamassassin
 sudo mkdir /var/log/spamd
 sudo chown spamd:spamd /var/log/spamd</pre>

<p>
Modifer le fichier /etc/default/spamassassin :
</p>
<pre class="code"> ENABLED=1
 SAHOME=&quot;/var/lib/spamassassin/&quot;
 OPTIONS=&quot;--create-prefs --max-children 5 --username spamd --helper-home-dir ${SAHOME} -s /var/log/spamd/spamd.log&quot;
 PIDFILE=&quot;${SAHOME}spamd.pid&quot;</pre>

<p>
Editez le fichier /etc/spamassassin/local.cf
</p>
<pre class="code"># This is the right place to customize your installation of SpamAssassin.
#
# See &#039;perldoc Mail::SpamAssassin::Conf&#039; for details of what can be
# tweaked.
#
###########################################################################
#
# rewrite_header Subject *****SPAM*****
# report_safe 1
# trusted_networks 212.17.35.
# lock_method flock

# dcc
use_dcc 1
dcc_path /usr/bin/dccproc
dcc_add_header 1
dcc_dccifd_path /usr/sbin/dccifd

# Pyzor
use_pyzor 1
pyzor_path /usr/bin/pyzor
pyzor_add_header 1

# Razor
use_razor2 1
razor_config /etc/razor/razor-agent.conf

# Bayes
use_bayes 1
use_bayes_rules 1
bayes_auto_learn 1</pre>

<p>
Démarrez le daemon spamassassin
</p>
<pre class="code"> $ /etc/init.d/spamassassin start   </pre>

<p>
Pour dire à postfix d&#039;utiliser spamassassin, modifier le fichier &quot;/etc/postfix/master.cf&quot; et changer la ligne : 
</p>
<pre class="code"> smtp      inet  n       -       -       -       -       smtpd   </pre>

<p>
par  
</p>
<pre class="code"> smtp      inet  n       -       -       -       -       smtpd
     -o content_filter=spamassassin</pre>

<p>
et à la fin du fichier, ajoutez : 
</p>
<pre class="code"> spamassassin unix -     n       n       -       -       pipe
     user=spamd argv=/usr/bin/spamc -f -e    
     /usr/sbin/sendmail -oi -f ${sender} ${recipient}</pre>

<p>
Créez le fichier /usr/sbin/sa_rules_update.sh
</p>
<pre class="code">#!/bin/sh
PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
cd /etc/spamassassin/ &amp;&gt; /dev/null &amp;&amp; /usr/bin/wget http://www.rulesemporium.com/rules/71_sare_redirect_pre3.0.0.cf -O 71_sare_redirect_pre3.0.0.cf &amp;&gt; /dev/null
cd /etc/spamassassin/ &amp;&gt; /dev/null &amp;&amp; /usr/bin/wget http://www.rulesemporium.com/rules/70_sare_bayes_poison_nxm.cf -O 70_sare_bayes_poison_nxm.cf &amp;&gt; /dev/null
cd /etc/spamassassin/ &amp;&gt; /dev/null &amp;&amp; /usr/bin/wget http://www.rulesemporium.com/rules/70_sare_html.cf -O 70_sare_html.cf &amp;&gt; /dev/null
cd /etc/spamassassin/ &amp;&gt; /dev/null &amp;&amp; /usr/bin/wget http://www.rulesemporium.com/rules/70_sare_html4.cf -O 70_sare_html4.cf &amp;&gt; /dev/null
cd /etc/spamassassin/ &amp;&gt; /dev/null &amp;&amp; /usr/bin/wget http://www.rulesemporium.com/rules/70_sare_html_x30.cf -O 70_sare_html_x30.cf &amp;&gt; /dev/null
cd /etc/spamassassin/ &amp;&gt; /dev/null &amp;&amp; /usr/bin/wget http://www.rulesemporium.com/rules/70_sare_header0.cf -O 70_sare_header0.cf &amp;&gt; /dev/null
cd /etc/spamassassin/ &amp;&gt; /dev/null &amp;&amp; /usr/bin/wget http://www.rulesemporium.com/rules/70_sare_header3.cf -O 70_sare_header3.cf &amp;&gt; /dev/null
cd /etc/spamassassin/ &amp;&gt; /dev/null &amp;&amp; /usr/bin/wget http://www.rulesemporium.com/rules/70_sare_header_x30.cf -O 70_sare_header_x30.cf &amp;&gt; /dev/null
cd /etc/spamassassin/ &amp;&gt; /dev/null &amp;&amp; /usr/bin/wget http://www.rulesemporium.com/rules/70_sare_specific.cf -O 70_sare_specific.cf &amp;&gt; /dev/null
cd /etc/spamassassin/ &amp;&gt; /dev/null &amp;&amp; /usr/bin/wget http://www.rulesemporium.com/rules/70_sare_adult.cf -O 70_sare_adult.cf &amp;&gt; /dev/null
cd /etc/spamassassin/ &amp;&gt; /dev/null &amp;&amp; /usr/bin/wget http://www.rulesemporium.com/rules/72_sare_bml_post25x.cf -O 72_sare_bml_post25x.cf &amp;&gt; /dev/null
cd /etc/spamassassin/ &amp;&gt; /dev/null &amp;&amp; /usr/bin/wget http://www.rulesemporium.com/rules/99_sare_fraud_post25x.cf -O 99_sare_fraud_post25x.cf &amp;&gt; /dev/null
cd /etc/spamassassin/ &amp;&gt; /dev/null &amp;&amp; /usr/bin/wget http://www.rulesemporium.com/rules/70_sare_spoof.cf -O 70_sare_spoof.cf &amp;&gt; /dev/null
cd /etc/spamassassin/ &amp;&gt; /dev/null &amp;&amp; /usr/bin/wget http://www.rulesemporium.com/rules/70_sare_random.cf -O 70_sare_random.cf &amp;&gt; /dev/null
cd /etc/spamassassin/ &amp;&gt; /dev/null &amp;&amp; /usr/bin/wget http://www.rulesemporium.com/rules/70_sare_oem.cf -O 70_sare_oem.cf &amp;&gt; /dev/null
cd /etc/spamassassin/ &amp;&gt; /dev/null &amp;&amp; /usr/bin/wget http://www.rulesemporium.com/rules/70_sare_genlsubj0.cf -O 70_sare_genlsubj0.cf &amp;&gt; /dev/null
cd /etc/spamassassin/ &amp;&gt; /dev/null &amp;&amp; /usr/bin/wget http://www.rulesemporium.com/rules/70_sare_genlsubj3.cf -O 70_sare_genlsubj3.cf &amp;&gt; /dev/null
cd /etc/spamassassin/ &amp;&gt; /dev/null &amp;&amp; /usr/bin/wget http://www.rulesemporium.com/rules/70_sare_genlsubj_x30.cf -O 70_sare_genlsubj_x30.cf &amp;&gt; /dev/null
cd /etc/spamassassin/ &amp;&gt; /dev/null &amp;&amp; /usr/bin/wget http://www.rulesemporium.com/rules/70_sare_unsub.cf -O 70_sare_unsub.cf &amp;&gt; /dev/null
cd /etc/spamassassin/ &amp;&gt; /dev/null &amp;&amp; /usr/bin/wget http://www.rulesemporium.com/rules/70_sare_uri.cf -O 70_sare_uri.cf &amp;&gt; /dev/null
cd /etc/spamassassin/ &amp;&gt; /dev/null &amp;&amp; /usr/bin/wget http://www.timj.co.uk/linux/bogus-virus-warnings.cf -O bogus-virus-warnings.cf &amp;&gt; /dev/null
cd /etc/spamassassin/ &amp;&gt; /dev/null &amp;&amp; /usr/bin/wget http://www.yackley.org/sa-rules/evilnumbers.cf -O evilnumbers.cf &amp;&gt; /dev/null
cd /etc/spamassassin/ &amp;&gt; /dev/null &amp;&amp; /usr/bin/wget http://www.stearns.org/sa-blacklist/random.current.cf -O random.current.cf &amp;&gt; /dev/null
cd /etc/spamassassin/ &amp;&gt; /dev/null &amp;&amp; /usr/bin/wget http://www.rulesemporium.com/rules/00_FVGT_File001.cf -O 00_FVGT_File001.cf &amp;&gt; /dev/null
## Next lines are remplaced by the one above
##cd /etc/spamassassin/ &amp;&gt; /dev/null &amp;&amp; /usr/bin/wget http://www.rulesemporium.com/rules/88_FVGT_body.cf -O 88_FVGT_body.cf &amp;&gt; /dev/null
##cd /etc/spamassassin/ &amp;&gt; /dev/null &amp;&amp; /usr/bin/wget http://www.rulesemporium.com/rules/88_FVGT_rawbody.cf -O 88_FVGT_rawbody.cf &amp;&gt; /dev/null
##cd /etc/spamassassin/ &amp;&gt; /dev/null &amp;&amp; /usr/bin/wget http://www.rulesemporium.com/rules/88_FVGT_subject.cf -O 88_FVGT_subject.cf &amp;&gt; /dev/null
##cd /etc/spamassassin/ &amp;&gt; /dev/null &amp;&amp; /usr/bin/wget http://www.rulesemporium.com/rules/88_FVGT_headers.cf -O 88_FVGT_headers.cf &amp;&gt; /dev/null
cd /etc/spamassassin/ &amp;&gt; /dev/null &amp;&amp; /usr/bin/wget http://www.rulesemporium.com/rules/88_FVGT_uri.cf -O 88_FVGT_uri.cf &amp;&gt; /dev/null
cd /etc/spamassassin/ &amp;&gt; /dev/null &amp;&amp; /usr/bin/wget http://www.rulesemporium.com/rules/99_FVGT_DomainDigits.cf -O 99_FVGT_DomainDigits.cf &amp;&gt; /dev/null
cd /etc/spamassassin/ &amp;&gt; /dev/null &amp;&amp; /usr/bin/wget http://www.rulesemporium.com/rules/99_FVGT_Tripwire.cf -O 99_FVGT_Tripwire.cf &amp;&gt; /dev/null
cd /etc/spamassassin/ &amp;&gt; /dev/null &amp;&amp; /usr/bin/wget http://www.rulesemporium.com/rules/99_FVGT_meta.cf -O 99_FVGT_meta.cf &amp;&gt; /dev/null
cd /etc/spamassassin/ &amp;&gt; /dev/null &amp;&amp; /usr/bin/wget http://www.nospamtoday.com/download/mime_validate.cf -O mime_validate.cf &amp;&gt; /dev/null

/etc/init.d/amavis restart &amp;&gt; /dev/null

exit 0</pre>
<pre class="code"> $ chmod 755 /usr/sbin/sa_rules_update.sh</pre>

<p>
Ajoutez la crontab suivante
</p>
<pre class="code"> $ crontab -e</pre>
<pre class="code">30 2 */2 * * /usr/sbin/sa_rules_update.sh &amp;&gt; /dev/null</pre>

<p>
On l&#039;execute manuellement, cette opération peut être longue la première fois.
</p>
<pre class="code"> $ /usr/sbin/sa_rules_update.sh</pre>

<p>
Testons le serveur smtp
</p>
<pre class="code"> $ telnet localhost 25</pre>
<pre class="code">Trying 127.0.0.1...
Connected to 127.0.0.1.
Escape character is &#039;^]&#039;.
220 localhost.localdomain ESMTP Postfix (Debian/GNU)
ehlo localhost
250-localhost.localdomain
250-PIPELINING
250-SIZE 51200000 
250-VRFY
250-ETRN
250-STARTTLS
250-AUTH LOGIN PLAIN
250-AUTH=LOGIN PLAIN
250-ENHANCEDSTATUSCODES
250-8BITMIME
250 DSN
quit</pre>

<p>
Si les tests sont ok, votre serveur de mail est opérationnel. 
</p>

</div>
<div class='secedit editbutton_section editbutton_9'><form class="button btn_secedit form-inline" method="post" action="/postfix_mysql_tls_sasl"><div class="no"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="1429912807" /><input type="hidden" name="summary" value="[Spamassassin] " /><input type="hidden" name="target" value="section" /><input type="hidden" name="hid" value="spamassassin" /><input type="hidden" name="codeblockOffset" value="2" /><input type="hidden" name="range" value="26878-34474" /><button type="submit" title="Spamassassin" class=" btn btn-default btn btn-xs btn-default">Modifier</button></div></form></div>
<h2 class="sectionedit10 page-header" id="creation_des_utilisateursdomaines">Création des utilisateurs/domaines</h2>
<div class="level2">

<p>
Il ne nous reste plus qu&#039;à remplir les tables pour la gestion des domaines, des boxes, et des aliases.
Pour cela, vous pouvez passer par phpmyadmin, ce que je vous conseille. Ou pour les mordus de la console comme mouaaaa…
</p>
<pre class="code">$ mysql -u root -p
Enter password:
USE postfix;
INSERT INTO domain (domain,description) VALUES (&#039;domain.tld&#039;,&#039;Test Domain&#039;);
INSERT INTO alias (address,goto) VALUES (&#039;alias@domain.tld&#039;, &#039;utilisateur@domain.tld&#039;);
INSERT INTO mailbox (username,password,name,maildir)  VALUES (&#039;utilisateur@domain.tld&#039;,ENCRYPT(&#039;&quot;votre mot de passe&quot;&#039;),&#039;Mailbox User&#039;,&#039;utilisateur@domain.tld/&#039;);
quit;</pre>
<div class="notewarning">Attention, lors de la création de l&#039;utilisateur, il faut supprimer les doubles quotes lors de l&#039;utilisation d&#039; ENCRYPT ( ENCRYPT(&#039;myMdp&#039;) et non pas ENCRYPT(&#039;&quot;myMdp&quot;&#039;) )

</div>
<p>
Les mots de passe seront à chiffrer via la fonction ENCRYPT sous PHPMyAdmin.
</p>
<div class="notetip">Pour Postfix Admin je vous conseille de l&#039;installer avant de faire la configuration de postfix + SQL
</div>
<p>
Il existe une interface d&#039;administration, <a href="http://high5.net/postfixadmin/" class="urlextern" title="http://high5.net/postfixadmin/" rel="nofollow">Postfix Admin</a> qui permet la gestion de tout cela, vous trouverez un tutoriel pour l&#039;installer à cette <a href="http://www.system-linux.eu/index.php?post/2009/10/22/Installation-et-Configuration-de-postfixadmin" class="urlextern" title="http://www.system-linux.eu/index.php?post/2009/10/22/Installation-et-Configuration-de-postfixadmin" rel="nofollow">adresse</a>. Je l&#039;ai testé à ses débuts, le trouvant très mal fait, je l&#039;ai laissé tomber, entre temps il a subi quelques améliorations, et je ne l&#039;ai pas testé de nouveau.
</p>

<p>
Testez votre nouvelle installation avec votre client de messagerie. Pour information les identifiants de connexion sont sous la forme <strong>utilisateur@domain.tld</strong>
</p>

<p>
Postfix a été configuré pour les quota mais le tuto n&#039;en parle pas. C&#039;est tout à fait normal, je n&#039;ai pas tout à fait finalisé le tuto, et je ne parle pas de la mise en place des quota. Pour cela, il faut compiler postfix via les sources, voir le patcher si je ne raconte pas de bêtise. Une recherche sur google vous en dira plus en attendant <img src="/lib/images/smileys/icon_wink.gif" class="icon" alt=";-)" />
</p>

</div>
<div class='secedit editbutton_section editbutton_10'><form class="button btn_secedit form-inline" method="post" action="/postfix_mysql_tls_sasl"><div class="no"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="1429912807" /><input type="hidden" name="summary" value="[Création des utilisateurs/domaines] " /><input type="hidden" name="target" value="section" /><input type="hidden" name="hid" value="creation_des_utilisateursdomaines" /><input type="hidden" name="codeblockOffset" value="2" /><input type="hidden" name="range" value="34475-36516" /><button type="submit" title="Création des utilisateurs/domaines" class=" btn btn-default btn btn-xs btn-default">Modifier</button></div></form></div>
<h2 class="sectionedit11 page-header" id="creation_du_repertoire_de_stockage_des_mails">Création du répertoire de stockage des mails</h2>
<div class="level2">

<p>
Il faut créer le répertoire ou seront stockés les mails (envoyés, brouillons, etc…)
Aller dans le répertoire ou tout les comptes mails sont enregistrés (/home/vmail par exemple), puis
</p>
<pre class="code">$ maildirmake VOTREREPERTOIREDEMAIL</pre>

<p>
Modifier VOTREREPERTOIREDEMAIL par le nom que vous voulez donner au compte mail (machin@domain.ltd par exemple).
</p>

<p>
Donner les droits adéquats aux dossiers contenus dans votre répertoire où les comptes mails sont enregistrés :
</p>
<pre class="code">$ sudo chown vmail:vmail -R /home/vmail;</pre>

</div>
<div class='secedit editbutton_section editbutton_11'><form class="button btn_secedit form-inline" method="post" action="/postfix_mysql_tls_sasl"><div class="no"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="1429912807" /><input type="hidden" name="summary" value="[Création du répertoire de stockage des mails] " /><input type="hidden" name="target" value="section" /><input type="hidden" name="hid" value="creation_du_repertoire_de_stockage_des_mails" /><input type="hidden" name="codeblockOffset" value="2" /><input type="hidden" name="range" value="36517-37081" /><button type="submit" title="Création du répertoire de stockage des mails" class=" btn btn-default btn btn-xs btn-default">Modifier</button></div></form></div>
<h2 class="sectionedit12 page-header" id="en_cas_d_erreurs">En cas d&#039;erreurs</h2>
<div class="level2">
<ol class=" fix-media-list-overlap">
<li class="level1"><div class="li"> Si vous souhaitez tester la configuration de sasl, vous pouvez utiliser : <pre class="code">testsaslauthd -u adresse@domain.tld -p password -s smtp</pre>
</div>
</li>
</ol>
<div class="noteclassic">Pour vérifier que sasl va bien chercher dans la db les utilisateurs, mettez un nom d&#039;utilisateur inexistant dans l&#039;option -u. 
La log /var/log/auth.log devrait indiquer que le SELECT SQL ne retourne pas de résultat.
Dans le cas contraire, vous avez probablement un problème de configuration.

</div><div class="noteclassic">Si vous n&#039;arrivez toujours pas à obtenir une connection correcte et que le point ci-dessus est vérifié, modifiez le fichier /etc/pam.d/smtp en changeant sur les deux lignes le paramétre crypt=1 à crypt=0 (non crypté).
Il vous suffit alors de créer un nouveau user ou de modifier le précédent par un mot de passe simple (test par exemple) et de retester.

</div><ol class=" fix-media-list-overlap">
<li class="level1"><div class="li"> Si le serveur smtp ne répond pas, sachez qu&#039;Orange et Free bloquent le port smtp (25) en dehors de leurs réseaux par défaut afin de limiter la diffusion de spam. Vous devrez donc les débloquer pour le serveur mais aussi pour les clients.</div>
</li>
</ol>

<p>
Dans ce cas, le serveur pop3 risque de ne pas fonctionner. Pour cela, il faut créer à la main les répertoires des différents utilisateurs ajoutés dans la table mailbox.
</p>
<pre class="code">cd /home/vmail
mkdir NomRépertoireDeLaBase
mkdir NomRépertoireDeLaBase/cur
mkdir NomRépertoireDeLaBase/tmp</pre>

<p>
Les trois dernières commandes sont à effectuer autant de fois qu&#039;il y a d&#039;occurrences dans la base.
</p>

<p>
Ensuite, il faut attribuer les droits à l&#039;utilisateur vmail, comme indiqué précédemment.
</p>
<pre class="code">chown vmail:vmail -R /home/vmail;</pre>

<p>
- Si une fois un test d&#039;envoi de mail effectué (test SMTP+SASL), vous obtenez dans le journal /var/log/auth.log le message suivant : 
</p>
<pre class="code">postfix/smtpd[23340]: sql_select option missing
postfix/smtpd[23340]: auxpropfunc error no mechanism available </pre>

<p>
Il faut désinstaller le package suivant : libsasl2-modules-sql
</p>
<pre class="code">apt-get remove libsasl2-modules-sql</pre>
<hr />

<p>
<em>Contributeurs: <a href="/utilisateurs/cereal_killer_du_77" class="wikilink1" title="utilisateurs:cereal_killer_du_77">CeReAl KiLLeR DU 77</a>, psykokwak78</em>, Association BreizhTux Saint-Brieuc
</p>

</div>
<div class='secedit editbutton_section editbutton_12'><form class="button btn_secedit form-inline" method="post" action="/postfix_mysql_tls_sasl"><div class="no"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="1429912807" /><input type="hidden" name="summary" value="[En cas d&#039;erreurs] " /><input type="hidden" name="target" value="section" /><input type="hidden" name="hid" value="en_cas_d_erreurs" /><input type="hidden" name="codeblockOffset" value="2" /><input type="hidden" name="range" value="37082-" /><button type="submit" title="En cas d&#039;erreurs" class=" btn btn-default btn btn-xs btn-default">Modifier</button></div></form></div>
</div><!-- /CONTENT --></div>
          </div>
        </div>

        <div class="small text-right">

                    <span class="docInfo">
            <ul class="list-inline"><li><i class="fa fa-fw fa-file-text-o text-muted"></i> <span title="postfix_mysql_tls_sasl.txt">postfix_mysql_tls_sasl.txt</span></li><li><i class="fa fa-fw fa-calendar text-muted"></i> Dernière modification: <span title="Le 25/04/2015, 00:00">Le 25/04/2015, 00:00</span></li><li class="text-muted">par 62.147.231.53</li></ul>          </span>
          
          
        </div>

      </article>

      
    </main>

    <footer id="dw__footer" class="navbar navbar-default">
  <div class="container">

    <div class="small navbar-text">

            <div class="footer-dw-title row">
        <div class="media col-sm-4">
          <!--<div class="media-left">
            <img src="/_media/logo.png" alt="Wiki ubuntu-fr" class="media-object" style="width:32px" />
          </div> -->
          <div class="media-body">
            <h4 class="media-heading">Documentation ubuntu-fr</h4>
            <p>
              Les pages de cette documentation sont rédigées par les utilisateurs
              pour les utilisateurs. Apportez-nous votre aide pour améliorer
              le contenu de cette documentation.
            </p>
          </div>
        </div>
        <div class="col-sm-4">
          <h4>Liens utiles</h4>
          <ul class="list-group list-unstyled">
            <li>
              <a href="/debutant" ><i class="fa fa-fw fa-child" style="font-size: 1.3em;"></i> Débuter sur Ubuntu</a>            </li>
            <li>
              <a href="/wiki/participer_wiki" ><i class="fa fa-fw fa-edit" style="font-size: 1.3em;"></i> Participer à la documentation</a>            </li>
            <li>
              <a href="/documentation_hors_ligne" ><i class="fa fa-fw fa-book" style="font-size: 1.3em;"></i> Documentation hors ligne</a>            </li>
            <li>
              <a href="//www.ubuntu-fr.org/telechargement" ><i class="fa fa-fw fa-arrow-circle-down" style="font-size: 1.3em;"></i> Télécharger Ubuntu</a>            </li>
          </ul>
        </div>
        <div class="col-sm-4">
          <h4>Obtenir de l'aide</h4>
          <ul class="list-group list-unstyled">
            <li>
              <a href="/tutoriel/comment_obtenir_une_reponse_satisfaisante" ><i class="fa fa-fw fa-info-circle" style="font-size: 1.3em;"></i> Chercher de l'aide</a>            </li>
            <li>
              <a href="//doc.ubuntu-fr.org/" ><i class="fa fa-fw fa-book" style="font-size: 1.3em;"></i> Consulter la documentation</a>            </li>
            <li>
              <a href="//forum.ubuntu-fr.org/" ><i class="fa fa-fw fa-comments" style="font-size: 1.3em;"></i> Consulter le Forum</a>            </li>
            <li>
              <a href="//guide.ubuntu-fr.org/" ><i class="fa fa-fw fa-question-circle" style="font-size: 1.3em;"></i> Lisez le guide</a>            </li>
          </ul>
        </div>
        <p>&nbsp;</p>
      </div>
      
      
      <div class="footer-license row">

        <div class="col-sm-6">
                    <p>
            <a href="http://creativecommons.org/licenses/by-sa/3.0/deed.fr" title="CC Paternité-Partage des Conditions Initiales à l'Identique 3.0 Unported" target="" itemscope itemtype="http://schema.org/CreativeWork" itemprop="license" rel="license" class="license"><img src="/lib/tpl/bootstrap3/images/license/cc.png" width="24" height="24" alt="cc" /> <img src="/lib/tpl/bootstrap3/images/license/by.png" width="24" height="24" alt="by" /> <img src="/lib/tpl/bootstrap3/images/license/sa.png" width="24" height="24" alt="sa" /> </a>          </p>
          <p class="small">
            Sauf mention contraire, le contenu de ce wiki est placé sous les termes de la licence suivante :<br/><a href="http://creativecommons.org/licenses/by-sa/3.0/deed.fr" title="CC Paternité-Partage des Conditions Initiales à l'Identique 3.0 Unported" target="" itemscope itemtype="http://schema.org/CreativeWork" itemprop="license" rel="license" class="license">CC Paternité-Partage des Conditions Initiales à l'Identique 3.0 Unported</a>          </p>
                  </div>

        <div class="col-sm-6">
                    <ul id="dw__badges" class="list-inline text-right hidden-print">

  <li>
    <a href="https://www.dokuwiki.org/template:bootstrap3" title="Bootstrap template for DokuWiki" target="">
      <img src="/lib/tpl/bootstrap3/images/bootstrap.png" width="20" alt="Bootstrap template for DokuWiki" />
    </a>
  </li>

  <li>
    <a href="https://www.php.net" title="Powered by PHP" target="">
      <img src="/lib/tpl/bootstrap3/images/php.png" width="20" alt="Powered by PHP" />
    </a>
  </li>

  <li>
    <a href="http://validator.w3.org/check/referer" title="Valid HTML5" target="">
      <img src="/lib/tpl/bootstrap3/images/html5.png" width="20" alt="Valid HTML5" />
    </a>
  </li>

  <li>
    <a href="http://jigsaw.w3.org/css-validator/check/referer?profile=css3" title="Valid CSS" target="">
      <img src="/lib/tpl/bootstrap3/images/css3.png" width="20" alt="Valid CSS" />
    </a>
  </li>

  <li>
    <a href="https://www.dokuwiki.org/" title="Driven by DokuWiki" target="">
      <img src="/lib/tpl/bootstrap3/images/logo.png" width="20" alt="Driven by DokuWiki" />
    </a>
  </li>

</ul>
                  </div>

      </div>

    </div>

  </div>
</footer>
<img src="/lib/exe/indexer.php?id=postfix_mysql_tls_sasl&amp;1635560993" width="2" height="1" alt="" />
    <a href="#dokuwiki__top" class="back-to-top hidden-print btn btn-default btn-sm" title="Aller au contenu" accesskey="t"><i class="fa fa-chevron-up"></i></a>

    <div id="screen__mode">      <span class="visible-xs-block"></span>
      <span class="visible-sm-block"></span>
      <span class="visible-md-block"></span>
      <span class="visible-lg-block"></span>
    </div>

  </div>

    <!-- Piwik -->
		<script type="text/javascript">
		  var _paq = _paq || [];
		  _paq.push(["setDomains", ["*.doc.ubuntu-fr.org","*.doc.edubuntu-fr.org","*.doc.lubuntu-fr.org","*.doc.xubuntu-fr.org","*.doc.edubuntu-fr.org","*.doc.lubuntu-fr.org","*.doc.ubuntu-fr.org","*.doc.xubuntu-fr.org"]]);
		  _paq.push(['trackPageView']);
		  _paq.push(['enableLinkTracking']);
		  (function() {
		    var u="//piwik.ubuntu-fr.org/";
		    _paq.push(['setTrackerUrl', u+'piwik.php']);
		    _paq.push(['setSiteId', 3]);
		    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
		    g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'piwik.js'; s.parentNode.insertBefore(g,s);
		  })();
		</script>
		<noscript><p><img src="//piwik.ubuntu-fr.org/piwik.php?idsite=3" style="border:0;" alt="" /></p></noscript>
		<!-- End Piwik Code -->

</body>
</html>
