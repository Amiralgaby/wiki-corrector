<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="fr"
  lang="fr" dir="ltr" class="no-js">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>tutoriel:pacemaker_configuration_ip_virtuelle_plus_script_lsb [Wiki ubuntu-fr]</title>
  <script>(function(H){H.className=H.className.replace(/\bno-js\b/,'js')})(document.documentElement)</script>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="shortcut icon" href="/_media/favicon.ico" />
<link rel="apple-touch-icon" href="/lib/tpl/bootstrap3/images/apple-touch-icon.png" />
    <meta name="generator" content="DokuWiki"/>
<meta name="robots" content="index,follow"/>
<meta name="keywords" content="lucid,tutoriel,haute disponibilite"/>
<link type="text/css" rel="stylesheet" href="/lib/tpl/bootstrap3/assets/fonts/united.fonts.css"/>
<link type="text/css" rel="stylesheet" href="/lib/tpl/bootstrap3/assets/font-awesome/css/font-awesome.min.css"/>
<link type="text/css" rel="stylesheet" href="/lib/tpl/bootstrap3/assets/bootstrap/united/bootstrap.min.css"/>
<link rel="search" type="application/opensearchdescription+xml" href="/lib/exe/opensearch.php" title="Wiki ubuntu-fr"/>
<link rel="start" href="/"/>
<link rel="contents" href="/tutoriel/pacemaker_configuration_ip_virtuelle_plus_script_lsb?do=index" title="Plan du site"/>
<link rel="manifest" href="/lib/exe/manifest.php"/>
<link rel="alternate" type="application/rss+xml" title="Derniers changements" href="/feed.php"/>
<link rel="alternate" type="application/rss+xml" title="Catégorie courante" href="/feed.php?mode=list&amp;ns=tutoriel"/>
<link rel="edit" title="Modifier cette page" href="/tutoriel/pacemaker_configuration_ip_virtuelle_plus_script_lsb?do=edit"/>
<link rel="alternate" type="text/html" title="HTML brut" href="/_export/xhtml/tutoriel/pacemaker_configuration_ip_virtuelle_plus_script_lsb"/>
<link rel="alternate" type="text/plain" title="Wiki balise" href="/_export/raw/tutoriel/pacemaker_configuration_ip_virtuelle_plus_script_lsb"/>
<link rel="canonical" href="http://doc.ubuntu-fr.org/tutoriel/pacemaker_configuration_ip_virtuelle_plus_script_lsb"/>
<link rel="stylesheet" type="text/css" href="/lib/exe/css.php?t=bootstrap3&amp;tseed=b4a19b95bb4d08daf02b6dd52d7e6abc"/>
<!--[if gte IE 9]><!-->
<script type="text/javascript">/*<![CDATA[*/var NS='tutoriel';var JSINFO = {"bootstrap3":{"mode":"show","toc":[],"config":{"collapsibleSections":0,"fixedTopNavbar":1,"showSemanticPopup":0,"sidebarOnNavbar":0,"tagsOnTop":1,"tocAffix":1,"tocCollapseOnScroll":1,"tocCollapsed":0,"tocLayout":"default","useAnchorJS":1}},"id":"tutoriel:pacemaker_configuration_ip_virtuelle_plus_script_lsb","namespace":"tutoriel","ACT":"show","useHeadingNavigation":0,"useHeadingContent":0};
/*!]]>*/</script>
<script type="text/javascript" charset="utf-8" src="/lib/exe/jquery.php?tseed=23f888679b4f1dc26eef34902aca964f"></script>
<script type="text/javascript" charset="utf-8" src="/lib/exe/js.php?t=bootstrap3&amp;tseed=b4a19b95bb4d08daf02b6dd52d7e6abc"></script>
<script type="text/javascript" src="/lib/tpl/bootstrap3/assets/bootstrap/js/bootstrap.min.js"></script>
<script type="text/javascript" src="/lib/tpl/bootstrap3/assets/anchorjs/anchor.min.js"></script>
<script type="text/javascript" src="/lib/tpl/bootstrap3/assets/typeahead/bootstrap3-typeahead.min.js"></script>
<!--<![endif]-->
<style type="text/css">@media screen { body { margin-top: 70px; }  #dw__toc.affix { top: 60px; position: fixed !important; }  #dw__toc .nav .nav .nav { display: none; } }</style>
    <!--[if lt IE 9]>
  <script type="text/javascript" src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
  <script type="text/javascript" src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
  <![endif]-->
</head>
<body class="united dokuwiki mode_show tpl_bootstrap3 dw-page-on-panel" data-page-id="tutoriel:pacemaker_configuration_ip_virtuelle_plus_script_lsb">

  <header id="dokuwiki__header" class="dokuwiki container">
    <nav id="dw__navbar" class="navbar navbar-fixed-top navbar-default" role="navigation">

  <div class="container">

    <div class="navbar-header">

      <button class="navbar-toggle" type="button" data-toggle="collapse" data-target=".navbar-collapse">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>

      <a href="/accueil"  accesskey="h" title="[H]" class="navbar-brand"><span class="uf uf-cof" id="dw__accueil" style="font-size: 35px;" ></span> <span id="dw__title" style="margin-top:-5px">Wiki ubuntu-fr<span id="dw__tagline">La Documentation francophone</span></span></a>
    </div>

    <div class="collapse navbar-collapse">

      
      <ul class="nav navbar-nav">
        <li>
          <a href="//ubuntu-fr.org/" ><i class="fa fa-2x fa-fw fa-home"></i><span> Accueil</span></a>        </li>
        <li>
          <a href="//forum.ubuntu-fr.org/" ><i class="fa fa-2x fa-fw fa-comments"></i><span> Forum</span></a>        </li>
        <li>
          <a href="//planet.ubuntu-fr.org/" ><i class="fa fa-2x fa-fw fa-globe"></i><span> Planet</span></a>        </li>
      </ul>

            
      
      <div class="navbar-right" id="dw__navbar_items">

        <form action="//forum.ubuntu-fr.org/search_ubuntufr.php" accept-charset="utf-8" class="navbar-form navbar-left search" id="dw__search" method="get" role="search"><div class="no"><input id="qsearch" autocomplete="off" type="search" placeholder="Rechercher" accesskey="f" name="q" class="form-control" title="[F]" /><button type="submit" title="Rechercher"><i class="fa fa-fw fa-search"></i></button><input type="hidden" name="do" value="search" /><input type="hidden" name="tsearch" value="wiki" /></div></form>
        
<ul class="nav navbar-nav dw-action-icon" id="dw__tools">


  <li class="dropdown">

    <a href="" class="dropdown-toggle" data-target="#" data-toggle="dropdown" title="" role="button" aria-haspopup="true" aria-expanded="false">
      <i class="fa fa-2x fa-fw fa-wrench"></i> <span class="hidden-lg hidden-md hidden-sm">Outils</span> <span class="caret"></span>
    </a>

    <ul class="dropdown-menu tools" role="menu">
    
      <li class="dropdown-header">
        <i class="fa fa-fw fa-cubes"></i> Outils du site      </li>
      <li><a href="/tutoriel/pacemaker_configuration_ip_virtuelle_plus_script_lsb?do=recent"  class="action recent" accesskey="r" rel="nofollow" title="Derniers changements [R]">Derniers changements</a></li><li><a href="/tutoriel/pacemaker_configuration_ip_virtuelle_plus_script_lsb?do=media&amp;ns=tutoriel"  class="action media" rel="nofollow" title="Gestionnaire Multimédia">Gestionnaire Multimédia</a></li><li><a href="/tutoriel/pacemaker_configuration_ip_virtuelle_plus_script_lsb?do=index"  class="action index" accesskey="x" rel="nofollow" title="Plan du site [X]">Plan du site</a></li>
            <li class="divider" role="separator"></li>
      
    
      <li class="dropdown-header">
        <i class="fa fa-fw fa-file"></i> Outils de la page      </li>
      <li><a href="/tutoriel/pacemaker_configuration_ip_virtuelle_plus_script_lsb?do=edit"  class="action edit" accesskey="e" rel="nofollow" title="Modifier cette page [E]">Modifier cette page</a></li><li><a href="/tutoriel/pacemaker_configuration_ip_virtuelle_plus_script_lsb?do=revisions"  class="action revs" accesskey="o" rel="nofollow" title="Anciennes révisions [O]">Anciennes révisions</a></li><li><a href="/tutoriel/pacemaker_configuration_ip_virtuelle_plus_script_lsb?do=backlink"  class="action backlink" rel="nofollow" title="Liens de retour">Liens de retour</a></li><li><a href="#dokuwiki__top"  class="action top" accesskey="t" rel="nofollow" title="Haut de page [T]">Haut de page</a></li>
      
        </ul>
  </li>


</ul>


        <ul class="nav navbar-nav">

          
          
                    <li>
            <span class="dw__actions dw-action-icon">
              <a href="/tutoriel/pacemaker_configuration_ip_virtuelle_plus_script_lsb?do=login&amp;sectok="  class="action btn btn-default navbar-btn login" rel="nofollow" title="S&#039;identifier"><span class="">S'identifier</span></a>            </span>
          </li>
          
        </ul>

        
        

      </div>

    </div>
  </div>
</nav>
  </header>

  <div id="dokuwiki__top" class="dokuwiki container">

    <div id="dokuwiki__pageheader">

      
      
      <p class="pageId text-right small">
        <span class="label label-primary">tutoriel:pacemaker_configuration_ip_virtuelle_plus_script_lsb</span>      </p>

      <div id="dw__msgarea" class="small">
              </div>

    </div>

    <main class="main row" role="main">

      
      <article id="dokuwiki__content" class="container" itemscope itemtype="http://schema.org/Article" itemref="dw__license">

        
<nav id="dw__pagetools" class="hidden-print">
  <div class="tools panel panel-default pull-right ">
    <ul class="nav nav-stacked nav-pills">
      <li><a href="/tutoriel/pacemaker_configuration_ip_virtuelle_plus_script_lsb?do=edit"  class="action text-muted edit" accesskey="e" rel="nofollow" title="Modifier cette page [E]"><i class="fa fa-fw fa-pencil-square-o"></i><span class="sr-only"> Modifier cette page</span></a></li><li><a href="/tutoriel/pacemaker_configuration_ip_virtuelle_plus_script_lsb?do=revisions"  class="action text-muted revs" accesskey="o" rel="nofollow" title="Anciennes révisions [O]"><i class="fa fa-fw fa-clock-o"></i><span class="sr-only"> </span></a></li><li><a href="/tutoriel/pacemaker_configuration_ip_virtuelle_plus_script_lsb?do=backlink"  class="action text-muted backlink" rel="nofollow" title="Liens de retour"><i class="fa fa-fw fa-link"></i><span class="sr-only"> Liens de retour</span></a></li>    </ul>
  </div>
</nav>

        <div class="panel panel-default" itemprop="articleBody">
          <div class="page panel-body">

            <div class="dw-content-page "><div class="dw-toc hidden-print"><script>JSINFO.bootstrap3.toc = [{"link":"#pre-requis","title":"Pr\u00e9-requis","level":1},{"link":"#configuration","title":"Configuration","level":1},{"link":"#parametrage_des_options_generales","title":"Param\u00e9trage des options g\u00e9n\u00e9rales","level":2},{"link":"#parametrage_du_service_nginx","title":"Param\u00e9trage du service nginx","level":2},{"link":"#parametrage_de_l_ip_virtuelle","title":"Param\u00e9trage de l'ip virtuelle","level":2},{"link":"#lien_entre_les_ressources","title":"Lien entre les ressources","level":2},{"link":"#verification_et_application_de_la_configuration","title":"V\u00e9rification et application de la configuration","level":2},{"link":"#afficher_l_etat_du_cluster","title":"Afficher l'\u00e9tat du cluster","level":2},{"link":"#tester_sa_configuration","title":"Tester sa configuration","level":1},{"link":"#meurtre_du_processus_nginx","title":"Meurtre du processus nginx","level":2},{"link":"#blocage_du_redemarrage_du_serveur_nginx","title":"Blocage du red\u00e9marrage du serveur nginx","level":2},{"link":"#voir_aussi","title":"Voir aussi","level":1}];</script>
<!-- TOC START -->
<nav id="dw__toc" role="navigation" class="toc-panel panel panel-default small">
<h6 data-toggle="collapse" data-target="#dw__toc .toc-body" title="Table des matières" class="panel-heading toc-title"><i class="fa fa-fw fa-th-list"></i> <span>Table des matières</span> <i class="caret"></i></h6>
<div class="panel-body  toc-body collapse in">

<ul class="nav toc">
<li class="level1"><a href="#pre-requis">Pré-requis</a></li>
<li class="level1"><a href="#configuration">Configuration</a>
<ul class="nav toc">
<li class="level2"><a href="#parametrage_des_options_generales">Paramétrage des options générales</a></li>
<li class="level2"><a href="#parametrage_du_service_nginx">Paramétrage du service nginx</a></li>
<li class="level2"><a href="#parametrage_de_l_ip_virtuelle">Paramétrage de l&#039;ip virtuelle</a></li>
<li class="level2"><a href="#lien_entre_les_ressources">Lien entre les ressources</a></li>
<li class="level2"><a href="#verification_et_application_de_la_configuration">Vérification et application de la configuration</a></li>
<li class="level2"><a href="#afficher_l_etat_du_cluster">Afficher l&#039;état du cluster</a></li>
</ul>
</li>
<li class="level1"><a href="#tester_sa_configuration">Tester sa configuration</a>
<ul class="nav toc">
<li class="level2"><a href="#meurtre_du_processus_nginx">Meurtre du processus nginx</a></li>
<li class="level2"><a href="#blocage_du_redemarrage_du_serveur_nginx">Blocage du redémarrage du serveur nginx</a></li>
</ul>
</li>
<li class="level1"><a href="#voir_aussi">Voir aussi</a></li>
</ul>

</div>
</nav>
<!-- TOC END -->
</div><!-- CONTENT --><div class="dw-content"><div class="notetag">Selon les <a href="/tags">tags</a> présents sur cette page, celle-ci n'a pas été vérifiée pour une des <a href="/versions">versions LTS supportées d'Ubuntu</a>.<br />
<a href="/wiki/participer_wiki">Apportez votre aide…</a>
</div>
<div class="tags"><span>
	<a href="/lucid" class="wikilink1" title="lucid" rel="tag">Lucid</a>,
	<a href="/tutoriel" class="wikilink1" title="tutoriel" rel="tag">tutoriel</a>,
	<a href="/haute_disponibilite" class="wikilink1" title="haute_disponibilite" rel="tag">haute disponibilité</a>
</span></div>
<hr />

<h1 class="sectionedit1 page-header" id="cluster_de_deux_machines_ip_virtuelle_supervision_d_un_service">Cluster de deux machines ip virtuelle + supervision d&#039;un service</h1>
<div class="level1">

<p>
Ce tutoriel est une sous-partie de la documentation pacemaker. Il décrit les différentes étapes de configuration du cluster par l&#039;intermédiaire de la commande crm. Je vous conseille néanmoins de configurer les ressources avec l&#039;interface java de Linbit.
</p>

<p>
Le but de cette configuration est de créer un cluster de serveur web (ou de reverse proxy) de deux machines. Une adresse virtuelle est partagée entre les deux machines, lorsque l&#039;une d&#039;entre elle est hors ligne l&#039;autre machine peut prendre le relai automatiquement.
</p>

<p>
Détail des étapes de la configuration:
</p>
<ol class=" fix-media-list-overlap">
<li class="level1"><div class="li"> Adresse ip virtuelle partagée entre les deux membres du cluster ici 192.168.1.100</div>
</li>
<li class="level1"><div class="li"> Lancement, arrêt et supervision d&#039;un service par l&#039;intermédiaire d&#039;un script d&#039;initialisation compatible LSB (ici nginx)</div>
</li>
<li class="level1"><div class="li"> Clonage du service, nginx sera démarré sur les deux machines</div>
</li>
<li class="level1"><div class="li"> Ordonnancement des ressources le service, nginx devra être démarré pour que l&#039;adresse ip virtuelle soit attribuée à un membre du cluster</div>
</li>
</ol>
<div class="table-responsive"><table class="inline table table-striped table-condensed">
	<thead>
	<tr class="row0">
		<td class="col0 leftalign">              </td><th class="col1 leftalign"> Nom de poste                  </th><th class="col2 leftalign"> Adresse ip          </th>
	</tr>
	</thead>
	<tr class="row1">
		<th class="col0 leftalign"> pc 1      </th><td class="col1 leftalign"> machine1            </td><td class="col2 leftalign"> 192.168.1.101    </td>
	</tr>
	<tr class="row2">
		<th class="col0 leftalign"> pc 2      </th><td class="col1 leftalign"> machine2            </td><td class="col2 leftalign"> 192.168.1.102    </td>
	</tr>
</table></div>

</div>
<div class='secedit editbutton_section editbutton_1'><form class="button btn_secedit form-inline" method="post" action="/tutoriel/pacemaker_configuration_ip_virtuelle_plus_script_lsb"><div class="no"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="1583598005" /><input type="hidden" name="summary" value="[Cluster de deux machines ip virtuelle + supervision d&#039;un service] " /><input type="hidden" name="target" value="section" /><input type="hidden" name="hid" value="cluster_de_deux_machines_ip_virtuelle_supervision_d_un_service" /><input type="hidden" name="codeblockOffset" value="0" /><input type="hidden" name="range" value="51-1312" /><button type="submit" title="Cluster de deux machines ip virtuelle + supervision d&#039;un service" class=" btn btn-default btn btn-xs btn-default">Modifier</button></div></form></div>
<h2 class="sectionedit3 page-header" id="pre-requis">Pré-requis</h2>
<div class="level2">
<ul class=" fix-media-list-overlap">
<li class="level1"><div class="li"> Bien connaître le principe de fonctionnement de <a href="/pacemaker" class="wikilink1" title="pacemaker">pacemaker</a>.</div>
</li>
<li class="level1"><div class="li"> Comprendre le principe de la norme LSB pour les scripts d&#039;initialisation. </div>
</li>
</ul>
<div class="noteclassic">Les scripts d&#039;initialisation sont ceux disponibles dans le répertoire /etc/init.d/. Pacemaker va les utiliser pour démarrer, arrêter et superviser l&#039;état du service. C&#039;est pourquoi ces scripts doivent respecter les normes lsb. Pacemaker a par exemple besoin que les scripts possèdent un argument status. Pour plus d&#039;informations visitez cette <a href="http://wiki.debian.org/LSBInitScripts" class="urlextern" title="http://wiki.debian.org/LSBInitScripts" rel="nofollow">page</a>

</div><ul class=" fix-media-list-overlap">
<li class="level1"><div class="li"> Avoir effectué le tutoriel officiel en anglais est une bonne chose. <a href="http://www.clusterlabs.org/doc/en-US/Pacemaker/1.1/html/Clusters_from_Scratch/index.html" class="urlextern" title="http://www.clusterlabs.org/doc/en-US/Pacemaker/1.1/html/Clusters_from_Scratch/index.html" rel="nofollow">lien</a> </div>
</li>
<li class="level1"><div class="li"> Ne pas avoir peur de lire la documentation officielle de pacemaker qui se trouve <a href="http://www.clusterlabs.org/doc/en-US/Pacemaker/1.1/html/Pacemaker_Explained/index.html" class="urlextern" title="http://www.clusterlabs.org/doc/en-US/Pacemaker/1.1/html/Pacemaker_Explained/index.html" rel="nofollow">ici</a>.</div>
</li>
</ul>

</div>
<div class='secedit editbutton_section editbutton_3'><form class="button btn_secedit form-inline" method="post" action="/tutoriel/pacemaker_configuration_ip_virtuelle_plus_script_lsb"><div class="no"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="1583598005" /><input type="hidden" name="summary" value="[Pré-requis] " /><input type="hidden" name="target" value="section" /><input type="hidden" name="hid" value="pre-requis" /><input type="hidden" name="codeblockOffset" value="0" /><input type="hidden" name="range" value="1313-2253" /><button type="submit" title="Pré-requis" class=" btn btn-default btn btn-xs btn-default">Modifier</button></div></form></div>
<h2 class="sectionedit4 page-header" id="configuration">Configuration</h2>
<div class="level2">

<p>
Entrer dans le mode de configuration du cluster
</p>
<pre class="code">sudo crm configure</pre>

</div>
<div class='secedit editbutton_section editbutton_4'><form class="button btn_secedit form-inline" method="post" action="/tutoriel/pacemaker_configuration_ip_virtuelle_plus_script_lsb"><div class="no"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="1583598005" /><input type="hidden" name="summary" value="[Configuration] " /><input type="hidden" name="target" value="section" /><input type="hidden" name="hid" value="configuration" /><input type="hidden" name="codeblockOffset" value="0" /><input type="hidden" name="range" value="2254-2355" /><button type="submit" title="Configuration" class=" btn btn-default btn btn-xs btn-default">Modifier</button></div></form></div>
<h3 class="sectionedit5" id="parametrage_des_options_generales">Paramétrage des options générales</h3>
<div class="level3">

<p>
Premierement nous allons désactiver deux fonctionnalités inutile pour notre cluster 
</p>
<ul class=" fix-media-list-overlap">
<li class="level1"><div class="li"> mode stonith &quot;shot the other node in the head&quot; permet lorsqu&#039;une machine n&#039;est plus joignable d&#039;être sur que cette machine soit bien hors ligne</div>
</li>
<li class="level1"><div class="li"> quorum indique le nombre minimal de membres pour prendre une décision. Ce paramètre est utile pour les cluster de plus de deux machines</div>
</li>
</ul>

<p>
Désactivation du mode stonith
</p>
<pre class="code">property stonith-enabled=false</pre>

<p>
Désctivation du paramètre quorum
</p>
<pre class="code">property no-quorum-policy=ignore </pre>

</div>
<div class='secedit editbutton_section editbutton_5'><form class="button btn_secedit form-inline" method="post" action="/tutoriel/pacemaker_configuration_ip_virtuelle_plus_script_lsb"><div class="no"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="1583598005" /><input type="hidden" name="summary" value="[Paramétrage des options générales] " /><input type="hidden" name="target" value="section" /><input type="hidden" name="hid" value="parametrage_des_options_generales" /><input type="hidden" name="codeblockOffset" value="0" /><input type="hidden" name="range" value="2356-2928" /><button type="submit" title="Paramétrage des options générales" class=" btn btn-default btn btn-xs btn-default">Modifier</button></div></form></div>
<h3 class="sectionedit6" id="parametrage_du_service_nginx">Paramétrage du service nginx</h3>
<div class="level3">

<p>
Avant toute chose pensez à désactiver le démarrage automatique du démon avec la commande ci dessous 
</p>
<pre class="code">sudo update-rc.d -f nginx remove</pre>

<p>
Ensuite nous allons indiquer à pacemaker de superviser le processus nginx. Pour cela il est nécessaire que le logiciel possède un script de démarrage et d&#039;arrêt dans le répertoire /etc/init.d. Ce script doit en outre respecter les normes LSB (si il est est déjà présent il doit sûrement les respecter). A l&#039;avenir c&#039;est pacemaker qui démarrera nginx par intermédiaire de ce script. 
</p>

<p>
Instruction permettant à pacemaker de superviser un programme par l&#039;intermédiaire de son script systemV (init script)
</p>

<p>
Syntaxe de base
</p>
<pre class="code">primitive &lt;nom de la ressource (ce que vous voulez)&gt; lsb::&lt;nom du démon&gt; op monitor interval=5s</pre>

<p>
Dans notre cas 
</p>
<pre class="code">primitive reverse-proxy lsb::nginx op monitor interval=5s</pre>

<p>
Clonage de la ressource pour que le démon nginx soit démarré sur les deux machines en même temps. Cela permet une migration plus rapide. Pacemaker n&#039;ayant pas à démarrer le processus puis à faire migrer l&#039;adresse ip.
</p>

<p>
Syntaxe de base
</p>
<pre class="code">clone &lt;nom de la ressource&gt; &lt;nom de la ressource à cloner&gt;</pre>

<p>
Dans notre cas 
</p>
<pre class="code">clone clone_reverse_proxy reverse-proxy </pre>

</div>
<div class='secedit editbutton_section editbutton_6'><form class="button btn_secedit form-inline" method="post" action="/tutoriel/pacemaker_configuration_ip_virtuelle_plus_script_lsb"><div class="no"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="1583598005" /><input type="hidden" name="summary" value="[Paramétrage du service nginx] " /><input type="hidden" name="target" value="section" /><input type="hidden" name="hid" value="parametrage_du_service_nginx" /><input type="hidden" name="codeblockOffset" value="0" /><input type="hidden" name="range" value="2929-4197" /><button type="submit" title="Paramétrage du service nginx" class=" btn btn-default btn btn-xs btn-default">Modifier</button></div></form></div>
<h3 class="sectionedit7" id="parametrage_de_l_ip_virtuelle">Paramétrage de l&#039;ip virtuelle</h3>
<div class="level3">

<p>
Création d&#039;une ip virtuelle partagée entre les deux membres du cluster
</p>
<pre class="code">  primitive &lt;nom de la ressource&gt; ocf:heartbeat:IPaddr2 params ip=&quot;&lt;adresse ip virtuelle&gt;&quot; broadcast=&quot;&lt;adresse de broadcast&gt;&quot; cidr_netmask=&quot;&lt;masque en écriture décimal&gt;&quot; nic=&quot;&lt;nom de l&#039;interface virtuelle&gt;&quot; meta target-role=&quot;started&quot; migration-threshold=&quot;2&quot; resource-stickiness=&quot;100&quot;
 op monitor interval=&quot;&lt;interval de temps de supervision&gt;&quot;</pre>

<p>
explications:
</p>
<div class="table-responsive"><table class="inline table table-striped table-condensed">
	<thead>
	<tr class="row0">
		<th class="col0 leftalign"> Options         </th><th class="col1 leftalign"> explications           </th>
	</tr>
	</thead>
	<tr class="row1">
		<td class="col0 leftalign"> target-role   </td><td class="col1 leftalign"> started ou stopped l&#039;état dans lequel pacemaker doit maintenir la ressource     </td>
	</tr>
	<tr class="row2">
		<td class="col0 leftalign"> migration-threshold   </td><td class="col1 leftalign"> nombre maximal d&#039;échec de la ressource, après lesquels la machine est déclarée inéligible pour recevoir la ressource     </td>
	</tr>
	<tr class="row3">
		<td class="col0 leftalign"> resource-stickiness   </td><td class="col1 leftalign"> Ce paramètre est utile lorsque l&#039;on définit une règle &quot;location&quot; indiquant la machine élue par défaut pour héberger la ressource. Nous ferons une configuration de ce type plus tard. Ce paramètre empêche la ressource de retourner sur la machine élue par défaut après que celle ci est défaillit et soit revenue en ligne. La ressource devra être migrée manuellement.  La valeure numérique attribuée à ce paramètre doit être supérieure à celle attribuée dans la règle &quot;location&quot;.   </td>
	</tr>
</table></div>

<p>
Dans notre cas 
</p>
<pre class="code"> 
  primitive ip_virtuelle ocf:heartbeat:IPaddr2 params ip=&quot;192.168.1.100&quot; broadcast=&quot;192.168.1.255&quot; cidr_netmask=&quot;24&quot; nic=&quot;eth0:0&quot; meta target-role=&quot;started&quot; migration-threshold=&quot;2&quot; resource-stickiness=&quot;100&quot;
 op monitor interval=&quot;10s&quot;</pre>

</div>
<div class='secedit editbutton_section editbutton_7'><form class="button btn_secedit form-inline" method="post" action="/tutoriel/pacemaker_configuration_ip_virtuelle_plus_script_lsb"><div class="no"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="1583598005" /><input type="hidden" name="summary" value="[Paramétrage de l&#039;ip virtuelle] " /><input type="hidden" name="target" value="section" /><input type="hidden" name="hid" value="parametrage_de_l_ip_virtuelle" /><input type="hidden" name="codeblockOffset" value="0" /><input type="hidden" name="range" value="4198-5791" /><button type="submit" title="Paramétrage de l&#039;ip virtuelle" class=" btn btn-default btn btn-xs btn-default">Modifier</button></div></form></div>
<h3 class="sectionedit9" id="lien_entre_les_ressources">Lien entre les ressources</h3>
<div class="level3">

<p>
Par défaut pacemaker répartie les ressources entre les membres du cluster. Bien qu&#039;ici une des ressources soit clonée il est préférable de créér un lien entre les deux ressources  <em>clone_reverse_proxy</em> et <em>ip_virtuelle</em>
</p>

<p>
Syntaxe de base 
</p>
<pre class="code">colocation link-ressources INFINITY: &lt;nom de la deuxième ressource&gt;  &lt;nom de la première ressource&gt;</pre>

<p>
Dans notre cas 
</p>
<pre class="code">colocation link-ressources INFINITY: ip_virtuelle clone_reverse_proxy </pre>

<p>
Il est aussi nécessaire d&#039;établir un ordre de démarrage entre les ressources. En effet l&#039;ip virtuelle ne doit être activée que si le démon nginx est lancée
</p>

<p>
Syntaxe de base 
</p>
<pre class="code">order &lt;nom de la ressource&gt; mandatory: &lt;première ressource à lancer&gt;  &lt;deuxième ressource&gt;</pre>

<p>
Dans notre cas 
</p>
<pre class="code">order demon_before mandatory: clone_reverse_proxy  ip_virtuelle</pre>

<p>
Il peut aussi être intéressant de choisir une machine préférée pour accueillir la ressource. Ici nous voulons que l&#039;adresse ip virtuelle soit activée par défaut sur la machine1.
</p>

<p>
Syntaxe de base
</p>
<pre class="code">location &lt;nom ressource&gt; &lt;nom de la ressource&gt; &lt;score&gt;: &lt;nom du poste&gt;</pre>

<p>
Dans notre cas 
</p>
<pre class="code">location node-master ip_virtuelle 50: machine1</pre>

</div>
<div class='secedit editbutton_section editbutton_9'><form class="button btn_secedit form-inline" method="post" action="/tutoriel/pacemaker_configuration_ip_virtuelle_plus_script_lsb"><div class="no"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="1583598005" /><input type="hidden" name="summary" value="[Lien entre les ressources] " /><input type="hidden" name="target" value="section" /><input type="hidden" name="hid" value="lien_entre_les_ressources" /><input type="hidden" name="codeblockOffset" value="2" /><input type="hidden" name="range" value="5792-6990" /><button type="submit" title="Lien entre les ressources" class=" btn btn-default btn btn-xs btn-default">Modifier</button></div></form></div>
<h3 class="sectionedit10" id="verification_et_application_de_la_configuration">Vérification et application de la configuration</h3>
<div class="level3">

<p>
Vérifier que votre configuration est correcte, normalement l&#039;analyse ne doit pas rapporter d&#039;erreurs
</p>
<pre class="code">verify</pre>

<p>
Puis appliquez votre configuration au cluster
</p>
<pre class="code">commit</pre>

</div>
<div class='secedit editbutton_section editbutton_10'><form class="button btn_secedit form-inline" method="post" action="/tutoriel/pacemaker_configuration_ip_virtuelle_plus_script_lsb"><div class="no"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="1583598005" /><input type="hidden" name="summary" value="[Vérification et application de la configuration] " /><input type="hidden" name="target" value="section" /><input type="hidden" name="hid" value="verification_et_application_de_la_configuration" /><input type="hidden" name="codeblockOffset" value="2" /><input type="hidden" name="range" value="6991-7223" /><button type="submit" title="Vérification et application de la configuration" class=" btn btn-default btn btn-xs btn-default">Modifier</button></div></form></div>
<h3 class="sectionedit11" id="afficher_l_etat_du_cluster">Afficher l&#039;état du cluster</h3>
<div class="level3">

<p>
Affichage de l&#039;état du cluster, avec les compteurs d&#039;échecs
</p>
<pre class="code">sudo crm_mon -1f</pre>

<p>
Vous devriez voir un résultat semblable
</p>
<pre class="code">Online: [ machine1 machine2 ]
Clone Set: clone_reverse_proxy
   Started: [ machine1 machine2 ]
ip_virtuelle	(ocf::heartbeat:IPaddr2):	Started machine1</pre>

</div>
<div class='secedit editbutton_section editbutton_11'><form class="button btn_secedit form-inline" method="post" action="/tutoriel/pacemaker_configuration_ip_virtuelle_plus_script_lsb"><div class="no"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="1583598005" /><input type="hidden" name="summary" value="[Afficher l&#039;état du cluster] " /><input type="hidden" name="target" value="section" /><input type="hidden" name="hid" value="afficher_l_etat_du_cluster" /><input type="hidden" name="codeblockOffset" value="2" /><input type="hidden" name="range" value="7224-7549" /><button type="submit" title="Afficher l&#039;état du cluster" class=" btn btn-default btn btn-xs btn-default">Modifier</button></div></form></div>
<h2 class="sectionedit12 page-header" id="tester_sa_configuration">Tester sa configuration</h2>
<div class="level2">

<p>
Vous pouvez facilement vous rendre compte des migrations de ressources dans le cluster en personnalisant les pages internet des serveurs webs nginx. Le chemin de la page d&#039;accueil est <em>/var/www/nginx-default/index.html</em> .
</p>

</div>
<div class='secedit editbutton_section editbutton_12'><form class="button btn_secedit form-inline" method="post" action="/tutoriel/pacemaker_configuration_ip_virtuelle_plus_script_lsb"><div class="no"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="1583598005" /><input type="hidden" name="summary" value="[Tester sa configuration] " /><input type="hidden" name="target" value="section" /><input type="hidden" name="hid" value="tester_sa_configuration" /><input type="hidden" name="codeblockOffset" value="2" /><input type="hidden" name="range" value="7550-7810" /><button type="submit" title="Tester sa configuration" class=" btn btn-default btn btn-xs btn-default">Modifier</button></div></form></div>
<h3 class="sectionedit13" id="meurtre_du_processus_nginx">Meurtre du processus nginx</h3>
<div class="level3">

<p>
Effectuer les commandes sur le poste hébergeant l&#039;adresse ip virtuelle.
</p>
<pre class="code">ps -aux | grep nginx
kill &lt;numéro processus&gt;</pre>

<p>
Vous devriez voir que le compteur d&#039;échec a été incrémenté 
</p>
<pre class="code">Online: [ machine1 machine2 ]
Clone Set: clone_reverse_proxy
   Started: [ machine1 machine2 ]
ip_virtuelle	(ocf::heartbeat:IPaddr2):	Started machine1
Migration summary:
* Node machine2: 
* Node machine1: 
   reverse-proxy:0: migration-threshold=1000000 fail-count=1</pre>

<p>
et si vous effectuez cette commande 
</p>
<pre class="code">sudo /etc/init.d/nginx status</pre>

<p>
Elle devrait vous retourner ce retour 
</p>
<pre class="code">nginx is running</pre>

<p>
Le processus a bien été redémarré après qu&#039;il a été tué. Il n&#039;y a pas eu de migration de l&#039;adresse ip.
</p>

</div>
<div class='secedit editbutton_section editbutton_13'><form class="button btn_secedit form-inline" method="post" action="/tutoriel/pacemaker_configuration_ip_virtuelle_plus_script_lsb"><div class="no"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="1583598005" /><input type="hidden" name="summary" value="[Meurtre du processus nginx] " /><input type="hidden" name="target" value="section" /><input type="hidden" name="hid" value="meurtre_du_processus_nginx" /><input type="hidden" name="codeblockOffset" value="2" /><input type="hidden" name="range" value="7811-8570" /><button type="submit" title="Meurtre du processus nginx" class=" btn btn-default btn btn-xs btn-default">Modifier</button></div></form></div>
<h3 class="sectionedit14" id="blocage_du_redemarrage_du_serveur_nginx">Blocage du redémarrage du serveur nginx</h3>
<div class="level3">

<p>
Cette fois ci nous allons être un peu plus pervers. Nous allons empêcher le serveur nginx de redémarrer. Normalement l&#039;adresse ip devrait migrer vers l&#039;autre machine.
</p>

<p>
Éditer le fichier /etc/nginx/nginx.conf et ajouter cette ligne au début du fichier
</p>
<pre class="code">plop !</pre>

<p>
Tuer à nouveau le processus du démon nginx 
</p>

<p>
Vous devriez obtenir ce résultat
</p>
<pre class="code">Online: [ machine1 machine2 ]
Clone Set: clone_reverse_proxy
   Started: [ machine2 ]
   Stopped: [ reverse-proxy:0 ]
ip_virtuelle	(ocf::heartbeat:IPaddr2):	Started machine2
Migration summary:
* Node machine2: 
* Node machine1: 
   reverse-proxy:0: migration-threshold=1000000 fail-count=1000000</pre>

<p>
On peut voir que l&#039;adresse ip virtuelle a été migrée vers la machine 2 et que le compteur d&#039;échec a été fixé à sa valeur maximale.
</p>

</div>
<div class='secedit editbutton_section editbutton_14'><form class="button btn_secedit form-inline" method="post" action="/tutoriel/pacemaker_configuration_ip_virtuelle_plus_script_lsb"><div class="no"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="1583598005" /><input type="hidden" name="summary" value="[Blocage du redémarrage du serveur nginx] " /><input type="hidden" name="target" value="section" /><input type="hidden" name="hid" value="blocage_du_redemarrage_du_serveur_nginx" /><input type="hidden" name="codeblockOffset" value="2" /><input type="hidden" name="range" value="8571-9428" /><button type="submit" title="Blocage du redémarrage du serveur nginx" class=" btn btn-default btn btn-xs btn-default">Modifier</button></div></form></div>
<h2 class="sectionedit15 page-header" id="voir_aussi">Voir aussi</h2>
<div class="level2">
<ul class=" fix-media-list-overlap">
<li class="level1"><div class="li"> <strong>(fr)</strong> <a href="/pacemaker" class="wikilink1" title="pacemaker">fiche du logiciel pacemaker</a></div>
</li>
</ul>
<hr />

<p>
<em>Contributeurs principaux : <a href="/utilisateurs/miam_miam" class="wikilink1" title="utilisateurs:miam_miam">Miam Miam</a>.</em>
</p>

</div>
<div class='secedit editbutton_section editbutton_15'><form class="button btn_secedit form-inline" method="post" action="/tutoriel/pacemaker_configuration_ip_virtuelle_plus_script_lsb"><div class="no"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="1583598005" /><input type="hidden" name="summary" value="[Voir aussi] " /><input type="hidden" name="target" value="section" /><input type="hidden" name="hid" value="voir_aussi" /><input type="hidden" name="codeblockOffset" value="2" /><input type="hidden" name="range" value="9429-" /><button type="submit" title="Voir aussi" class=" btn btn-default btn btn-xs btn-default">Modifier</button></div></form></div>
</div><!-- /CONTENT --></div>
          </div>
        </div>

        <div class="small text-right">

                    <span class="docInfo">
            <ul class="list-inline"><li><i class="fa fa-fw fa-file-text-o text-muted"></i> <span title="tutoriel/pacemaker_configuration_ip_virtuelle_plus_script_lsb.txt">tutoriel/pacemaker_configuration_ip_virtuelle_plus_script_lsb.txt</span></li><li><i class="fa fa-fw fa-calendar text-muted"></i> Dernière modification: <span title="Le 07/03/2020, 17:20">Le 07/03/2020, 17:20</span></li><li class="text-muted">par 5.51.84.115</li></ul>          </span>
          
          
        </div>

      </article>

      
    </main>

    <footer id="dw__footer" class="navbar navbar-default">
  <div class="container">

    <div class="small navbar-text">

            <div class="footer-dw-title row">
        <div class="media col-sm-4">
          <!--<div class="media-left">
            <img src="/_media/logo.png" alt="Wiki ubuntu-fr" class="media-object" style="width:32px" />
          </div> -->
          <div class="media-body">
            <h4 class="media-heading">Documentation ubuntu-fr</h4>
            <p>
              Les pages de cette documentation sont rédigées par les utilisateurs
              pour les utilisateurs. Apportez-nous votre aide pour améliorer
              le contenu de cette documentation.
            </p>
          </div>
        </div>
        <div class="col-sm-4">
          <h4>Liens utiles</h4>
          <ul class="list-group list-unstyled">
            <li>
              <a href="/debutant" ><i class="fa fa-fw fa-child" style="font-size: 1.3em;"></i> Débuter sur Ubuntu</a>            </li>
            <li>
              <a href="/wiki/participer_wiki" ><i class="fa fa-fw fa-edit" style="font-size: 1.3em;"></i> Participer à la documentation</a>            </li>
            <li>
              <a href="/documentation_hors_ligne" ><i class="fa fa-fw fa-book" style="font-size: 1.3em;"></i> Documentation hors ligne</a>            </li>
            <li>
              <a href="//www.ubuntu-fr.org/telechargement" ><i class="fa fa-fw fa-arrow-circle-down" style="font-size: 1.3em;"></i> Télécharger Ubuntu</a>            </li>
          </ul>
        </div>
        <div class="col-sm-4">
          <h4>Obtenir de l'aide</h4>
          <ul class="list-group list-unstyled">
            <li>
              <a href="/tutoriel/comment_obtenir_une_reponse_satisfaisante" ><i class="fa fa-fw fa-info-circle" style="font-size: 1.3em;"></i> Chercher de l'aide</a>            </li>
            <li>
              <a href="//doc.ubuntu-fr.org/" ><i class="fa fa-fw fa-book" style="font-size: 1.3em;"></i> Consulter la documentation</a>            </li>
            <li>
              <a href="//forum.ubuntu-fr.org/" ><i class="fa fa-fw fa-comments" style="font-size: 1.3em;"></i> Consulter le Forum</a>            </li>
            <li>
              <a href="//guide.ubuntu-fr.org/" ><i class="fa fa-fw fa-question-circle" style="font-size: 1.3em;"></i> Lisez le guide</a>            </li>
          </ul>
        </div>
        <p>&nbsp;</p>
      </div>
      
      
      <div class="footer-license row">

        <div class="col-sm-6">
                    <p>
            <a href="http://creativecommons.org/licenses/by-sa/3.0/deed.fr" title="CC Paternité-Partage des Conditions Initiales à l'Identique 3.0 Unported" target="" itemscope itemtype="http://schema.org/CreativeWork" itemprop="license" rel="license" class="license"><img src="/lib/tpl/bootstrap3/images/license/cc.png" width="24" height="24" alt="cc" /> <img src="/lib/tpl/bootstrap3/images/license/by.png" width="24" height="24" alt="by" /> <img src="/lib/tpl/bootstrap3/images/license/sa.png" width="24" height="24" alt="sa" /> </a>          </p>
          <p class="small">
            Sauf mention contraire, le contenu de ce wiki est placé sous les termes de la licence suivante :<br/><a href="http://creativecommons.org/licenses/by-sa/3.0/deed.fr" title="CC Paternité-Partage des Conditions Initiales à l'Identique 3.0 Unported" target="" itemscope itemtype="http://schema.org/CreativeWork" itemprop="license" rel="license" class="license">CC Paternité-Partage des Conditions Initiales à l'Identique 3.0 Unported</a>          </p>
                  </div>

        <div class="col-sm-6">
                    <ul id="dw__badges" class="list-inline text-right hidden-print">

  <li>
    <a href="https://www.dokuwiki.org/template:bootstrap3" title="Bootstrap template for DokuWiki" target="">
      <img src="/lib/tpl/bootstrap3/images/bootstrap.png" width="20" alt="Bootstrap template for DokuWiki" />
    </a>
  </li>

  <li>
    <a href="https://www.php.net" title="Powered by PHP" target="">
      <img src="/lib/tpl/bootstrap3/images/php.png" width="20" alt="Powered by PHP" />
    </a>
  </li>

  <li>
    <a href="http://validator.w3.org/check/referer" title="Valid HTML5" target="">
      <img src="/lib/tpl/bootstrap3/images/html5.png" width="20" alt="Valid HTML5" />
    </a>
  </li>

  <li>
    <a href="http://jigsaw.w3.org/css-validator/check/referer?profile=css3" title="Valid CSS" target="">
      <img src="/lib/tpl/bootstrap3/images/css3.png" width="20" alt="Valid CSS" />
    </a>
  </li>

  <li>
    <a href="https://www.dokuwiki.org/" title="Driven by DokuWiki" target="">
      <img src="/lib/tpl/bootstrap3/images/logo.png" width="20" alt="Driven by DokuWiki" />
    </a>
  </li>

</ul>
                  </div>

      </div>

    </div>

  </div>
</footer>
<img src="/lib/exe/indexer.php?id=tutoriel%3Apacemaker_configuration_ip_virtuelle_plus_script_lsb&amp;1635532438" width="2" height="1" alt="" />
    <a href="#dokuwiki__top" class="back-to-top hidden-print btn btn-default btn-sm" title="Aller au contenu" accesskey="t"><i class="fa fa-chevron-up"></i></a>

    <div id="screen__mode">      <span class="visible-xs-block"></span>
      <span class="visible-sm-block"></span>
      <span class="visible-md-block"></span>
      <span class="visible-lg-block"></span>
    </div>

  </div>

    <!-- Piwik -->
		<script type="text/javascript">
		  var _paq = _paq || [];
		  _paq.push(["setDomains", ["*.doc.ubuntu-fr.org","*.doc.edubuntu-fr.org","*.doc.lubuntu-fr.org","*.doc.xubuntu-fr.org","*.doc.edubuntu-fr.org","*.doc.lubuntu-fr.org","*.doc.ubuntu-fr.org","*.doc.xubuntu-fr.org"]]);
		  _paq.push(['trackPageView']);
		  _paq.push(['enableLinkTracking']);
		  (function() {
		    var u="//piwik.ubuntu-fr.org/";
		    _paq.push(['setTrackerUrl', u+'piwik.php']);
		    _paq.push(['setSiteId', 3]);
		    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
		    g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'piwik.js'; s.parentNode.insertBefore(g,s);
		  })();
		</script>
		<noscript><p><img src="//piwik.ubuntu-fr.org/piwik.php?idsite=3" style="border:0;" alt="" /></p></noscript>
		<!-- End Piwik Code -->

</body>
</html>
