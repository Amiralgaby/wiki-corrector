<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="fr"
  lang="fr" dir="ltr" class="no-js">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>tutoriel:samba_ad_dc_nfs4_kerberized [Wiki ubuntu-fr]</title>
  <script>(function(H){H.className=H.className.replace(/\bno-js\b/,'js')})(document.documentElement)</script>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="shortcut icon" href="/_media/favicon.ico" />
<link rel="apple-touch-icon" href="/lib/tpl/bootstrap3/images/apple-touch-icon.png" />
    <meta name="generator" content="DokuWiki"/>
<meta name="robots" content="index,follow"/>
<meta name="keywords" content="tutoriel,samba,administration,windows,reseau"/>
<link type="text/css" rel="stylesheet" href="/lib/tpl/bootstrap3/assets/fonts/united.fonts.css"/>
<link type="text/css" rel="stylesheet" href="/lib/tpl/bootstrap3/assets/font-awesome/css/font-awesome.min.css"/>
<link type="text/css" rel="stylesheet" href="/lib/tpl/bootstrap3/assets/bootstrap/united/bootstrap.min.css"/>
<link rel="search" type="application/opensearchdescription+xml" href="/lib/exe/opensearch.php" title="Wiki ubuntu-fr"/>
<link rel="start" href="/"/>
<link rel="contents" href="/tutoriel/samba_ad_dc_nfs4_kerberized?do=index" title="Plan du site"/>
<link rel="manifest" href="/lib/exe/manifest.php"/>
<link rel="alternate" type="application/rss+xml" title="Derniers changements" href="/feed.php"/>
<link rel="alternate" type="application/rss+xml" title="Catégorie courante" href="/feed.php?mode=list&amp;ns=tutoriel"/>
<link rel="edit" title="Modifier cette page" href="/tutoriel/samba_ad_dc_nfs4_kerberized?do=edit"/>
<link rel="alternate" type="text/html" title="HTML brut" href="/_export/xhtml/tutoriel/samba_ad_dc_nfs4_kerberized"/>
<link rel="alternate" type="text/plain" title="Wiki balise" href="/_export/raw/tutoriel/samba_ad_dc_nfs4_kerberized"/>
<link rel="canonical" href="http://doc.ubuntu-fr.org/tutoriel/samba_ad_dc_nfs4_kerberized"/>
<link rel="stylesheet" type="text/css" href="/lib/exe/css.php?t=bootstrap3&amp;tseed=b4a19b95bb4d08daf02b6dd52d7e6abc"/>
<!--[if gte IE 9]><!-->
<script type="text/javascript">/*<![CDATA[*/var NS='tutoriel';var JSINFO = {"bootstrap3":{"mode":"show","toc":[],"config":{"collapsibleSections":0,"fixedTopNavbar":1,"showSemanticPopup":0,"sidebarOnNavbar":0,"tagsOnTop":1,"tocAffix":1,"tocCollapseOnScroll":1,"tocCollapsed":0,"tocLayout":"default","useAnchorJS":1}},"id":"tutoriel:samba_ad_dc_nfs4_kerberized","namespace":"tutoriel","ACT":"show","useHeadingNavigation":0,"useHeadingContent":0};
/*!]]>*/</script>
<script type="text/javascript" charset="utf-8" src="/lib/exe/jquery.php?tseed=23f888679b4f1dc26eef34902aca964f"></script>
<script type="text/javascript" charset="utf-8" src="/lib/exe/js.php?t=bootstrap3&amp;tseed=b4a19b95bb4d08daf02b6dd52d7e6abc"></script>
<script type="text/javascript" src="/lib/tpl/bootstrap3/assets/bootstrap/js/bootstrap.min.js"></script>
<script type="text/javascript" src="/lib/tpl/bootstrap3/assets/anchorjs/anchor.min.js"></script>
<script type="text/javascript" src="/lib/tpl/bootstrap3/assets/typeahead/bootstrap3-typeahead.min.js"></script>
<!--<![endif]-->
<style type="text/css">@media screen { body { margin-top: 70px; }  #dw__toc.affix { top: 60px; position: fixed !important; }  #dw__toc .nav .nav .nav { display: none; } }</style>
    <!--[if lt IE 9]>
  <script type="text/javascript" src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
  <script type="text/javascript" src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
  <![endif]-->
</head>
<body class="united dokuwiki mode_show tpl_bootstrap3 dw-page-on-panel" data-page-id="tutoriel:samba_ad_dc_nfs4_kerberized">

  <header id="dokuwiki__header" class="dokuwiki container">
    <nav id="dw__navbar" class="navbar navbar-fixed-top navbar-default" role="navigation">

  <div class="container">

    <div class="navbar-header">

      <button class="navbar-toggle" type="button" data-toggle="collapse" data-target=".navbar-collapse">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>

      <a href="/accueil"  accesskey="h" title="[H]" class="navbar-brand"><span class="uf uf-cof" id="dw__accueil" style="font-size: 35px;" ></span> <span id="dw__title" style="margin-top:-5px">Wiki ubuntu-fr<span id="dw__tagline">La Documentation francophone</span></span></a>
    </div>

    <div class="collapse navbar-collapse">

      
      <ul class="nav navbar-nav">
        <li>
          <a href="//ubuntu-fr.org/" ><i class="fa fa-2x fa-fw fa-home"></i><span> Accueil</span></a>        </li>
        <li>
          <a href="//forum.ubuntu-fr.org/" ><i class="fa fa-2x fa-fw fa-comments"></i><span> Forum</span></a>        </li>
        <li>
          <a href="//planet.ubuntu-fr.org/" ><i class="fa fa-2x fa-fw fa-globe"></i><span> Planet</span></a>        </li>
      </ul>

            
      
      <div class="navbar-right" id="dw__navbar_items">

        <form action="//forum.ubuntu-fr.org/search_ubuntufr.php" accept-charset="utf-8" class="navbar-form navbar-left search" id="dw__search" method="get" role="search"><div class="no"><input id="qsearch" autocomplete="off" type="search" placeholder="Rechercher" accesskey="f" name="q" class="form-control" title="[F]" /><button type="submit" title="Rechercher"><i class="fa fa-fw fa-search"></i></button><input type="hidden" name="do" value="search" /><input type="hidden" name="tsearch" value="wiki" /></div></form>
        
<ul class="nav navbar-nav dw-action-icon" id="dw__tools">


  <li class="dropdown">

    <a href="" class="dropdown-toggle" data-target="#" data-toggle="dropdown" title="" role="button" aria-haspopup="true" aria-expanded="false">
      <i class="fa fa-2x fa-fw fa-wrench"></i> <span class="hidden-lg hidden-md hidden-sm">Outils</span> <span class="caret"></span>
    </a>

    <ul class="dropdown-menu tools" role="menu">
    
      <li class="dropdown-header">
        <i class="fa fa-fw fa-cubes"></i> Outils du site      </li>
      <li><a href="/tutoriel/samba_ad_dc_nfs4_kerberized?do=recent"  class="action recent" accesskey="r" rel="nofollow" title="Derniers changements [R]">Derniers changements</a></li><li><a href="/tutoriel/samba_ad_dc_nfs4_kerberized?do=media&amp;ns=tutoriel"  class="action media" rel="nofollow" title="Gestionnaire Multimédia">Gestionnaire Multimédia</a></li><li><a href="/tutoriel/samba_ad_dc_nfs4_kerberized?do=index"  class="action index" accesskey="x" rel="nofollow" title="Plan du site [X]">Plan du site</a></li>
            <li class="divider" role="separator"></li>
      
    
      <li class="dropdown-header">
        <i class="fa fa-fw fa-file"></i> Outils de la page      </li>
      <li><a href="/tutoriel/samba_ad_dc_nfs4_kerberized?do=edit"  class="action edit" accesskey="e" rel="nofollow" title="Modifier cette page [E]">Modifier cette page</a></li><li><a href="/tutoriel/samba_ad_dc_nfs4_kerberized?do=revisions"  class="action revs" accesskey="o" rel="nofollow" title="Anciennes révisions [O]">Anciennes révisions</a></li><li><a href="/tutoriel/samba_ad_dc_nfs4_kerberized?do=backlink"  class="action backlink" rel="nofollow" title="Liens de retour">Liens de retour</a></li><li><a href="#dokuwiki__top"  class="action top" accesskey="t" rel="nofollow" title="Haut de page [T]">Haut de page</a></li>
      
        </ul>
  </li>


</ul>


        <ul class="nav navbar-nav">

          
          
                    <li>
            <span class="dw__actions dw-action-icon">
              <a href="/tutoriel/samba_ad_dc_nfs4_kerberized?do=login&amp;sectok="  class="action btn btn-default navbar-btn login" rel="nofollow" title="S&#039;identifier"><span class="">S'identifier</span></a>            </span>
          </li>
          
        </ul>

        
        

      </div>

    </div>
  </div>
</nav>
  </header>

  <div id="dokuwiki__top" class="dokuwiki container">

    <div id="dokuwiki__pageheader">

      
      
      <p class="pageId text-right small">
        <span class="label label-primary">tutoriel:samba_ad_dc_nfs4_kerberized</span>      </p>

      <div id="dw__msgarea" class="small">
              </div>

    </div>

    <main class="main row" role="main">

      
      <article id="dokuwiki__content" class="container" itemscope itemtype="http://schema.org/Article" itemref="dw__license">

        
<nav id="dw__pagetools" class="hidden-print">
  <div class="tools panel panel-default pull-right ">
    <ul class="nav nav-stacked nav-pills">
      <li><a href="/tutoriel/samba_ad_dc_nfs4_kerberized?do=edit"  class="action text-muted edit" accesskey="e" rel="nofollow" title="Modifier cette page [E]"><i class="fa fa-fw fa-pencil-square-o"></i><span class="sr-only"> Modifier cette page</span></a></li><li><a href="/tutoriel/samba_ad_dc_nfs4_kerberized?do=revisions"  class="action text-muted revs" accesskey="o" rel="nofollow" title="Anciennes révisions [O]"><i class="fa fa-fw fa-clock-o"></i><span class="sr-only"> </span></a></li><li><a href="/tutoriel/samba_ad_dc_nfs4_kerberized?do=backlink"  class="action text-muted backlink" rel="nofollow" title="Liens de retour"><i class="fa fa-fw fa-link"></i><span class="sr-only"> Liens de retour</span></a></li>    </ul>
  </div>
</nav>

        <div class="panel panel-default" itemprop="articleBody">
          <div class="page panel-body">

            <div class="dw-content-page "><div class="dw-toc hidden-print"><script>JSINFO.bootstrap3.toc = [{"link":"#prerequis","title":"Pr\u00e9requis","level":1},{"link":"#parametres","title":"Param\u00e8tres","level":2},{"link":"#quelques_notions_a_propos_de_kerberos","title":"Quelques notions \u00e0 propos de Kerberos","level":1},{"link":"#configuration_du_serveur_de_fichier","title":"Configuration du serveur de fichier","level":1},{"link":"#installation_du_serveur_nfs","title":"Installation du serveur NFS","level":2},{"link":"#definition_des_partages_nfs","title":"D\u00e9finition des partages NFS","level":2},{"link":"#lancement_du_service_nfs","title":"Lancement du service NFS","level":2},{"link":"#conseils","title":"Conseils","level":2},{"link":"#configuration_de_la_machine_cliente","title":"Configuration de la machine cliente","level":1},{"link":"#installation_du_client_nfs","title":"Installation du client NFS","level":2},{"link":"#montage_du_partage","title":"Montage du partage","level":2},{"link":"#erreurs_et_solutions","title":"Erreurs et solutions","level":2},{"link":"#automatisation","title":"Automatisation","level":2},{"link":"#en_resume","title":"En r\u00e9sum\u00e9","level":1},{"link":"#sur_le_serveur_dns","title":"Sur le serveur DNS","level":2},{"link":"#sur_le_serveur_de_fichier","title":"Sur le serveur de fichier","level":2},{"link":"#sur_les_clients_nfs","title":"Sur les clients NFS","level":2},{"link":"#references","title":"R\u00e9f\u00e9rences","level":1}];</script>
<!-- TOC START -->
<nav id="dw__toc" role="navigation" class="toc-panel panel panel-default small">
<h6 data-toggle="collapse" data-target="#dw__toc .toc-body" title="Table des matières" class="panel-heading toc-title"><i class="fa fa-fw fa-th-list"></i> <span>Table des matières</span> <i class="caret"></i></h6>
<div class="panel-body  toc-body collapse in">

<ul class="nav toc">
<li class="level1"><a href="#prerequis">Prérequis</a>
<ul class="nav toc">
<li class="level2"><a href="#parametres">Paramètres</a></li>
</ul>
</li>
<li class="level1"><a href="#quelques_notions_a_propos_de_kerberos">Quelques notions à propos de Kerberos</a></li>
<li class="level1"><a href="#configuration_du_serveur_de_fichier">Configuration du serveur de fichier</a>
<ul class="nav toc">
<li class="level2"><a href="#installation_du_serveur_nfs">Installation du serveur NFS</a></li>
<li class="level2"><a href="#definition_des_partages_nfs">Définition des partages NFS</a></li>
<li class="level2"><a href="#lancement_du_service_nfs">Lancement du service NFS</a></li>
<li class="level2"><a href="#conseils">Conseils</a></li>
</ul>
</li>
<li class="level1"><a href="#configuration_de_la_machine_cliente">Configuration de la machine cliente</a>
<ul class="nav toc">
<li class="level2"><a href="#installation_du_client_nfs">Installation du client NFS</a></li>
<li class="level2"><a href="#montage_du_partage">Montage du partage</a></li>
<li class="level2"><a href="#erreurs_et_solutions">Erreurs et solutions</a></li>
<li class="level2"><a href="#automatisation">Automatisation</a></li>
</ul>
</li>
<li class="level1"><a href="#en_resume">En résumé</a>
<ul class="nav toc">
<li class="level2"><a href="#sur_le_serveur_dns">Sur le serveur DNS</a></li>
<li class="level2"><a href="#sur_le_serveur_de_fichier">Sur le serveur de fichier</a></li>
<li class="level2"><a href="#sur_les_clients_nfs">Sur les clients NFS</a></li>
</ul>
</li>
<li class="level1"><a href="#references">Références</a></li>
</ul>

</div>
</nav>
<!-- TOC END -->
</div><!-- CONTENT --><div class="dw-content"><div class="tags"><span>
	<a href="/tutoriel" class="wikilink1" title="tutoriel" rel="tag">tutoriel</a>,
	<a href="/samba" class="wikilink1" title="samba" rel="tag">samba</a>,
	<a href="/administration" class="wikilink1" title="administration" rel="tag">administration</a>,
	<a href="/windows" class="wikilink1" title="windows" rel="tag">windows</a>,
	<a href="/reseau" class="wikilink1" title="reseau" rel="tag">réseau</a>
</span></div>
<hr />

<h1 class="sectionedit1 page-header" id="samba_ad_dc_-_partage_nfsv4_avec_authentification_kerberos">Samba AD DC - Partage NFSv4 avec authentification Kerberos</h1>
<div class="level1">

<p>
Le partage de données se fait communément avec le protocole SMB (Server Message Block). Ce protocole a l&#039;avantage d&#039;être supporté par l&#039;ensemble des plate-formes (Windows, Apple, Linux, Unix).
</p>

<p>
Une alternative à celui-ci est <abbr title="Network File System">NFS</abbr> (Network File System) qui, historiquement, est le protocole de partage de données dans le monde Unix et plus tard Linux. Ces trois premières versions manquaient cruellement de sécurité. La quatrième version apporte des éléments de sécurité concrets dont :
</p>
<ul class=" fix-media-list-overlap">
<li class="level1"><div class="li"> L&#039;authentification des intervenants qui a pour but de vérifier l&#039;identité de la personne ou de la machine avec qui l&#039;on communique.</div>
</li>
<li class="level1"><div class="li"> La signature des communications qui a pour but de détecter si la communication a été modifiée entre son émission et sa réception.</div>
</li>
<li class="level1"><div class="li"> Le chiffrement des communications qui a pour but d&#039;empêcher la compréhension de la communication si elle est interceptée.</div>
</li>
</ul>

</div>
<div class='secedit editbutton_section editbutton_1'><form class="button btn_secedit form-inline" method="post" action="/tutoriel/samba_ad_dc_nfs4_kerberized"><div class="no"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="1511282133" /><input type="hidden" name="summary" value="[Samba AD DC - Partage NFSv4 avec authentification Kerberos] " /><input type="hidden" name="target" value="section" /><input type="hidden" name="hid" value="samba_ad_dc_-_partage_nfsv4_avec_authentification_kerberos" /><input type="hidden" name="codeblockOffset" value="0" /><input type="hidden" name="range" value="62-1042" /><button type="submit" title="Samba AD DC - Partage NFSv4 avec authentification Kerberos" class=" btn btn-default btn btn-xs btn-default">Modifier</button></div></form></div>
<h2 class="sectionedit2 page-header" id="prerequis">Prérequis</h2>
<div class="level2">
<ul class=" fix-media-list-overlap">
<li class="level1"><div class="li"> Avoir un contrôleur de domaine Samba AD (ou son équivalent Windows) →Se référer à <a href="/samba-active-directory" class="wikilink1" title="samba-active-directory">Samba - Active Directory Domain Controller (AD DC)</a></div>
</li>
<li class="level1"><div class="li"> Avoir deux machines dans ce domaine →Se référer à <a href="/utilisateurs/qedinux/samba_ad_dc_members" class="wikilink1" title="utilisateurs:qedinux:samba_ad_dc_members">Samba AD DC - Intégration de machines au domaine</a></div>
</li>
<li class="level1"><div class="li"> Avoir une connaissance de <abbr title="Network File System">NFS</abbr> →Se référer à <a href="/nfs" class="wikilink1" title="nfs">NFS</a></div>
</li>
</ul>

</div>
<div class='secedit editbutton_section editbutton_2'><form class="button btn_secedit form-inline" method="post" action="/tutoriel/samba_ad_dc_nfs4_kerberized"><div class="no"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="1511282133" /><input type="hidden" name="summary" value="[Prérequis] " /><input type="hidden" name="target" value="section" /><input type="hidden" name="hid" value="prerequis" /><input type="hidden" name="codeblockOffset" value="0" /><input type="hidden" name="range" value="1043-1457" /><button type="submit" title="Prérequis" class=" btn btn-default btn btn-xs btn-default">Modifier</button></div></form></div>
<h3 class="sectionedit3" id="parametres">Paramètres</h3>
<div class="level3">

<p>
Pour cette documentation, les paramètres suivants seront utilisés <sup><a href="#fn__1" id="fnt__1" class="fn_top">1)</a></sup>
</p>
<div class="table-responsive"><table class="inline table table-striped table-condensed">
	<thead>
	<tr class="row0">
		<th class="col0 centeralign">  Nom de domaine  </th><th class="col1 centeralign">  Royaume (realm)  </th>
	</tr>
	</thead>
	<tr class="row1">
		<td class="col0 centeralign">  example.com  </td><td class="col1 centeralign">  EXAMPLE.COM  </td>
	</tr>
</table></div>
<div class="table-responsive"><table class="inline table table-striped table-condensed">
	<thead>
	<tr class="row0">
		<th class="col0 centeralign">  Nom de machine  </th><th class="col1 centeralign">  Adresse IP  </th><th class="col2 centeralign">  Role  </th>
	</tr>
	</thead>
	<tr class="row1">
		<td class="col0 centeralign">  ubndc01  </td><td class="col1 centeralign">  192.0.2.11  </td><td class="col2 centeralign">  Contrôleur de domaine  </td>
	</tr>
	<tr class="row2">
		<td class="col0 centeralign">  ubnfs01  </td><td class="col1 centeralign">  192.0.2.12  </td><td class="col2 centeralign">  Serveur de fichier  </td>
	</tr>
	<tr class="row3">
		<td class="col0 centeralign">  ubnws01  </td><td class="col1 centeralign">  192.0.2.13  </td><td class="col2 centeralign">  Machine client  </td>
	</tr>
</table></div>

<p>
Le répertoire partagé sera le répertoire <em>/media/home/example</em> présent sur le serveur de fichier et contenant les répertoires <em>home</em> des utilisateurs du domaine. Ce répertoire sera monté sur chaque machine du domaine afin de permettre à chaque utilisateur d&#039;accéder à son répertoire <em>home</em> depuis n&#039;importe quelle machine du domaine.
</p>

</div>
<div class='secedit editbutton_section editbutton_3'><form class="button btn_secedit form-inline" method="post" action="/tutoriel/samba_ad_dc_nfs4_kerberized"><div class="no"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="1511282133" /><input type="hidden" name="summary" value="[Paramètres] " /><input type="hidden" name="target" value="section" /><input type="hidden" name="hid" value="parametres" /><input type="hidden" name="codeblockOffset" value="0" /><input type="hidden" name="range" value="1458-2410" /><button type="submit" title="Paramètres" class=" btn btn-default btn btn-xs btn-default">Modifier</button></div></form></div>
<h2 class="sectionedit6 page-header" id="quelques_notions_a_propos_de_kerberos">Quelques notions à propos de Kerberos</h2>
<div class="level2">

<p>
Le User Principal Name (UPN) est un identifiant unique pour l&#039;identité de sécurité d&#039;un utilisateur ou d&#039;un ordinateur. Il existe deux type d&#039;UPN
</p>
<ul class=" fix-media-list-overlap">
<li class="level1"><div class="li"> L&#039; iUPN (implicit UPN) constitué de l&#039;attribut <em>samAccountName</em>@<em>&lt;REALM&gt;</em></div>
</li>
<li class="level1"><div class="li"> L&#039; eUPN (explicit UPN) défini par l&#039;attribut <em>userPrincipalName</em>.</div>
</li>
</ul>

<p>
Dans le cas où deux objets auraient leur eUPN et iUPN en commun, l&#039; eUPN a une priorité supérieure.
</p>

<p>
Le Service Principal Name (SPN) est un identifiant unique pour un service tournant sur un ordinateur. Il prend la forme &lt;service&gt;/&lt;hostname&gt;:&lt;port&gt;/&lt;service_name&gt;@&lt;REALM&gt; avec le champ <em>hostname</em> qui peut être juste le nom de l&#039;ordinateur ou son nom pleinement qualifié (FQDN). Les champs <em>port</em> et <em>service_name</em> sont optionnels.
</p>

<p>
Un UPN permet de demander un ticket au serveur Kerberos afin de communiquer avec un SPN. Par défaut, les objets &#039;utilisateur&#039; d&#039;Active Directory possède un UPN. Mais, les objets &#039;ordinateur&#039; d&#039;Active Directory n&#039;en possède pas par défaut. Dans le cadre de SSH, c&#039;est l&#039;utilisateur qui établit la communication avec le service distant. Dans le cadre de <abbr title="Network File System">NFS</abbr> avec Kerberos, c&#039;est l&#039;ordinateur qui établit la communication avec le service distant.
</p>

</div>
<div class='secedit editbutton_section editbutton_6'><form class="button btn_secedit form-inline" method="post" action="/tutoriel/samba_ad_dc_nfs4_kerberized"><div class="no"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="1511282133" /><input type="hidden" name="summary" value="[Quelques notions à propos de Kerberos] " /><input type="hidden" name="target" value="section" /><input type="hidden" name="hid" value="quelques_notions_a_propos_de_kerberos" /><input type="hidden" name="codeblockOffset" value="0" /><input type="hidden" name="range" value="2411-3662" /><button type="submit" title="Quelques notions à propos de Kerberos" class=" btn btn-default btn btn-xs btn-default">Modifier</button></div></form></div>
<h2 class="sectionedit7 page-header" id="configuration_du_serveur_de_fichier">Configuration du serveur de fichier</h2>
<div class="level2">

</div>
<div class='secedit editbutton_section editbutton_7'><form class="button btn_secedit form-inline" method="post" action="/tutoriel/samba_ad_dc_nfs4_kerberized"><div class="no"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="1511282133" /><input type="hidden" name="summary" value="[Configuration du serveur de fichier] " /><input type="hidden" name="target" value="section" /><input type="hidden" name="hid" value="configuration_du_serveur_de_fichier" /><input type="hidden" name="codeblockOffset" value="0" /><input type="hidden" name="range" value="3663-3710" /><button type="submit" title="Configuration du serveur de fichier" class=" btn btn-default btn btn-xs btn-default">Modifier</button></div></form></div>
<h3 class="sectionedit8" id="installation_du_serveur_nfs">Installation du serveur NFS</h3>
<div class="level3">

<p>
L&#039;installation de <abbr title="Network File System">NFS</abbr> se fait avec le paquet <a href="apt://nfs-kernel-server" class="interwiki iw_apt" title="apt://nfs-kernel-server">nfs-kernel-server</a>
</p>
<pre class="code">sudo apt-get install nfs-kernel-server</pre>

</div>
<div class='secedit editbutton_section editbutton_8'><form class="button btn_secedit form-inline" method="post" action="/tutoriel/samba_ad_dc_nfs4_kerberized"><div class="no"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="1511282133" /><input type="hidden" name="summary" value="[Installation du serveur NFS] " /><input type="hidden" name="target" value="section" /><input type="hidden" name="hid" value="installation_du_serveur_nfs" /><input type="hidden" name="codeblockOffset" value="0" /><input type="hidden" name="range" value="3711-3871" /><button type="submit" title="Installation du serveur NFS" class=" btn btn-default btn btn-xs btn-default">Modifier</button></div></form></div>
<h3 class="sectionedit9" id="definition_des_partages_nfs">Définition des partages NFS</h3>
<div class="level3">

<p>
Avant de faire fonctionner <abbr title="Network File System">NFS</abbr>, il faut préparer le partage. NFSv4 base son partage sur une racine virtuelle définie. Bien qu&#039;il soit possible d&#039;utiliser des répertoires déjà existants, il est recommandé d&#039;en créer un à la racine du système de fichier, par exemple <em>/export</em>. Ensuite pour chaque répertoire qui sera partagé, il faut créer un sous répertoire dans la structure <abbr title="Network File System">NFS</abbr>, par exemple <em>/export/home/example</em>.
</p>
<pre class="code">sudo mkdir -p /export/home/example</pre>

<p>
A ce stade, les données partagées le seraient sur la partition <em>Root</em> ce qui n&#039;est pas une bonne pratique. Afin de ne pas modifier le reste du serveur de fichier, il faut procéder à la jonction du répertoire <em>/export/home/example</em> avec le répertoire qui contiendra réellement les données, <em>/home/example</em>. Dans le cas où le répertoire contenant les données représente une partition entière, la partition peut alors être directement montée sur la structure <abbr title="Network File System">NFS</abbr>.
</p>

<p>
En ligne de commande
</p>
<pre class="code">sudo mount --bind /home/example /export/home/example</pre>

<p>
Ou en ajoutant une ligne dans le fichier <em>/etc/fstab</em> pour que l&#039;opération soit effectuée à chaque redémarrage
</p>
<dl class="file">
<dt><a href="/_export/code/tutoriel/samba_ad_dc_nfs4_kerberized?codeblock=3" title="Télécharger cet extrait" class="mediafile mf_">/etc/fstab</a></dt>
<dd><pre class="file"># Export NFS4
/home/example            /export/home/example        none       bind           0       0</pre>
</dd></dl>

<p>
Cette structure de répertoires sous <em>/export</em> doit être considérée comme une structure virtuelle permettant le fonctionnement de <abbr title="Network File System">NFS</abbr> et non pas comme une structure pour le stockage de fichiers directement. Ainsi, l&#039;impact en espace disque sur la partition <em>Root</em> est quasi nul.
</p>

<p>
La configuration des partages se fait au travers du fichier <em>/etc/exports</em>
</p>
<dl class="file">
<dt><a href="/_export/code/tutoriel/samba_ad_dc_nfs4_kerberized?codeblock=4" title="Télécharger cet extrait" class="mediafile mf_">/etc/exports</a></dt>
<dd><pre class="file">/export                192.0.2.0/24(ro,sync,fsid=0,no_subtree_check,crossmnt,sec=krb5)
/export/home/example   192.0.2.0/24(rw,sync,no_subtree_check,sec=krb5)</pre>
</dd></dl>

<p>
La première ligne avec l&#039;option <strong><em>fsid=0</em></strong> (ou fsid=root) définit la racine virtuelle du système de fichiers partagés. Il n&#039;y a aucune nécessité de donner des droits d&#039;écriture sur cette racine. Tous les fichiers et répertoires sous <em>/export</em> sont accessibles par le partage <abbr title="Network File System">NFS</abbr>.
</p>

<p>
L&#039;option <strong><em>sec=krb5</em></strong> définit le niveau de sécurité exigé. Il en existe 3:
</p>
<ul class=" fix-media-list-overlap">
<li class="level1"><div class="li"> krb5: Authentification Kerberos</div>
</li>
<li class="level1"><div class="li"> krb5i: Authentification Kerberos avec signature des communications (<strong><em>i</em></strong> pour integrity)</div>
</li>
<li class="level1"><div class="li"> krb5p: Authentification Kerberos avec chiffrement des communications (<strong><em>p</em></strong> pour privacy)</div>
</li>
</ul>
<div class="noteclassic">Bien qu&#039;encore utilisée, les notations <em>gss/krb5</em>, <em>gss/krb5i</em> et <em>gss/krb5p</em> sont dépréciées. Il est recommandé d&#039;utiliser l&#039;option <em>sec=</em>
</div>
</div>
<div class='secedit editbutton_section editbutton_9'><form class="button btn_secedit form-inline" method="post" action="/tutoriel/samba_ad_dc_nfs4_kerberized"><div class="no"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="1511282133" /><input type="hidden" name="summary" value="[Définition des partages NFS] " /><input type="hidden" name="target" value="section" /><input type="hidden" name="hid" value="definition_des_partages_nfs" /><input type="hidden" name="codeblockOffset" value="1" /><input type="hidden" name="range" value="3872-6542" /><button type="submit" title="Définition des partages NFS" class=" btn btn-default btn btn-xs btn-default">Modifier</button></div></form></div>
<h3 class="sectionedit10" id="lancement_du_service_nfs">Lancement du service NFS</h3>
<div class="level3">

<p>
A ce stade, le démarrage du serveur <abbr title="Network File System">NFS</abbr> ne devrait pas encore fonctionner.
</p>
<pre class="code">sudo service nfs-kernel-server start
 * Exporting directories for NFS kernel daemon...                                        [ OK ] 
 * Starting NFS kernel daemon                                                            [fail] </pre>

<p>
Afin de remédier au problème, il faut avant tout l&#039;identifier correctement. Et pour ce faire, il faut accéder aux logs (fichiers d&#039;historique d’événements).
</p>
<dl class="file">
<dt><a href="/_export/code/tutoriel/samba_ad_dc_nfs4_kerberized?codeblock=6" title="Télécharger cet extrait" class="mediafile mf_">/var/log/syslog</a></dt>
<dd><pre class="file">Oct  6 18:13:26 ubnfs01 rpc.svcgssd[25763]: unable to obtain root (machine) credentials
Oct  6 18:13:26 ubnfs01 rpc.svcgssd[25763]: do you have a keytab entry for nfs/&lt;your.host&gt;@&lt;YOUR.REALM&gt; in /etc/krb5.keytab?</pre>
</dd></dl>

<p>
Le service n&#039;arrive pas à démarrer parce qu&#039;il ne trouve pas son SPN (Service Principal Name) dans le fichier keytab par défaut (/etc/krb5.keytab) qui, par défaut, serait <em>nfs/ubnfs01.example.com@EXAMPLE.COM</em>. Plus clairement, le service ne trouve pas son identité afin de s&#039;authentifier. Pour modifier le fichier <em>keytab</em>, il faut utiliser l&#039;outil <em>net</em> avec les commandes <em>ads keytab</em>. Il faut également avoir les droits super-utilisateurs. Pour rappel, vu l&#039;importance de ce fichier, les permissions sur celui-ci sont très restrictives <em>root:root 600</em>. Seul l&#039;utilisateur <em>root</em> peut y accéder en lecture et écriture. Il faut également interagir avec le serveur Kerberos présent sur le DC. Pour cela, la meilleure façon de procéder consiste à s&#039;authentifier avec un compte administrateur du domaine à chaque commande avec l&#039;option <em>-U Administrator</em>.
</p>
<pre class="code">sudo net ads keytab add nfs -U Administrator
Enter Administrator&#039;s password:

sudo net ads keytab list
Vno  Type                                        Principal
  6  des-cbc-crc                                 host/ubnfs01.example.com@EXAMPLE.COM
  ...
  6  arcfour-hmac-md5                            UBNFS01$@EXAMPLE.COM
  6  des-cbc-crc                                 nfs/ubnfs01.example.com@EXAMPLE.COM
  ...
  6  arcfour-hmac-md5                            nfs/ubnfs01@EXAMPLE.COM</pre>

<p>
La commande <em>add &lt;service&gt;</em> ajoute deux SPN au fichier <em>keytab</em> (un pour le <em>hostname</em> et un pour le <em>fqdn</em>). Parallèlement, deux attributs &#039;servicePrincipalName&#039; sont ajoutés à l&#039;object Active Directory représentant l&#039;ordinateur (ubnfs01)  (&lt;service&gt;/&lt;hostname&gt; et &lt;service&gt;/&lt;fqdn&gt;)..
</p>

<p>
La commande <em>list</em> liste les UPN et SPN présents dans le fichier <em>keytab</em>.
</p>

<p>
La commande <em>flush</em> vide le fichier <em>keytab</em> et supprime l&#039;ensemble des SPN associés à la machine.
</p>

<p>
La commande <em>create</em> crée le fichier <em>keytab</em> par défaut avec l&#039;iUPN et l&#039;eUPN, si l&#039;attribut <em>userPrincipalName</em> a été définit, et les SPN host/&lt;hostname&gt;@&lt;REALM&gt; et host/&lt;fqdn&gt;@&lt;REALM&gt;.
</p>

</div>
<div class='secedit editbutton_section editbutton_10'><form class="button btn_secedit form-inline" method="post" action="/tutoriel/samba_ad_dc_nfs4_kerberized"><div class="no"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="1511282133" /><input type="hidden" name="summary" value="[Lancement du service NFS] " /><input type="hidden" name="target" value="section" /><input type="hidden" name="hid" value="lancement_du_service_nfs" /><input type="hidden" name="codeblockOffset" value="5" /><input type="hidden" name="range" value="6543-9381" /><button type="submit" title="Lancement du service NFS" class=" btn btn-default btn btn-xs btn-default">Modifier</button></div></form></div>
<h3 class="sectionedit11" id="conseils">Conseils</h3>
<div class="level3">

<p>
Le service <em>nfs-kernel-server</em> lorsqu&#039;il démarre va lire le fichier de configuration <em>/etc/default/nfs-kernel-server</em>. Par défaut, il ne faut rien y changer. Cependant, si l&#039;on veut augmenter la quantité d&#039;informations envoyées dans le fichier log. On peut ajouter l&#039;option &quot;très bavard&quot; au démon <em>rpc.svcgssd</em> (responsable de l&#039;authentification de la machine vis-à-vis du serveur Kerberos)
</p>
<dl class="file">
<dt><a href="/_export/code/tutoriel/samba_ad_dc_nfs4_kerberized?codeblock=8" title="Télécharger cet extrait" class="mediafile mf_">/etc/default/nfs-kernel-server</a></dt>
<dd><pre class="file">RPCSVCGSSDOPTS=&quot;-vvv&quot;</pre>
</dd></dl>

<p>
De façon plus générale, la page de manuel du démon <em>rpc.svcgssd</em> propose d&#039;autres options plus avancées.
</p>

</div>
<div class='secedit editbutton_section editbutton_11'><form class="button btn_secedit form-inline" method="post" action="/tutoriel/samba_ad_dc_nfs4_kerberized"><div class="no"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="1511282133" /><input type="hidden" name="summary" value="[Conseils] " /><input type="hidden" name="target" value="section" /><input type="hidden" name="hid" value="conseils" /><input type="hidden" name="codeblockOffset" value="8" /><input type="hidden" name="range" value="9382-9987" /><button type="submit" title="Conseils" class=" btn btn-default btn btn-xs btn-default">Modifier</button></div></form></div>
<h2 class="sectionedit12 page-header" id="configuration_de_la_machine_cliente">Configuration de la machine cliente</h2>
<div class="level2">

</div>
<div class='secedit editbutton_section editbutton_12'><form class="button btn_secedit form-inline" method="post" action="/tutoriel/samba_ad_dc_nfs4_kerberized"><div class="no"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="1511282133" /><input type="hidden" name="summary" value="[Configuration de la machine cliente] " /><input type="hidden" name="target" value="section" /><input type="hidden" name="hid" value="configuration_de_la_machine_cliente" /><input type="hidden" name="codeblockOffset" value="9" /><input type="hidden" name="range" value="9988-10035" /><button type="submit" title="Configuration de la machine cliente" class=" btn btn-default btn btn-xs btn-default">Modifier</button></div></form></div>
<h3 class="sectionedit13" id="installation_du_client_nfs">Installation du client NFS</h3>
<div class="level3">

<p>
L&#039;installation du client <abbr title="Network File System">NFS</abbr> se fait avec le paquet <a href="apt://nfs-common" class="interwiki iw_apt" title="apt://nfs-common">nfs-common</a>
</p>
<pre class="code">sudo apt-get install nfs-common</pre>

</div>
<div class='secedit editbutton_section editbutton_13'><form class="button btn_secedit form-inline" method="post" action="/tutoriel/samba_ad_dc_nfs4_kerberized"><div class="no"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="1511282133" /><input type="hidden" name="summary" value="[Installation du client NFS] " /><input type="hidden" name="target" value="section" /><input type="hidden" name="hid" value="installation_du_client_nfs" /><input type="hidden" name="codeblockOffset" value="9" /><input type="hidden" name="range" value="10036-10188" /><button type="submit" title="Installation du client NFS" class=" btn btn-default btn btn-xs btn-default">Modifier</button></div></form></div>
<h3 class="sectionedit14" id="montage_du_partage">Montage du partage</h3>
<div class="level3">

<p>
Le partage se monte avec la commande <em>mount</em> et le type <em>nfs4</em> qui va rediriger l&#039;appel vers la commande spécifique <em>mount.nfs4</em>. Afin de test l&#039;accès au partage, le partage sera monté sur <em>/mnt/test</em> au lieu de <em>/home/example.com</em>
</p>
<pre class="code">sudo mount -t nfs4 -o sec=krb5 ubnfs01.example.com:/home/example /home/example</pre>

<p>
L&#039;option <em>sec=krb5</em> précise que le montage se fera avec authentification Kerberos.
</p>

</div>
<div class='secedit editbutton_section editbutton_14'><form class="button btn_secedit form-inline" method="post" action="/tutoriel/samba_ad_dc_nfs4_kerberized"><div class="no"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="1511282133" /><input type="hidden" name="summary" value="[Montage du partage] " /><input type="hidden" name="target" value="section" /><input type="hidden" name="hid" value="montage_du_partage" /><input type="hidden" name="codeblockOffset" value="10" /><input type="hidden" name="range" value="10189-10640" /><button type="submit" title="Montage du partage" class=" btn btn-default btn btn-xs btn-default">Modifier</button></div></form></div>
<h3 class="sectionedit15" id="erreurs_et_solutions">Erreurs et solutions</h3>
<div class="level3">

<p>
Le résultat de la commande <em>mount</em> ci-dessus devrait être : &quot;Access denied by server while mounting ubnfs01.example.com:/home/example&quot;
</p>

<p>
Les raisons sont multiples et vont être parcourues ci-après
</p>

</div>

<h4 id="activation_du_demon_rpcgssd">Activation du démon rpc.gssd</h4>
<div class="level4">

<p>
Le démon <em>rpc.gssd</em> est responsable de l&#039;authentification par Kerberos. Il faut donc le démarrer manuellement (via son script Upstart, <em>/etc/init/gssd.conf</em>)
</p>
<pre class="code">sudo start gssd</pre>

<p>
Ou de façon automatique en modifiant le fichier <em>/etc/default/nfs-common</em>
</p>
<dl class="file">
<dt><a href="/_export/code/tutoriel/samba_ad_dc_nfs4_kerberized?codeblock=12" title="Télécharger cet extrait" class="mediafile mf_">/etc/default/nfs-common</a></dt>
<dd><pre class="file">NEED_GSSD=&quot;yes&quot;</pre>
</dd></dl>

<p>
A la lecture du script Upstart du démon <em>rpc.gssd</em>, on constate que ce démon va charger plusieurs modules dont <em>rpcsec_gss_krb5</em> et que si le fichier <em>/etc/fstab</em> contient une ligne avec une option du type <em>sec=krb5</em>, le démon sera automatiquement démarré. 
</p>

<p>
Afin de faciliter le dépannage en cas de problème avec ce démon, il est possible d&#039;activer son mode &quot;très, très bavard&quot; avec l&#039;option &quot;-vvv&quot;.
</p>
<pre class="code">sudo stop gssd
sudo rpc.gssd -vvv</pre>

<p>
La page de manuel de ce démon liste d&#039;autres options plus avancées.
</p>

</div>

<h4 id="dns_inverse">DNS inversé</h4>
<div class="level4">

<p>
Dans le fichier log, on identifie vite le problème
</p>
<dl class="file">
<dt><a href="/_export/code/tutoriel/samba_ad_dc_nfs4_kerberized?codeblock=14" title="Télécharger cet extrait" class="mediafile mf_">/var/log/syslog</a></dt>
<dd><pre class="file">Oct  6 22:09:42 ubnws01 rpc.gssd[3609]: ERROR: unable to resolve 192.0.2.12 to hostname: Name or service not known
Oct  6 22:09:42 ubnws01 rpc.gssd[3609]: ERROR: failed to read service info</pre>
</dd></dl>

<p>
La cause est l&#039;absence de résolution inverse sur le serveur <abbr title="Domain Name System">DNS</abbr> (également fournit par Samba AD DC). Pour y remédier, il faut ajouter la zone <em>2.0.192.in-addr.arpa</em> et le pointeur <em>ubnfs01.example.com</em> pour l&#039;adresse <em>12</em>
</p>
<pre class="code">samba-tool dns zonecreate ubndc01 2.0.192.in-addr.arpa
Zone 2.0.192.in-addr.arpa created successfully

samba-tool dns add ubndc01 2.0.192.in-addr.arpa 12 PTR ubnfs01.example.com
Record added successfully</pre>

<p>
La commande <em>samba-tool</em> utilise le ticket kerberos de l&#039;utilisateur pour réaliser ces opérations. Si l&#039;utilisateur n&#039;a pas de ticket Kerberos, il peut utiliser l&#039;option <em>-U Administrator</em>.
</p>

<p>
A cause du <a href="https://bugzilla.samba.org/show_bug.cgi?id=9404" class="urlextern" title="https://bugzilla.samba.org/show_bug.cgi?id=9404" rel="nofollow">Bug 9404</a> de Samba 4, la zone fraîchement créée n&#039;est pas automatiquement chargée par le serveur <abbr title="Domain Name System">DNS</abbr> interne de Samba. Il faut redémarrer le service <em>samba-ad-dc</em> sur le contrôleur de domaine.
</p>
<pre class="code">ssh ubndc01
...
sudo service samba-ad-dc restart
samba-ad-dc stop/waiting
samba-ad-dc start/running, process 11129
exit</pre>

</div>

<h4 id="absence_d_identite">Absence d&#039;identité</h4>
<div class="level4">

<p>
Le démon <em>rpc.gssd</em> va chercher une identité dans le fichier <em>/etc/krb5.keytab</em> pour s&#039;authentifier vis-à-vis du serveur Kerberos. Il essaie premièrement l&#039;UPN de l&#039;ordinateur &lt;FQDN$&gt;@&lt;REALM&gt; et ensuite les SPN root/&lt;fqdn&gt;@&lt;REALM&gt;, nfs/&lt;fqdn&gt;@&lt;REALM&gt; et host/&lt;fqdn&gt;@&lt;REALM&gt;. 
</p>
<dl class="file">
<dt><a href="/_export/code/tutoriel/samba_ad_dc_nfs4_kerberized?codeblock=17" title="Télécharger cet extrait" class="mediafile mf_">/var/log/syslog</a></dt>
<dd><pre class="file">Oct  7 20:17:08 ubnws01 rpc.gssd[6173]: No key table entry found for UBNWS01.EXAMPLE.COM$@EXAMPLE.COM while getting keytab entry for &#039;UBNWS01.EXAMPLE.COM$@EXAMPLE.COM&#039;
Oct  7 20:17:08 ubnws01 rpc.gssd[6173]: No key table entry found for root/ubnws01.example.com@EXAMPLE.COM while getting keytab entry for &#039;root/ubnws01.example.com@EXAMPLE.COM&#039;
Oct  7 20:17:08 ubnws01 rpc.gssd[6173]: No key table entry found for nfs/ubnws01.example.com@EXAMPLE.COM while getting keytab entry for &#039;nfs/ubnws01.example.com@EXAMPLE.COM&#039;
Oct  7 20:17:08 ubnws01 rpc.gssd[6173]: No key table entry found for host/ubnws01.example.com@EXAMPLE.COM while getting keytab entry for &#039;host/ubnws01.example.com@EXAMPLE.COM&#039;
Oct  7 20:17:08 ubnws01 rpc.gssd[6173]: ERROR: gssd_refresh_krb5_machine_credential: no usable keytab entry found in keytab /etc/krb5.keytab for connection with host ubnfs01.example.com
Oct  7 20:17:08 ubnws01 rpc.gssd[6173]: ERROR: No credentials found for connection to server ubnfs01.example.com</pre>
</dd></dl>

<p>
Normalement, s&#039;il a été crée, le fichier <em>/etc/krb5.keytab</em> contient le bien le SPN &lt;host&gt;/&lt;fqdn&gt;@&lt;REALM&gt;. L&#039;erreur devient alors
</p>
<dl class="file">
<dt><a href="/_export/code/tutoriel/samba_ad_dc_nfs4_kerberized?codeblock=18" title="Télécharger cet extrait" class="mediafile mf_">/var/log/syslog</a></dt>
<dd><pre class="file">Oct  7 22:16:44 ubnws01 rpc.gssd[6173]: Success getting keytab entry for &#039;host/ubnws01.example.com@EXAMPLE.COM&#039;
Oct  7 22:16:44 ubnws01 rpc.gssd[6173]: WARNING: Client &#039;host/ubnws01.example.com@EXAMPLE.COM&#039; not found in Kerberos database while getting initial ticket for principal &#039;host/ubnws01.example.com@EXAMPLE.COM&#039; using keytab &#039;FILE:/etc/krb5.keytab&#039;
Oct  7 22:16:44 ubnws01 rpc.gssd[6173]: ERROR: No credentials found for connection to server ubnfs01.example.com</pre>
</dd></dl>

<p>
Le démon <em>rpc.gssd</em> est multi-usage. Dans le cas de NFSv4 avec Kerberos, il a besoin de l&#039;UPN de l&#039;ordinateur (cfr <a href="/utilisateurs/qedinux/samba_ad_dc_nfs4_kerberized#quelques_notions_a_propos_de_kerberos" class="wikilink1" title="utilisateurs:qedinux:samba_ad_dc_nfs4_kerberized">Notions Kerberos</a>). Le fichier <em>/etc/krb5.keytab</em> possède déjà l&#039; iUPN (&lt;HOSTNAME$&gt;@&lt;REALM&gt;) mais le démon <em>rpc.gssd</em> recherche l&#039;UPN &lt;FQDN$&gt;@&lt;REALM&gt;. Il faut donc ajouter l&#039; eUPN équivalent à l&#039;objet représentant la machine cliente dans l&#039;Active Directory. Ceci consiste à ajouter l&#039;attribut &#039;userPrincipalName&#039; avec la valeur &lt;FQDN$&gt;@&lt;REALM&gt;. Il y a une multitude de façon de procéder :
</p>
<ul class=" fix-media-list-overlap">
<li class="level1"><div class="li"> Utiliser une machine Windows dans le domaine avec les outils d&#039;administrations pour Active Directory.</div>
</li>
<li class="level1"><div class="li"> Utiliser un logiciel avec une interface graphique proche de ce que Windows propose, par exemple Apache Directory Studio, qui n&#039;est pas inclus dans la distribution Ubuntu.</div>
</li>
<li class="level1"><div class="li"> Utiliser les outils <abbr title="Lightweight Directory Access Protocol">LDAP</abbr></div>
</li>
</ul>
<pre class="code">ldapmodify -H ldap://ubndc01.example.com -U Administrator &lt;&lt; EOF
dn: cn=ubnws01,cn=computers,dc=example,dc=com
changetype: modify
add: userPrincipalName
userPrincipalName: UBNWS01.EXAMPLE.COM\$@EXAMPLE.COM
EOF</pre>

<p>
Cette méthode ne modifie pas les identités existantes de la machine. On peut alors ajouter la nouvelle identité (eUPN) au fichier keytab avec la commande
</p>
<pre class="code">sudo net ads keytab add UBNWS01.EXAMPLE.COM\$ -U Administrator</pre>
<ul class=" fix-media-list-overlap">
<li class="level1"><div class="li"> Utiliser la commande <em>net ads join</em> qui sert à joindre la machine au domaine.</div>
</li>
</ul>
<pre class="code">sudo net ads join createupn=UBNWS01.EXAMPLE.COM\$@EXAMPLE.COM -U Administrator</pre>
<div class="noteimportant">Ceci va créer de nouvelles versions des identités liées à la machines (iUPN, eUPN et 2 SPN host/…). Ses nouvelles identités sont ajoutées au fichier <em>/etc/krb5.keytab</em> mais les anciennes ne sont pas automatiquement supprimées. On peut faire le ménage avec les commandes mais ceci risque d’interrompre les processus qui utilisaient les anciennes identités.
<pre class="code">sudo net ads keytab flush -U Administrator
sudo net ads keytab create -U Administrator</pre>

</div>
</div>

<h4 id="eureka">Eureka</h4>
<div class="level4">

<p>
Après avoir résolu ces quelques problèmes, il est possible de monter le partage <abbr title="Network File System">NFS</abbr> et d&#039;y accèder.
</p>

</div>
<div class='secedit editbutton_section editbutton_15'><form class="button btn_secedit form-inline" method="post" action="/tutoriel/samba_ad_dc_nfs4_kerberized"><div class="no"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="1511282133" /><input type="hidden" name="summary" value="[Erreurs et solutions] " /><input type="hidden" name="target" value="section" /><input type="hidden" name="hid" value="erreurs_et_solutions" /><input type="hidden" name="codeblockOffset" value="11" /><input type="hidden" name="range" value="10641-17260" /><button type="submit" title="Erreurs et solutions" class=" btn btn-default btn btn-xs btn-default">Modifier</button></div></form></div>
<h3 class="sectionedit16" id="automatisation">Automatisation</h3>
<div class="level3">

<p>
Deux approches sont possibles pour l&#039;automatisation du montage des partages <abbr title="Network File System">NFS</abbr>.
</p>
<ul class=" fix-media-list-overlap">
<li class="level1"><div class="li"> Ajouter une ligne dans le fichier <em>/etc/fstab</em></div>
</li>
<li class="level1"><div class="li"> Utiliser <em><a href="/autofs" class="wikilink1" title="autofs">autofs</a></em></div>
</li>
</ul>

<p>
La première possibilité implique que la machine doit avoir une connectivité réseau avant de procéder au montage. C&#039;est typiquement le cas des serveurs mais pas des machines de bureau (fixes ou portables). De plus, il y a la problématique de la gestion des ressources. En effet, chaque partage monté consomme des ressources sur la machine cliente mais surtout sur la machine serveur. La seconde possibilité apporte donc une solution à ces deux problèmes.
</p>

</div>

<h4 id="mise_en_oeuvre_avecetcfstab">Mise en oeuvre avec /etc/fstab</h4>
<div class="level4">
<dl class="file">
<dt><a href="/_export/code/tutoriel/samba_ad_dc_nfs4_kerberized?codeblock=23" title="Télécharger cet extrait" class="mediafile mf_">/etc/fstab</a></dt>
<dd><pre class="file">ubnfs01:/home/example        /home/example        nfs4        sec=krb5        0        0</pre>
</dd></dl>

</div>

<h4 id="mise_en_oeuvre_sur_base_de_autofs">Mise en oeuvre sur base de autofs</h4>
<div class="level4">

<p>
Installation du paquet <strong><a href="apt://autofs" class="interwiki iw_apt" title="apt://autofs">autofs</a></strong>
</p>
<pre class="code">sudo apt-get install autofs</pre>

<p>
Ajout d&#039;une entrée dans le fichier maître <em>/etc/auto.master</em>
</p>
<dl class="file">
<dt><a href="/_export/code/tutoriel/samba_ad_dc_nfs4_kerberized?codeblock=25" title="Télécharger cet extrait" class="mediafile mf_master">/etc/auto.master</a></dt>
<dd><pre class="file">/home/example        /etc/auto.home        --timeout=90</pre>
</dd></dl>

<p>
Définition de la règle <em>auto.home</em>
</p>
<dl class="file">
<dt><a href="/_export/code/tutoriel/samba_ad_dc_nfs4_kerberized?codeblock=26" title="Télécharger cet extrait" class="mediafile mf_home">/etc/auto.home</a></dt>
<dd><pre class="file">*        -fstype=nfs4,sec=krb5 ubnfs01.example.com:/home/example/&amp;</pre>
</dd></dl>

</div>
<div class='secedit editbutton_section editbutton_16'><form class="button btn_secedit form-inline" method="post" action="/tutoriel/samba_ad_dc_nfs4_kerberized"><div class="no"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="1511282133" /><input type="hidden" name="summary" value="[Automatisation] " /><input type="hidden" name="target" value="section" /><input type="hidden" name="hid" value="automatisation" /><input type="hidden" name="codeblockOffset" value="23" /><input type="hidden" name="range" value="17261-18487" /><button type="submit" title="Automatisation" class=" btn btn-default btn btn-xs btn-default">Modifier</button></div></form></div>
<h2 class="sectionedit17 page-header" id="en_resume">En résumé</h2>
<div class="level2">

</div>
<div class='secedit editbutton_section editbutton_17'><form class="button btn_secedit form-inline" method="post" action="/tutoriel/samba_ad_dc_nfs4_kerberized"><div class="no"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="1511282133" /><input type="hidden" name="summary" value="[En résumé] " /><input type="hidden" name="target" value="section" /><input type="hidden" name="hid" value="en_resume" /><input type="hidden" name="codeblockOffset" value="27" /><input type="hidden" name="range" value="18488-18511" /><button type="submit" title="En résumé" class=" btn btn-default btn btn-xs btn-default">Modifier</button></div></form></div>
<h3 class="sectionedit18" id="sur_le_serveur_dns">Sur le serveur DNS</h3>
<div class="level3">
<div class="noteimportant">Les lignes de codes de ce paragraphe s&#039;appliquent uniquement au serveur <abbr title="Domain Name System">DNS</abbr> interne de Samba. Pour réaliser ces opérations sur tout autre serveur <abbr title="Domain Name System">DNS</abbr>, il faut se référer à la documentation du serveur <abbr title="Domain Name System">DNS</abbr>
</div>
<p>
Créer une zone <abbr title="Domain Name System">DNS</abbr> inversé
</p>
<pre class="code">samba-tool dns zonecreate ubndc01 2.0.192.in-addr.arpa
Zone 2.0.192.in-addr.arpa created successfully</pre>

<p>
Ajouter un pointeur vers le serveur de fichier
</p>
<pre class="code">samba-tool add ubndc01 2.0.192.in-addr.arpa 12 PTR ubnfs01.example.com
Record added successfully</pre>

<p>
Redémarrer le contrôleur de domaine pour pallier au <a href="https://bugzilla.samba.org/show_bug.cgi?id=9404" class="urlextern" title="https://bugzilla.samba.org/show_bug.cgi?id=9404" rel="nofollow">Bug 9404</a>
</p>
<pre class="code">ssh ubndc01
sudo service samba-ad-dc restart
exit</pre>

</div>
<div class='secedit editbutton_section editbutton_18'><form class="button btn_secedit form-inline" method="post" action="/tutoriel/samba_ad_dc_nfs4_kerberized"><div class="no"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="1511282133" /><input type="hidden" name="summary" value="[Sur le serveur DNS] " /><input type="hidden" name="target" value="section" /><input type="hidden" name="hid" value="sur_le_serveur_dns" /><input type="hidden" name="codeblockOffset" value="27" /><input type="hidden" name="range" value="18512-19251" /><button type="submit" title="Sur le serveur DNS" class=" btn btn-default btn btn-xs btn-default">Modifier</button></div></form></div>
<h3 class="sectionedit19" id="sur_le_serveur_de_fichier">Sur le serveur de fichier</h3>
<div class="level3">

<p>
Installation du paquets <abbr title="Network File System">NFS</abbr> server
</p>
<pre class="code">sudo apt-get install nfs-kernel-server</pre>

<p>
Création de la structure de répertoire pour <abbr title="Network File System">NFS</abbr>
</p>
<pre class="code">sudo mkdir -p /export/home/example</pre>

<p>
Jonction du répertoire réel avec la structure <abbr title="Network File System">NFS</abbr>
</p>
<dl class="file">
<dt><a href="/_export/code/tutoriel/samba_ad_dc_nfs4_kerberized?codeblock=32" title="Télécharger cet extrait" class="mediafile mf_">/etc/fstab</a></dt>
<dd><pre class="file"># Export NFS4
/home/example           /export/home/example        none       bind          0       0</pre>
</dd></dl>
<pre class="code">sudo mount /export/home/example</pre>

<p>
Ajout du SPN dans le <em>keytab</em>
</p>
<pre class="code">sudo net ads keytab add nfs -U Administrator</pre>

<p>
Lancement du service
</p>
<pre class="code">sudo service nfs-kernel-server start</pre>

</div>
<div class='secedit editbutton_section editbutton_19'><form class="button btn_secedit form-inline" method="post" action="/tutoriel/samba_ad_dc_nfs4_kerberized"><div class="no"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="1511282133" /><input type="hidden" name="summary" value="[Sur le serveur de fichier] " /><input type="hidden" name="target" value="section" /><input type="hidden" name="hid" value="sur_le_serveur_de_fichier" /><input type="hidden" name="codeblockOffset" value="30" /><input type="hidden" name="range" value="19252-19859" /><button type="submit" title="Sur le serveur de fichier" class=" btn btn-default btn btn-xs btn-default">Modifier</button></div></form></div>
<h3 class="sectionedit20" id="sur_les_clients_nfs">Sur les clients NFS</h3>
<div class="level3">

<p>
Installation du paquet <abbr title="Network File System">NFS</abbr> client
</p>
<pre class="code">sudo apt-get install nfs-common</pre>

<p>
S&#039;il n&#039;est pas déjà définit dans l&#039;Active Directory, définir l&#039;eUPN de l&#039;ordinateur
</p>
<pre class="code">ldapmodify -H ldap://ubndc01.example.com -U Administrator &lt;&lt; EOF
dn: cn=ubnws01,cn=computers,dc=example,dc=com
changetype: modify
add: userPrincipalName
userPrincipalName: UBNWS01.EXAMPLE.COM\$@EXAMPLE.COM
EOF</pre>

<p>
S&#039;il n&#039;est pas déjà présent dans le fichier <em>/etc/krb5.keytab</em>, ajouter l&#039;eUPN au fichier
</p>
<pre class="code">sudo net ads keytab add UBNWS01.EXAMPLE.COM\$ -U Administrator</pre>

<p>
Monter la ressource partagée manuellement
</p>
<pre class="code">sudo mount -t nfs4 -o sec=krb5 ubnfs01.example.com:/home/example /home/example</pre>

<p>
<em class="u">Ou</em> automatiquement (cfr <a href="/utilisateurs/qedinux/samba_ad_dc_nfs4_kerberized?do=#automatisation" class="wikilink1" title="utilisateurs:qedinux:samba_ad_dc_nfs4_kerberized">Automatisation</a>)
</p>

</div>
<div class='secedit editbutton_section editbutton_20'><form class="button btn_secedit form-inline" method="post" action="/tutoriel/samba_ad_dc_nfs4_kerberized"><div class="no"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="1511282133" /><input type="hidden" name="summary" value="[Sur les clients NFS] " /><input type="hidden" name="target" value="section" /><input type="hidden" name="hid" value="sur_les_clients_nfs" /><input type="hidden" name="codeblockOffset" value="36" /><input type="hidden" name="range" value="19860-20702" /><button type="submit" title="Sur les clients NFS" class=" btn btn-default btn btn-xs btn-default">Modifier</button></div></form></div>
<h2 class="sectionedit21 page-header" id="references">Références</h2>
<div class="level2">
<ul class=" fix-media-list-overlap">
<li class="level1"><div class="li"> <a href="https://wiki.debian.org/NFS/Kerberos" class="urlextern" title="https://wiki.debian.org/NFS/Kerberos" rel="nofollow">NFSv4 (nfs4) + Kerberos in Debian</a></div>
</li>
</ul>

<p>
<em>Contributeur principal : <a href="/utilisateurs/qedinux" class="wikilink1" title="utilisateurs:qedinux">Qedinux</a></em>
</p>

</div>
<div class='secedit editbutton_section editbutton_21'><form class="button btn_secedit form-inline" method="post" action="/tutoriel/samba_ad_dc_nfs4_kerberized"><div class="no"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="1511282133" /><input type="hidden" name="summary" value="[Références] " /><input type="hidden" name="target" value="section" /><input type="hidden" name="hid" value="references" /><input type="hidden" name="codeblockOffset" value="40" /><input type="hidden" name="range" value="20703-" /><button type="submit" title="Références" class=" btn btn-default btn btn-xs btn-default">Modifier</button></div></form></div><hr/><div class="footnotes">
<div class="fn"><sup><a href="#fnt__1" id="fn__1" class="fn_bot">1)</a></sup> 
<div class="content">Conformément aux <a href="https://tools.ietf.org/html/rfc2606" class="urlextern" title="https://tools.ietf.org/html/rfc2606" rel="nofollow">RFC 2606</a> (Reserved Top Level <abbr title="Domain Name System">DNS</abbr> Names) et <a href="https://tools.ietf.org/html/rfc5737" class="urlextern" title="https://tools.ietf.org/html/rfc5737" rel="nofollow">RFC 5737</a> (IPv4 Address Blocks Reserved for Documentation) </div></div>
</div>

</div><!-- /CONTENT --></div>
          </div>
        </div>

        <div class="small text-right">

                    <span class="docInfo">
            <ul class="list-inline"><li><i class="fa fa-fw fa-file-text-o text-muted"></i> <span title="tutoriel/samba_ad_dc_nfs4_kerberized.txt">tutoriel/samba_ad_dc_nfs4_kerberized.txt</span></li><li><i class="fa fa-fw fa-calendar text-muted"></i> Dernière modification: <span title="Le 21/11/2017, 17:35">Le 21/11/2017, 17:35</span></li><li class="text-muted">par fabux</li></ul>          </span>
          
          
        </div>

      </article>

      
    </main>

    <footer id="dw__footer" class="navbar navbar-default">
  <div class="container">

    <div class="small navbar-text">

            <div class="footer-dw-title row">
        <div class="media col-sm-4">
          <!--<div class="media-left">
            <img src="/_media/logo.png" alt="Wiki ubuntu-fr" class="media-object" style="width:32px" />
          </div> -->
          <div class="media-body">
            <h4 class="media-heading">Documentation ubuntu-fr</h4>
            <p>
              Les pages de cette documentation sont rédigées par les utilisateurs
              pour les utilisateurs. Apportez-nous votre aide pour améliorer
              le contenu de cette documentation.
            </p>
          </div>
        </div>
        <div class="col-sm-4">
          <h4>Liens utiles</h4>
          <ul class="list-group list-unstyled">
            <li>
              <a href="/debutant" ><i class="fa fa-fw fa-child" style="font-size: 1.3em;"></i> Débuter sur Ubuntu</a>            </li>
            <li>
              <a href="/wiki/participer_wiki" ><i class="fa fa-fw fa-edit" style="font-size: 1.3em;"></i> Participer à la documentation</a>            </li>
            <li>
              <a href="/documentation_hors_ligne" ><i class="fa fa-fw fa-book" style="font-size: 1.3em;"></i> Documentation hors ligne</a>            </li>
            <li>
              <a href="//www.ubuntu-fr.org/telechargement" ><i class="fa fa-fw fa-arrow-circle-down" style="font-size: 1.3em;"></i> Télécharger Ubuntu</a>            </li>
          </ul>
        </div>
        <div class="col-sm-4">
          <h4>Obtenir de l'aide</h4>
          <ul class="list-group list-unstyled">
            <li>
              <a href="/tutoriel/comment_obtenir_une_reponse_satisfaisante" ><i class="fa fa-fw fa-info-circle" style="font-size: 1.3em;"></i> Chercher de l'aide</a>            </li>
            <li>
              <a href="//doc.ubuntu-fr.org/" ><i class="fa fa-fw fa-book" style="font-size: 1.3em;"></i> Consulter la documentation</a>            </li>
            <li>
              <a href="//forum.ubuntu-fr.org/" ><i class="fa fa-fw fa-comments" style="font-size: 1.3em;"></i> Consulter le Forum</a>            </li>
            <li>
              <a href="//guide.ubuntu-fr.org/" ><i class="fa fa-fw fa-question-circle" style="font-size: 1.3em;"></i> Lisez le guide</a>            </li>
          </ul>
        </div>
        <p>&nbsp;</p>
      </div>
      
      
      <div class="footer-license row">

        <div class="col-sm-6">
                    <p>
            <a href="http://creativecommons.org/licenses/by-sa/3.0/deed.fr" title="CC Paternité-Partage des Conditions Initiales à l'Identique 3.0 Unported" target="" itemscope itemtype="http://schema.org/CreativeWork" itemprop="license" rel="license" class="license"><img src="/lib/tpl/bootstrap3/images/license/cc.png" width="24" height="24" alt="cc" /> <img src="/lib/tpl/bootstrap3/images/license/by.png" width="24" height="24" alt="by" /> <img src="/lib/tpl/bootstrap3/images/license/sa.png" width="24" height="24" alt="sa" /> </a>          </p>
          <p class="small">
            Sauf mention contraire, le contenu de ce wiki est placé sous les termes de la licence suivante :<br/><a href="http://creativecommons.org/licenses/by-sa/3.0/deed.fr" title="CC Paternité-Partage des Conditions Initiales à l'Identique 3.0 Unported" target="" itemscope itemtype="http://schema.org/CreativeWork" itemprop="license" rel="license" class="license">CC Paternité-Partage des Conditions Initiales à l'Identique 3.0 Unported</a>          </p>
                  </div>

        <div class="col-sm-6">
                    <ul id="dw__badges" class="list-inline text-right hidden-print">

  <li>
    <a href="https://www.dokuwiki.org/template:bootstrap3" title="Bootstrap template for DokuWiki" target="">
      <img src="/lib/tpl/bootstrap3/images/bootstrap.png" width="20" alt="Bootstrap template for DokuWiki" />
    </a>
  </li>

  <li>
    <a href="https://www.php.net" title="Powered by PHP" target="">
      <img src="/lib/tpl/bootstrap3/images/php.png" width="20" alt="Powered by PHP" />
    </a>
  </li>

  <li>
    <a href="http://validator.w3.org/check/referer" title="Valid HTML5" target="">
      <img src="/lib/tpl/bootstrap3/images/html5.png" width="20" alt="Valid HTML5" />
    </a>
  </li>

  <li>
    <a href="http://jigsaw.w3.org/css-validator/check/referer?profile=css3" title="Valid CSS" target="">
      <img src="/lib/tpl/bootstrap3/images/css3.png" width="20" alt="Valid CSS" />
    </a>
  </li>

  <li>
    <a href="https://www.dokuwiki.org/" title="Driven by DokuWiki" target="">
      <img src="/lib/tpl/bootstrap3/images/logo.png" width="20" alt="Driven by DokuWiki" />
    </a>
  </li>

</ul>
                  </div>

      </div>

    </div>

  </div>
</footer>
<img src="/lib/exe/indexer.php?id=tutoriel%3Asamba_ad_dc_nfs4_kerberized&amp;1635532668" width="2" height="1" alt="" />
    <a href="#dokuwiki__top" class="back-to-top hidden-print btn btn-default btn-sm" title="Aller au contenu" accesskey="t"><i class="fa fa-chevron-up"></i></a>

    <div id="screen__mode">      <span class="visible-xs-block"></span>
      <span class="visible-sm-block"></span>
      <span class="visible-md-block"></span>
      <span class="visible-lg-block"></span>
    </div>

  </div>

    <!-- Piwik -->
		<script type="text/javascript">
		  var _paq = _paq || [];
		  _paq.push(["setDomains", ["*.doc.ubuntu-fr.org","*.doc.edubuntu-fr.org","*.doc.lubuntu-fr.org","*.doc.xubuntu-fr.org","*.doc.edubuntu-fr.org","*.doc.lubuntu-fr.org","*.doc.ubuntu-fr.org","*.doc.xubuntu-fr.org"]]);
		  _paq.push(['trackPageView']);
		  _paq.push(['enableLinkTracking']);
		  (function() {
		    var u="//piwik.ubuntu-fr.org/";
		    _paq.push(['setTrackerUrl', u+'piwik.php']);
		    _paq.push(['setSiteId', 3]);
		    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
		    g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'piwik.js'; s.parentNode.insertBefore(g,s);
		  })();
		</script>
		<noscript><p><img src="//piwik.ubuntu-fr.org/piwik.php?idsite=3" style="border:0;" alt="" /></p></noscript>
		<!-- End Piwik Code -->

</body>
</html>
